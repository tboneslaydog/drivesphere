<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DriveSphere - Social GPS Tracking & Route Sharing</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="DriveSphere - The ultimate social GPS tracking app. Share routes, track drives, earn XP, and connect with friends. Real-time location sharing and advanced analytics.">
    <meta name="keywords" content="GPS tracking, route sharing, social driving, location sharing, drive analytics, friends, XP system, mobile app">
    <meta name="author" content="DriveSphere">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://drivesphere.org">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="DriveSphere - Social GPS Tracking & Route Sharing">
    <meta property="og:description" content="The ultimate social GPS tracking app. Share routes, track drives, earn XP, and connect with friends.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://drivesphere.org">
    <meta property="og:site_name" content="DriveSphere">
    <meta property="og:image" content="https://drivesphere.org/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="DriveSphere - Social GPS Tracking App">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="DriveSphere - Social GPS Tracking & Route Sharing">
    <meta name="twitter:description" content="The ultimate social GPS tracking app. Share routes, track drives, earn XP, and connect with friends.">
    <meta name="twitter:image" content="https://drivesphere.org/og-image.png">
    <meta name="twitter:image:alt" content="DriveSphere - Social GPS Tracking App">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#00bfff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DriveSphere">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#00bfff">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMWUyOTNiIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0OCIgZmlsbD0iIzNiODJmNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkQ8L3RleHQ+PC9zdmc+">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzBhMWIyZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiMwMGJmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5EPC90ZXh0Pjwvc3ZnPg==">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID', {
            'custom_map': {'custom_parameter_1': 'user_level', 'custom_parameter_2': 'total_distance'},
            'send_page_view': true
        });
    </script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 191, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 123, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 191, 255, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #0a0a0a 100%);
            color: #00bfff;
            min-height: 100vh;
            line-height: 1.5;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255, 255, 255, 0.1), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255, 255, 255, 0.05), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255, 255, 255, 0.1), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255, 255, 255, 0.05), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(255, 255, 255, 0.1), transparent);
            background-repeat: repeat;
            background-size: 200px 200px;
            animation: sparkle 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes sparkle {
            0% { transform: translateY(0px) translateX(0px); }
            100% { transform: translateY(-200px) translateX(-200px); }
        }

        /* Navigation */
        .navbar {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(26, 26, 46, 0.9) 50%, rgba(22, 33, 62, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid #00bfff;
            padding: 0.75rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 
                0 8px 32px rgba(0, 191, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .navbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.5), transparent);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(45deg, #00bfff, #007bff, #00bfff);
            background-size: 200% 200%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.025em;
            position: relative;
            transition: all 0.3s ease;
            animation: gradientShift 4s ease-in-out infinite;
            text-shadow: 0 0 15px rgba(0, 191, 255, 0.4);
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }

        .logo:hover::after {
            width: 100%;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
        }

        .nav-link {
            color: #00bfff;
            text-decoration: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.1), rgba(0, 123, 255, 0.1));
            border: 1px solid rgba(0, 191, 255, 0.3);
            box-shadow: 0 0 8px rgba(0, 191, 255, 0.15);
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link:hover {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.25), rgba(0, 123, 255, 0.25));
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(0, 191, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.3), rgba(0, 123, 255, 0.3));
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.4);
            border-color: #00bfff;
        }

        /* Main Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .page {
            margin-top: 1rem;
            animation: fadeInUp 0.6s ease-out;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        
        .page.hidden {
            display: none !important;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Pulse animation for active elements */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Floating elements removed */

        /* Scroll reveal animation */
        .reveal {
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.6s ease;
        }

        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Glow effects */
        .glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .glow-green {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .glow-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
        }

        /* G-Force Display Styles */
        .gforce-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .gforce-main {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .gforce-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }

        .gforce-label {
            font-size: 1rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .gforce-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .gforce-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 0.75rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .gforce-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        .gforce-stat-label {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .gforce-chart {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .gforce-chart canvas {
            width: 100%;
            height: 100px;
            border-radius: 0.5rem;
        }

        .gforce-axes {
            display: flex;
            justify-content: space-around;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.2);
            border-radius: 0.75rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .gforce-axis span {
            display: block;
            text-align: center;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .gforce-axis span:first-child {
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        /* Event Notifications */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes neonPulse {
            0% { box-shadow: 0 0 5px rgba(0, 191, 255, 0.4); }
            50% { box-shadow: 0 0 15px rgba(0, 191, 255, 0.6), 0 0 25px rgba(0, 123, 255, 0.4); }
            100% { box-shadow: 0 0 5px rgba(0, 191, 255, 0.4); }
        }

        @keyframes techGlow {
            0% { text-shadow: 0 0 4px rgba(0, 191, 255, 0.4); }
            50% { text-shadow: 0 0 12px rgba(0, 191, 255, 0.6), 0 0 20px rgba(0, 123, 255, 0.4); }
            100% { text-shadow: 0 0 4px rgba(0, 191, 255, 0.4); }
        }

        /* Mobile G-Force Styles */
        @media (max-width: 480px) {
            .gforce-value {
                font-size: 2.5rem;
            }
            
            .gforce-stats {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .gforce-stat {
                padding: 0.75rem;
            }
            
            .gforce-axes {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .gforce-axis {
                display: flex;
                justify-content: space-between;
            }
        }

        /* XP System Styles */
        .xp-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 2px solid rgba(59, 130, 246, 0.3);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .help-btn {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            color: #3b82f6;
        }
        
        .help-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            transform: scale(1.1);
        }

        .xp-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .level-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .level-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            position: relative;
        }

        .level-circle::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #3b82f6);
            border-radius: 50%;
            z-index: -1;
            animation: levelGlow 2s ease-in-out infinite alternate;
        }

        .level-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
        }

        .level-info {
            flex: 1;
        }

        .level-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        .next-level {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .xp-progress {
            padding: 1rem;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .xp-bar-container {
            position: relative;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 1rem;
            height: 2rem;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669, #047857);
            border-radius: 1rem;
            transition: width 0.8s ease;
            position: relative;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .xp-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 1rem 1rem 0 0;
        }

        .xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
        }

        .xp-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .xp-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 0.75rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }

        .xp-stat:hover {
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        .xp-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        .xp-stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-achievements h4 {
            margin: 0 0 1rem 0;
            color: #f59e0b;
            font-size: 1rem;
        }

        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* XP Animations */
        @keyframes levelGlow {
            from {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            }
            to {
                box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
            }
        }

        @keyframes xpGainSlide {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            10% {
                transform: translateX(0);
                opacity: 1;
            }
            90% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes achievementSlide {
            0% {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            15% {
                transform: translateX(0) scale(1.05);
                opacity: 1;
            }
            20% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
            85% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes levelUpBounce {
            0% {
                transform: scale(0.3) rotate(-5deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(2deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Mobile XP Styles */
        @media (max-width: 480px) {
            .level-display {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }
            
            .level-circle {
                width: 60px;
                height: 60px;
            }
            
            .level-number {
                font-size: 1.5rem;
            }
            
            .xp-stats {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .xp-stat {
                padding: 0.75rem;
            }
            
            .xp-stat-value {
                font-size: 1.25rem;
            }
        }

        /* Authentication Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 2rem;
        }

        .auth-page {
            display: none;
            max-width: 400px;
            width: 100%;
        }

        .auth-page.active {
            display: block;
        }

        .auth-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .auth-header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #f1f5f9;
        }

        .form-group input {
            padding: 0.875rem 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 0.75rem;
            color: #f1f5f9;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input::placeholder {
            color: #64748b;
        }

        .form-group small {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .auth-btn {
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .auth-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .admin-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .admin-btn:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .auth-divider {
            text-align: center;
            position: relative;
            margin: 1rem 0;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(148, 163, 184, 0.2);
        }

        .auth-divider span {
            background: rgba(30, 41, 59, 0.8);
            padding: 0 1rem;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .auth-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }

        .auth-footer p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .auth-footer a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-footer a:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        /* User Menu */
        .user-menu {
            position: relative;
            cursor: pointer;
        }

        .user-menu:hover .user-dropdown {
            display: block;
        }

        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.75rem;
            padding: 0.5rem 0;
            min-width: 150px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .user-dropdown a {
            display: block;
            padding: 0.75rem 1rem;
            color: #f1f5f9;
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .user-dropdown a:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        /* Profile Styles */
        .profile-info {
            margin-bottom: 2rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .profile-details h2 {
            margin: 0 0 0.5rem 0;
            color: #f1f5f9;
            font-size: 1.5rem;
        }

        .profile-details p {
            margin: 0 0 0.5rem 0;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .role-badge.admin {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        /* Admin Panel Styles */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        .admin-overview .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        
        .user-controls {
            margin-bottom: 1rem;
        }
        
        .user-filters {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .user-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .action-group {
            margin-bottom: 1.5rem;
        }
        
        .action-group h4 {
            color: #475569;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(203, 213, 225, 0.2);
        }
        
        .status-row:last-child {
            border-bottom: none;
        }
        
        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .monitor-item {
            background: rgba(248, 250, 252, 0.5);
            border: 1px solid rgba(203, 213, 225, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        
        .monitor-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .monitor-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .monitor-bar {
            width: 100%;
            height: 8px;
            background: rgba(203, 213, 225, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .monitor-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .info-section h4 {
            color: #1e293b;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(203, 213, 225, 0.3);
        }
        
        .info-section p {
            margin: 0.5rem 0;
            font-size: 0.875rem;
            color: #475569;
        }
        
        .security-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .security-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .log-preview {
            background: rgba(248, 250, 252, 0.5);
            border: 1px solid rgba(203, 213, 225, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-preview h4 {
            color: #1e293b;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .log-entries {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #475569;
        }
        
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(203, 213, 225, 0.2);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
        }
        
        .setting-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #475569;
            cursor: pointer;
        }
        
        .setting-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .setting-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Friends System Styles */
        .friends-section {
            margin-top: 1rem;
        }

        .search-friends {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 191, 255, 0.2);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            background: rgba(0, 191, 255, 0.1);
            border-color: rgba(0, 191, 255, 0.4);
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bfff, #007bff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }

        .friend-details h4 {
            margin: 0;
            color: #00bfff;
            font-size: 1rem;
        }

        .friend-details p {
            margin: 0;
            color: #64748b;
            font-size: 0.875rem;
        }

        .friend-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(0, 191, 255, 0.2);
            color: #00bfff;
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        .my-posts {
            margin-top: 1rem;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .backup-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .backup-status {
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .backup-status p {
            margin: 0.5rem 0;
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        .backup-status strong {
            color: #f1f5f9;
        }
        
        .desktop-gforce-message {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .desktop-message-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }
        
        .desktop-message-content h4 {
            color: #f1f5f9;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .desktop-message-content p {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }
        
        .desktop-feature-preview {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .preview-stat {
            text-align: center;
        }
        
        .preview-value {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }
        
        .preview-label {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 500;
        }
        
        /* Live Tracking Styles */
        .live-sharing-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .live-sharing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .live-sharing-header h4 {
            margin: 0;
            color: #f1f5f9;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .live-status {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .live-status.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .live-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .live-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .live-btn.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }
        
        .live-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .live-btn:hover::before {
            left: 100%;
        }
        
        .live-info {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .live-info p {
            margin: 0.5rem 0;
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        .live-info strong {
            color: #f1f5f9;
        }
        
        .live-friends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .live-stats {
            display: flex;
            gap: 2rem;
        }
        
        .live-stat {
            text-align: center;
        }
        
        .live-count {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .live-label {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 500;
        }
        
        .live-friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .live-friend-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .live-friend-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(30, 41, 59, 0.6);
        }
        
        .live-friend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .live-friend-name {
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .live-friend-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .live-friend-status.driving {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .live-friend-status.idle {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .live-friend-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .live-friend-stat {
            text-align: center;
        }
        
        .live-friend-value {
            font-size: 1rem;
            font-weight: 600;
            color: #3b82f6;
        }
        
        .live-friend-label {
            font-size: 0.7rem;
            color: #94a3b8;
        }
        
        .live-friend-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .live-map-container {
            position: relative;
        }
        
        .live-map {
            height: 400px;
            border-radius: 0.75rem;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
        }
        
        .live-map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        /* Username Validation Styles */
        .username-validation {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .username-validation.valid {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .username-validation.invalid {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .username-validation.checking {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .validation-message::before {
            margin-right: 0.5rem;
        }
        
        .username-validation.valid .validation-message::before {
            content: '✅';
        }
        
        .username-validation.invalid .validation-message::before {
            content: '❌';
        }
        
        .username-validation.checking .validation-message::before {
            content: '⏳';
        }
        
        /* Remember Me Checkbox Styles */
        .remember-me {
            margin: 1rem 0;
        }
        
        .remember-me-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #cbd5e1;
            user-select: none;
        }
        
        .remember-me-checkbox {
            display: none;
        }
        
        .checkmark {
            position: relative;
            width: 18px;
            height: 18px;
            margin-right: 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 4px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .remember-me-checkbox:checked + .checkmark {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .remember-me-checkbox:checked + .checkmark::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .remember-me-label:hover .checkmark {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .user-details h4 {
            margin: 0 0 0.25rem 0;
            color: #f1f5f9;
            font-size: 0.875rem;
        }

        .user-details p {
            margin: 0;
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .system-info {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .system-info p {
            margin: 0;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .system-info strong {
            color: #f1f5f9;
        }

        /* Mobile Auth Styles */
        @media (max-width: 480px) {
            .auth-container {
                padding: 1rem;
            }
            
            .auth-card {
                padding: 2rem 1.5rem;
            }
            
            .admin-actions {
                grid-template-columns: 1fr;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(26, 26, 46, 0.8) 50%, rgba(22, 33, 62, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(0, 191, 255, 0.3);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 
                0 8px 32px rgba(0, 191, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.5), transparent);
        }

        .card:hover {
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #00bfff;
            margin-bottom: 1rem;
            text-shadow: 0 0 8px rgba(0, 191, 255, 0.4);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Status Display */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .status-item {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 2px solid rgba(0, 191, 255, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.15);
        }

        .status-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .status-item:hover::before {
            transform: scaleX(1);
        }

        .status-item:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }

        .status-label {
            font-size: 0.75rem;
            color: #00bfff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
            text-shadow: 0 0 4px rgba(0, 191, 255, 0.4);
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        .status-unit {
            font-size: 0.875rem;
            color: #64748b;
            margin-left: 0.25rem;
        }

        /* Tracking Controls */
        .tracking-controls {
            text-align: center;
        }

        .track-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            border-radius: 1.25rem;
            color: white;
            font-size: 1.125rem;
            font-weight: 700;
            padding: 1.25rem 2.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.4);
            min-width: 180px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .track-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .track-button:hover::before {
            left: 100%;
        }

        .track-button:hover {
            box-shadow: 0 12px 30px 0 rgba(59, 130, 246, 0.6);
        }

        .track-button.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 6px 20px 0 rgba(239, 68, 68, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .tracking-info {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 0.75rem;
            color: #22c55e;
            font-weight: 500;
        }

        /* Map */
        .map-container {
            height: 300px;
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .map-controls .btn {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-controls .btn:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .map-controls .btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .route-overlay {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .route-overlay .btn {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .route-overlay .btn:hover {
            background: rgba(34, 197, 94, 0.2);
        }

        /* Route Comparison Modal */
        .route-comparison-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 2rem;
        }

        .route-comparison-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            width: 800px;
        }

        .route-comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .route-comparison-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .route-stats-comparison {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-comparison {
            text-align: center;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 0.5rem;
        }

        .stat-comparison.better {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .stat-comparison.worse {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* QR Code Modal */
        .qr-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 2rem;
        }

        .qr-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .qr-code {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            display: inline-block;
        }

        /* POI Markers */
        .poi-marker {
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .poi-popup {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #f1f5f9;
        }

        /* Routes */
        .routes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .route-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 1rem;
            padding: 1.25rem;
            transition: all 0.2s ease;
        }

        .route-card:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: translateY(-2px);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .route-name {
            font-weight: 600;
            color: #f1f5f9;
            font-size: 1.125rem;
        }

        .route-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .route-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .route-badge.private {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .route-stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.5rem;
        }

        .route-stat-value {
            font-weight: 600;
            color: #f1f5f9;
        }

        .route-stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .route-timestamp {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Buttons */
        .btn {
            border: 2px solid rgba(0, 191, 255, 0.4);
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.15), rgba(0, 123, 255, 0.15));
            color: #00bfff;
            padding: 0.875rem 1.75rem;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.2);
            text-shadow: 0 0 4px rgba(0, 191, 255, 0.4);
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.3), rgba(0, 123, 255, 0.3));
            box-shadow: 0 8px 25px rgba(0, 191, 255, 0.4);
            transform: translateY(-2px);
            color: #ffffff;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        .btn:active {
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 0.375rem;
            border-radius: 0.375rem;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #f1f5f9;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 0.5rem;
            color: #f1f5f9;
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .search-bar {
            margin-bottom: 1.5rem;
        }

        /* Route Tabs */
        .route-tab {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .route-tab:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .route-tab.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .route-tab-content {
            margin-top: 1rem;
        }

        /* Feed Styles */
        .create-post {
            margin-bottom: 1rem;
        }

        .upload-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .photo-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feed-post {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(26, 26, 46, 0.8) 100%);
            border: 2px solid rgba(0, 191, 255, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.15);
        }
        
        .route-post {
            border-left: 4px solid #00bfff;
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.15), rgba(0, 0, 0, 0.8));
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.2);
        }
        
        .live-post {
            border-left: 4px solid #007bff;
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.15), rgba(0, 0, 0, 0.8));
            animation: neonPulse 2s infinite;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.2);
        }
        
        .post-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: auto;
        }
        
        .route-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .live-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .route-info, .live-info {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .route-stats, .live-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .route-stat, .live-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #cbd5e1;
        }
        
        .stat-icon {
            font-size: 1.2rem;
        }
        
        .stat-value {
            font-weight: 600;
            color: #f1f5f9;
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
        }

        .post-delete-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .post-delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            opacity: 1;
            transform: scale(1.1);
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .post-info {
            flex-grow: 1;
        }

        .post-username {
            font-weight: 600;
            color: #00bfff;
            text-shadow: 0 0 4px rgba(0, 191, 255, 0.4);
        }

        .post-time {
            font-size: 0.875rem;
            color: #00bfff;
            text-shadow: 0 0 3px rgba(0, 191, 255, 0.3);
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #ffffff;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.3);
        }

        .post-photos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .post-photo {
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .post-photo:hover {
            transform: scale(1.02);
        }

        .post-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }

        .post-action {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .post-action:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .post-action.liked {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .post-action.liked:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        .like-animation {
            animation: heartBeat 0.6s ease-in-out;
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.2); }
            70% { transform: scale(1); }
        }

        /* Comments Section */
        .comments-section {
            margin-top: 1rem;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            padding-top: 1rem;
        }

        .comment-input-section {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .comment-input-wrapper {
            flex-grow: 1;
            display: flex;
            gap: 0.5rem;
        }

        .comment-input {
            flex-grow: 1;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            color: #f1f5f9;
            font-size: 0.875rem;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .comment-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .comment-submit {
            background: #3b82f6;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .comment-submit:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .comment-submit:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
        }

        .comment {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .comment-content {
            flex-grow: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .comment-username {
            font-weight: 600;
            color: #f1f5f9;
            font-size: 0.875rem;
        }

        .comment-time {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .comment-text {
            color: #e2e8f0;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .comments-toggle {
            color: #3b82f6;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .comments-toggle:hover {
            text-decoration: underline;
        }

        /* Photo Modal */
        .photo-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 2rem;
        }

        .photo-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 1rem;
        }

        .photo-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }

            .navbar {
                padding: 0.5rem 0.75rem;
            }

            .nav-links {
                gap: 0.25rem;
            }

            .nav-link {
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .status-grid {
                grid-template-columns: 1fr 1fr;
            }

            .route-stats {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.5rem;
            }

            .routes-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 1rem;
                border-radius: 0.75rem;
            }

            .map-container {
                height: 250px;
            }

            .track-button {
                padding: 0.875rem 1.5rem;
                font-size: 0.9rem;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        /* Enhanced Mobile Features */
        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }
            
            .card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 1rem;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .map-controls {
                gap: 0.5rem;
                margin-bottom: 1rem;
                flex-wrap: wrap;
            }
            
            .map-controls .btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
                border-radius: 0.75rem;
                min-height: 44px;
            }
            
            .route-overlay {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .route-overlay .btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
                border-radius: 0.75rem;
                min-height: 44px;
            }

            .track-button {
                padding: 1rem 2rem;
                font-size: 1rem;
                border-radius: 1rem;
                min-width: 160px;
            }

            .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
            }

            .logo {
                font-size: 1.125rem;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-link, .post-action {
                min-height: 44px;
                min-width: 44px;
            }
            
            .btn-sm {
                min-height: 36px;
                min-width: 36px;
            }
            
            .map-controls .btn,
            .route-overlay .btn {
                min-height: 40px;
                min-width: 40px;
            }
        }

        /* Swipe gestures support */
        .swipe-container {
            position: relative;
            overflow: hidden;
        }

        .swipe-content {
            transition: transform 0.3s ease;
        }

        .swipe-indicator {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
        }

        .swipe-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(148, 163, 184, 0.5);
            transition: background 0.3s ease;
        }

        .swipe-dot.active {
            background: #3b82f6;
        }

        /* Pull-to-refresh */
        .pull-to-refresh {
            position: relative;
            overflow: hidden;
        }

        .pull-indicator {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            font-size: 0.875rem;
            transition: top 0.3s ease;
        }

        .pull-indicator.show {
            top: 0;
        }

        /* Haptic feedback simulation */
        .haptic-light {
            animation: hapticLight 0.1s ease;
        }

        .haptic-medium {
            animation: hapticMedium 0.15s ease;
        }

        .haptic-heavy {
            animation: hapticHeavy 0.2s ease;
        }

        @keyframes hapticLight {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.98); }
        }

        @keyframes hapticMedium {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(0.96); }
            75% { transform: scale(1.02); }
        }

        @keyframes hapticHeavy {
            0%, 100% { transform: scale(1); }
            20% { transform: scale(0.94); }
            40% { transform: scale(1.04); }
            60% { transform: scale(0.96); }
            80% { transform: scale(1.02); }
        }

        /* Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .analytics-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }

        .analytics-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }

        .analytics-label {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .analytics-change {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .analytics-change.positive {
            color: #22c55e;
        }

        .analytics-change.negative {
            color: #ef4444;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .insight-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .insight-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .insight-content h4 {
            color: #f1f5f9;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .insight-content p {
            color: #e2e8f0;
            margin-bottom: 0.75rem;
        }

        .insight-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .insight-stats .stat {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .speed-chart-container {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .speed-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .speed-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.5rem;
        }

        .speed-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        .speed-label {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .achievement {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .achievement.earned {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .achievement.locked {
            opacity: 0.6;
        }

        .achievement-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .achievement-content h4 {
            color: #f1f5f9;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .achievement-content p {
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }

        .achievement-date {
            font-size: 0.75rem;
            color: #22c55e;
        }

        .achievement-progress {
            font-size: 0.75rem;
            color: #f59e0b;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .leaderboard-tab {
            padding: 0.5rem 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.5rem;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .leaderboard-tab.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .leaderboard-item.current-user {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
        }

        .rank {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
            min-width: 2rem;
            text-align: center;
        }

        .player-info {
            flex-grow: 1;
        }

        .player-name {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .player-stats {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .player-score {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .status-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .route-stats {
                grid-template-columns: 1fr;
            }

            .nav-link {
                padding: 0.375rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar" id="mainNavbar" style="display: none;">
        <div class="nav-container">
            <div class="logo" onclick="showPage('dashboard')" style="cursor: pointer;">DriveSphere</div>
            <div class="nav-links">
                <a href="#" class="nav-link active" onclick="showPage('dashboard')">Dashboard</a>
                <a href="#" class="nav-link" onclick="showPage('routes')">Routes</a>
                <a href="#" class="nav-link" onclick="showPage('analytics')">Analytics</a>
                <a href="#" class="nav-link" onclick="showPage('feed')">Feed</a>
                <a href="#" class="nav-link" onclick="showPage('profile')">Profile</a>
                <div class="user-menu">
                    <span id="userDisplayName">User</span>
                    <div class="user-dropdown">
                        <a href="#" onclick="showProfile()">👤 Profile</a>
                        <a href="#" onclick="showAdminPanel()" id="adminLink" style="display: none;">⚙️ Admin</a>
                        <a href="#" onclick="logout()">🚪 Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Authentication Pages -->
    <div id="authContainer" class="auth-container">
        <!-- Login Page -->
        <div id="loginPage" class="auth-page active">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>🚗 DriveSphere</h1>
                    <p>Welcome back! Sign in to continue your driving journey.</p>
                </div>
                
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email or Username</label>
                        <input type="text" id="loginEmail" required placeholder="Enter your email or username">
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    
                    <div class="form-group remember-me">
                        <label class="remember-me-label">
                            <input type="checkbox" id="rememberMe" class="remember-me-checkbox">
                            <span class="checkmark"></span>
                            Remember me
                        </label>
                    </div>
                    
                    <button type="submit" class="auth-btn">Sign In</button>
                    
                    <div class="auth-divider">
                        <span>or</span>
                    </div>
                    
                    <button type="button" onclick="adminLogin()" class="admin-btn">Admin Login</button>
                </form>
                
                <div class="auth-footer">
                    <p>Don't have an account? <a href="#" onclick="switchToRegister()">Sign up here</a></p>
                </div>
            </div>
        </div>
        
        <!-- Register Page -->
        <div id="registerPage" class="auth-page">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>🚗 Join DriveSphere</h1>
                    <p>Create your account and start tracking your drives!</p>
                </div>
                
                <form id="registerForm" class="auth-form">
                    <div class="form-group">
                        <label for="registerName">Full Name</label>
                        <input type="text" id="registerName" required placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" required placeholder="Choose a unique username" pattern="[A-Za-z0-9_]{3,20}" title="Username must be 3-20 characters, letters, numbers, and underscores only">
                        <div class="username-validation" id="usernameValidation" style="display: none;">
                            <span class="validation-message" id="usernameMessage"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required placeholder="Enter your email">
                    </div>
                    
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" required placeholder="Create a password">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" required placeholder="Confirm your password">
                    </div>
                    
                    <button type="submit" class="auth-btn" id="registerSubmitBtn">Create Account</button>
                </form>
                
                <div class="auth-footer">
                    <p>Already have an account? <a href="#" onclick="switchToLogin()">Sign in here</a></p>
                </div>
            </div>
        </div>
        
        <!-- Admin Login Modal -->
        <div id="adminModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>⚙️ Admin Access</h3>
                    <button onclick="closeAdminModal()" class="close-btn">×</button>
                </div>
                
                <form id="adminLoginForm" class="auth-form">
                    <div class="form-group">
                        <label for="adminKey">Admin Key</label>
                        <input type="password" id="adminKey" required placeholder="Enter admin key">
                        <small>Hint: Your special admin access code</small>
                    </div>
                    
                    <button type="submit" class="auth-btn">Access Admin Panel</button>
                </form>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <div class="dashboard-grid">
                <!-- Current Status -->
                <div class="card">
                    <h3 class="card-title">Current Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Speed</div>
                            <div class="status-value" id="currentSpeed">0<span class="status-unit">mph</span></div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Distance</div>
                            <div class="status-value" id="totalDistance">0.0<span class="status-unit">mi</span></div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Location Quality</div>
                            <div class="status-value" style="font-size: 0.875rem;" id="locationStatus">Getting location...</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Status</div>
                            <div class="status-value" style="font-size: 0.875rem;" id="trackingStatus">Ready</div>
                        </div>
                    </div>
                </div>

                <!-- Tracking Controls -->
                <div class="card">
                    <h3 class="card-title">Route Tracking</h3>
                    <div class="tracking-controls">
                        <button id="trackBtn" class="track-button" onclick="toggleTracking()">
                            Start Recording
                        </button>
                        <div id="trackingInfo" class="tracking-info hidden">
                            <div>Recording route...</div>
                            <div id="routePoints">0 points</div>
                        </div>
                    </div>
                    
                    <!-- Live Sharing Controls -->
                    <div class="live-sharing-section">
                        <div class="live-sharing-header">
                            <h4>🔴 Live Drive Mode</h4>
                            <div class="live-status" id="liveStatus">Offline</div>
                        </div>
                        <div class="live-controls">
                            <button id="liveModeBtn" class="btn live-btn" onclick="toggleLiveMode()">
                                📡 Start Live Sharing
                            </button>
                            <button class="btn btn-secondary" onclick="openPrivacySettings()">
                                🔒 Privacy
                            </button>
                        </div>
                        <div class="live-info" id="liveInfo" style="display: none;">
                            <p><strong>Sharing with:</strong> <span id="sharingWith">0 friends</span></p>
                            <p><strong>Duration:</strong> <span id="sharingDuration">0:00</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="card">
                <h3 class="card-title">Live Map</h3>
                <div class="map-controls">
                    <button class="btn btn-sm" onclick="toggleMapLayer('traffic')" id="trafficBtn">
                        🚦 Traffic
                    </button>
                    <button class="btn btn-sm" onclick="toggleMapLayer('satellite')" id="satelliteBtn">
                        🛰️ Satellite
                    </button>
                    <button class="btn btn-sm" onclick="toggleMapLayer('terrain')" id="terrainBtn">
                        🏔️ Terrain
                    </button>
                </div>
                <div id="map" class="map-container"></div>
                <div class="route-overlay" id="routeOverlay">
                    <button class="btn btn-sm" onclick="toggleRouteComparison()" id="compareBtn">
                        📊 Compare Routes
                    </button>
                    <button class="btn btn-sm" onclick="shareCurrentRoute()" id="shareBtn">
                        📤 Share Route
                    </button>
                    <button class="btn btn-sm" onclick="suggestAlternativeRoute()" id="suggestBtn">
                        🔄 Find Alternative
                    </button>
                </div>
            </div>

            <!-- Recent Routes -->
            <div class="card">
                <h3 class="card-title">Recent Routes</h3>
                <div class="routes-grid" id="recentRoutes">
                    <!-- Routes will be populated here -->
                </div>
            </div>
        </div>

        <!-- Routes Page -->
        <div id="routes" class="page hidden">
            <!-- Route Tabs -->
            <div class="card">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(148, 163, 184, 0.1); padding-bottom: 1rem;">
                    <button class="route-tab active" onclick="showRouteTab('my-routes')">My Routes</button>
                    <button class="route-tab" onclick="showRouteTab('friends-routes')">Friends' Routes</button>
                    <button class="route-tab" onclick="showRouteTab('live-friends')">🔴 Live Friends</button>
                    <button class="route-tab" onclick="showRouteTab('public-routes')">Public Routes</button>
                </div>
                
                <!-- Search Bar -->
                <div class="search-bar">
                    <input type="text" class="form-input" placeholder="Search routes..." style="max-width: 300px;" id="routeSearchInput" onkeyup="filterRoutes()">
                </div>
            </div>

            <!-- My Routes Tab -->
            <div id="my-routes" class="route-tab-content">
                <div class="card">
                    <h3 class="card-title">My Routes</h3>
                    <div class="routes-grid" id="allRoutes">
                        <!-- My routes will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Friends Routes Tab -->
            <div id="friends-routes" class="route-tab-content hidden">
                <div class="card">
                    <h3 class="card-title">Friends' Routes</h3>
                    <div class="routes-grid" id="friendsRoutes">
                        <!-- Friends routes will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Public Routes Tab -->
            <div id="public-routes" class="route-tab-content hidden">
                <div class="card">
                    <h3 class="card-title">Discover Public Routes</h3>
                    <div class="routes-grid" id="publicRoutes">
                        <!-- Public routes will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Live Friends Tab -->
            <div id="live-friends" class="route-tab-content hidden">
                <div class="card">
                    <h3 class="card-title">🔴 Live Friends Activity</h3>
                    <div class="live-friends-header">
                        <div class="live-stats">
                            <div class="live-stat">
                                <span class="live-count" id="liveCount">0</span>
                                <span class="live-label">Friends Online</span>
                            </div>
                            <div class="live-stat">
                                <span class="live-count" id="drivingCount">0</span>
                                <span class="live-label">Currently Driving</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="refreshLiveFriends()">🔄 Refresh</button>
                    </div>
                    <div class="live-friends-grid" id="liveFriendsGrid">
                        <!-- Live friends will be populated here -->
                    </div>
                </div>
                
                <!-- Live Map -->
                <div class="card">
                    <h3 class="card-title">Live Friends Map</h3>
                    <div class="live-map-container">
                        <div id="liveMap" class="live-map">
                            <!-- Live map will be rendered here -->
                        </div>
                        <div class="live-map-controls">
                            <button class="btn btn-secondary" onclick="focusOnFriends()">📍 Focus All</button>
                            <button class="btn btn-secondary" onclick="toggleMapMode()">🗺️ Toggle View</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page hidden">
            <!-- Weekly Summary -->
            <div class="card">
                <h3 class="card-title">📊 Weekly Summary</h3>
                <div class="analytics-grid">
                    <div class="analytics-item">
                        <div class="analytics-value" id="weeklyDistance">0</div>
                        <div class="analytics-label">Miles Driven</div>
                        <div class="analytics-change positive">+12% vs last week</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-value" id="weeklyTime">0</div>
                        <div class="analytics-label">Hours Driving</div>
                        <div class="analytics-change positive">+8% vs last week</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-value" id="weeklySpeed">0</div>
                        <div class="analytics-label">Avg Speed (mph)</div>
                        <div class="analytics-change negative">-3% vs last week</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-value" id="weeklyEfficiency">0</div>
                        <div class="analytics-label">Efficiency Score</div>
                        <div class="analytics-change positive">+5% vs last week</div>
                    </div>
                </div>
            </div>

            <!-- Driving Insights -->
            <div class="card">
                <h3 class="card-title">🎯 Driving Insights</h3>
                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-icon">🏆</div>
                        <div class="insight-content">
                            <h4>Best Route This Week</h4>
                            <p id="bestRoute">Highway 101 - 45.2 mi in 38 min</p>
                            <div class="insight-stats">
                                <span class="stat">87 mph max</span>
                                <span class="stat">71 mph avg</span>
                            </div>
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-icon">⏰</div>
                        <div class="insight-content">
                            <h4>Peak Driving Time</h4>
                            <p id="peakTime">7:30 AM - 9:00 AM</p>
                            <div class="insight-stats">
                                <span class="stat">Most active</span>
                                <span class="stat">5 days this week</span>
                            </div>
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-icon">🌱</div>
                        <div class="insight-content">
                            <h4>Eco Score</h4>
                            <p id="ecoscore">85/100</p>
                            <div class="insight-stats">
                                <span class="stat">Smooth acceleration</span>
                                <span class="stat">Efficient routes</span>
                            </div>
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-icon">🚗</div>
                        <div class="insight-content">
                            <h4>Route Variety</h4>
                            <p id="routeVariety">12 unique routes</p>
                            <div class="insight-stats">
                                <span class="stat">3 new this week</span>
                                <span class="stat">Explorer badge</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Speed Analysis -->
            <div class="card">
                <h3 class="card-title">⚡ Speed Analysis</h3>
                <div class="speed-chart-container">
                    <canvas id="speedChart" width="400" height="200"></canvas>
                </div>
                <div class="speed-stats">
                    <div class="speed-stat">
                        <div class="speed-value" id="topSpeed">0</div>
                        <div class="speed-label">Top Speed (mph)</div>
                    </div>
                    <div class="speed-stat">
                        <div class="speed-value" id="avgSpeed">0</div>
                        <div class="speed-label">Average Speed (mph)</div>
                    </div>
                    <div class="speed-stat">
                        <div class="speed-value" id="speedConsistency">0</div>
                        <div class="speed-label">Consistency Score</div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="card">
                <h3 class="card-title">🏅 Achievements</h3>
                <div class="achievements-grid">
                    <div class="achievement earned">
                        <div class="achievement-icon">🚀</div>
                        <div class="achievement-content">
                            <h4>Speed Demon</h4>
                            <p>Reached 100+ mph</p>
                            <div class="achievement-date">Earned 2 days ago</div>
                        </div>
                    </div>
                    <div class="achievement earned">
                        <div class="achievement-icon">🛣️</div>
                        <div class="achievement-content">
                            <h4>Road Warrior</h4>
                            <p>500+ miles driven</p>
                            <div class="achievement-date">Earned 1 week ago</div>
                        </div>
                    </div>
                    <div class="achievement earned">
                        <div class="achievement-icon">🌍</div>
                        <div class="achievement-content">
                            <h4>Explorer</h4>
                            <p>10+ unique routes</p>
                            <div class="achievement-date">Earned 3 days ago</div>
                        </div>
                    </div>
                    <div class="achievement locked">
                        <div class="achievement-icon">⏱️</div>
                        <div class="achievement-content">
                            <h4>Early Bird</h4>
                            <p>Drive before 6 AM (5/10)</p>
                            <div class="achievement-progress">50%</div>
                        </div>
                    </div>
                    <div class="achievement locked">
                        <div class="achievement-icon">🌱</div>
                        <div class="achievement-content">
                            <h4>Eco Driver</h4>
                            <p>90+ efficiency score (85/90)</p>
                            <div class="achievement-progress">94%</div>
                        </div>
                    </div>
                    <div class="achievement locked">
                        <div class="achievement-icon">🏁</div>
                        <div class="achievement-content">
                            <h4>Marathon Driver</h4>
                            <p>1000+ miles in a month</p>
                            <div class="achievement-progress">23%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard -->
            <div class="card">
                <h3 class="card-title">🏆 Leaderboard</h3>
                <div class="leaderboard-tabs">
                    <button class="leaderboard-tab active" onclick="showLeaderboard('distance')">Distance</button>
                    <button class="leaderboard-tab" onclick="showLeaderboard('speed')">Speed</button>
                    <button class="leaderboard-tab" onclick="showLeaderboard('efficiency')">Efficiency</button>
                </div>
                <div class="leaderboard-content">
                    <div class="leaderboard-list" id="distanceLeaderboard">
                        <div class="leaderboard-item">
                            <div class="rank">1</div>
                            <div class="player-info">
                                <div class="player-name">SpeedRacer</div>
                                <div class="player-stats">2,847 mi</div>
                            </div>
                            <div class="player-score">2,847</div>
                        </div>
                        <div class="leaderboard-item">
                            <div class="rank">2</div>
                            <div class="player-info">
                                <div class="player-name">RoadWarrior</div>
                                <div class="player-stats">2,156 mi</div>
                            </div>
                            <div class="player-score">2,156</div>
                        </div>
                        <div class="leaderboard-item current-user">
                            <div class="rank">3</div>
                            <div class="player-info">
                                <div class="player-name">You</div>
                                <div class="player-stats">1,892 mi</div>
                            </div>
                            <div class="player-score">1,892</div>
                        </div>
                        <div class="leaderboard-item">
                            <div class="rank">4</div>
                            <div class="player-info">
                                <div class="player-name">UrbanDriver</div>
                                <div class="player-stats">1,234 mi</div>
                            </div>
                            <div class="player-score">1,234</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feed Page -->
        <div id="feed" class="page hidden">
            <!-- Create Post Section -->
            <div class="card">
                <h3 class="card-title">Share Your Drive</h3>
                <div class="create-post">
                    <textarea id="postText" class="form-input" rows="3" placeholder="Share something about your drive..." style="margin-bottom: 1rem; resize: vertical;"></textarea>
                    
                    <!-- Photo Upload Section -->
                    <div class="photo-upload-section">
                        <input type="file" id="photoUpload" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
                        <div class="upload-actions">
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('photoUpload').click()">
                                📷 Add Photos
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="createPost()" style="margin-left: auto;">
                                Post
                            </button>
                        </div>
                        <div id="photoPreview" class="photo-preview-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Feed Posts -->
            <div id="feedPosts">
                <!-- Posts will be populated here -->
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile" class="page hidden">
            <div class="card">
                <h3 class="card-title">👤 Driver Profile</h3>
                <div class="profile-info">
                    <div class="profile-header">
                        <div class="avatar-circle">👤</div>
                        <div class="profile-details">
                            <h2 id="profileName">User</h2>
                            <p><strong>@<span id="profileUsername">username</span></strong></p>
                            <p id="profileEmail">user@example.com</p>
                            <span id="profileRole" class="role-badge">Driver</span>
                        </div>
                    </div>
                </div>
                <div class="status-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 1rem;">
                    <div class="status-item">
                        <div class="status-label">Total Distance</div>
                        <div class="status-value" id="profileMiles">0<span class="status-unit">mi</span></div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Level</div>
                        <div class="status-value" id="profileLevel">1</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Total XP</div>
                        <div class="status-value" id="profileXP">0<span class="status-unit">XP</span></div>
                    </div>
                </div>
            </div>

            <!-- Friends Section -->
            <div class="card">
                <h3 class="card-title">👥 Friends</h3>
                <div class="friends-section">
                    <div class="search-friends">
                        <input type="text" id="friendSearch" placeholder="Search for friends..." class="form-input" style="margin-bottom: 1rem;">
                        <button class="btn" onclick="searchFriends()">🔍 Search</button>
                    </div>
                    <div class="friends-list" id="friendsList">
                        <!-- Friends will be populated here -->
                    </div>
                </div>
            </div>

            <!-- My Posts Section -->
            <div class="card">
                <h3 class="card-title">📝 My Posts</h3>
                <div class="my-posts" id="myPosts">
                    <!-- User's posts will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div id="admin" class="page hidden">
            <div class="admin-grid">
                <!-- Enhanced Dashboard Overview -->
                <div class="card admin-overview">
                    <h3 class="card-title">⚙️ Admin Dashboard</h3>
                    <div class="admin-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalUsers">1</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalRoutes">0</div>
                            <div class="stat-label">Total Routes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalPosts">0</div>
                            <div class="stat-label">Total Posts</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="activeUsers">0</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalDistance">0</div>
                            <div class="stat-label">Total Miles</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgSpeed">0</div>
                            <div class="stat-label">Avg Speed</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced User Management -->
                <div class="card">
                    <h3 class="card-title">👥 User Management</h3>
                    <div class="user-controls">
                        <input type="text" id="userSearch" placeholder="Search users..." class="form-input" style="margin-bottom: 1rem;">
                        <div class="user-filters">
                            <button class="btn btn-sm" onclick="filterUsers('all')">All</button>
                            <button class="btn btn-sm" onclick="filterUsers('active')">Active</button>
                            <button class="btn btn-sm" onclick="filterUsers('admin')">Admins</button>
                        </div>
                    </div>
                    <div class="user-list" id="userList">
                        <!-- Users will be populated here -->
                    </div>
                    <div class="user-actions">
                        <button class="btn" onclick="createUser()">➕ Add User</button>
                        <button class="btn btn-secondary" onclick="exportUsers()">📤 Export Users</button>
                    </div>
                </div>
                
                <!-- Advanced System Management -->
                <div class="card">
                    <h3 class="card-title">🗺️ System Management</h3>
                    <div class="admin-actions">
                        <div class="action-group">
                            <h4>Data Management</h4>
                            <button class="btn" onclick="clearAllRoutes()">🗑️ Clear All Routes</button>
                            <button class="btn" onclick="clearAllPosts()">🧹 Clear All Posts</button>
                            <button class="btn" onclick="clearAllUsers()">👥 Clear All Users</button>
                        </div>
                        <div class="action-group">
                            <h4>Analytics & Reports</h4>
                            <button class="btn" onclick="exportData()">📤 Export All Data</button>
                            <button class="btn" onclick="generateReport()">📊 Generate Report</button>
                            <button class="btn btn-secondary" onclick="resetAnalytics()">🔄 Reset Analytics</button>
                        </div>
                        <div class="action-group">
                            <h4>System Maintenance</h4>
                            <button class="btn" onclick="optimizeStorage()">⚡ Optimize Storage</button>
                            <button class="btn" onclick="clearCache()">🧹 Clear Cache</button>
                            <button class="btn" onclick="validateData()">✅ Validate Data</button>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Backup & Restore -->
                <div class="card">
                    <h3 class="card-title">💾 Data Backup & Restore</h3>
                    <div class="backup-status" id="backupStatus">
                        <div class="status-row">
                            <span class="status-label">Last Backup:</span>
                            <span class="status-value" id="lastBackup">Never</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Backup Size:</span>
                            <span class="status-value" id="backupSize">0 KB</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Auto Backup:</span>
                            <span class="status-value" id="autoBackupStatus">Enabled</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Backup Frequency:</span>
                            <span class="status-value">Every 6 hours</span>
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn" onclick="createBackup()">💾 Create Backup</button>
                        <button class="btn btn-secondary" onclick="restoreFromFile()">📂 Restore from File</button>
                        <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="handleRestore(event)">
                        <button class="btn btn-secondary" onclick="toggleAutoBackup()">⚙️ Toggle Auto Backup</button>
                        <button class="btn" onclick="scheduleBackup()">⏰ Schedule Backup</button>
                    </div>
                </div>
                
                <!-- Real-time Monitoring -->
                <div class="card">
                    <h3 class="card-title">📊 Real-time Monitoring</h3>
                    <div class="monitoring-grid">
                        <div class="monitor-item">
                            <div class="monitor-label">CPU Usage</div>
                            <div class="monitor-value" id="cpuUsage">0%</div>
                            <div class="monitor-bar">
                                <div class="monitor-fill" id="cpuBar"></div>
                            </div>
                        </div>
                        <div class="monitor-item">
                            <div class="monitor-label">Memory Usage</div>
                            <div class="monitor-value" id="memoryUsage">0%</div>
                            <div class="monitor-bar">
                                <div class="monitor-fill" id="memoryBar"></div>
                            </div>
                        </div>
                        <div class="monitor-item">
                            <div class="monitor-label">Storage Usage</div>
                            <div class="monitor-value" id="storageUsage">0%</div>
                            <div class="monitor-bar">
                                <div class="monitor-fill" id="storageBar"></div>
                            </div>
                        </div>
                        <div class="monitor-item">
                            <div class="monitor-label">Active Sessions</div>
                            <div class="monitor-value" id="activeSessions">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced System Info -->
                <div class="card">
                    <h3 class="card-title">📊 System Information</h3>
                    <div class="system-info">
                        <div class="info-section">
                            <h4>Application</h4>
                            <p><strong>Version:</strong> 1.0.0</p>
                            <p><strong>Build:</strong> 2024.01.15</p>
                            <p><strong>Last Updated:</strong> <span id="lastUpdate">Today</span></p>
                            <p><strong>Uptime:</strong> <span id="uptime">0h 0m</span></p>
                        </div>
                        <div class="info-section">
                            <h4>Performance</h4>
                            <p><strong>Load Time:</strong> <span id="loadTime">0ms</span></p>
                            <p><strong>Storage Used:</strong> <span id="storageUsed">Loading...</span></p>
                            <p><strong>Errors Count:</strong> <span id="errorsCount">0</span></p>
                            <p><strong>Routes Saved:</strong> <span id="routesSaved">0</span></p>
                        </div>
                        <div class="info-section">
                            <h4>Browser</h4>
                            <p><strong>User Agent:</strong> <span id="userAgent">Loading...</span></p>
                            <p><strong>Language:</strong> <span id="language">en-US</span></p>
                            <p><strong>Platform:</strong> <span id="platform">Unknown</span></p>
                        </div>
                        <div class="info-section">
                            <h4>Errors</h4>
                            <p><strong>Last Error:</strong> <span id="lastError">None</span></p>
                            <p><strong>Error Rate:</strong> <span id="errorRate">0%</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Security & Logs -->
                <div class="card">
                    <h3 class="card-title">🔒 Security & Logs</h3>
                    <div class="security-section">
                        <div class="security-actions">
                            <button class="btn" onclick="viewSecurityLogs()">🔍 View Security Logs</button>
                            <button class="btn" onclick="viewActivityLogs()">📋 View Activity Logs</button>
                            <button class="btn btn-secondary" onclick="clearLogs()">🧹 Clear Logs</button>
                        </div>
                        <div class="log-preview" id="logPreview">
                            <h4>Recent Activity</h4>
                            <div class="log-entries" id="logEntries">
                                <!-- Log entries will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="card">
                    <h3 class="card-title">⚙️ Advanced Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="debugMode" onchange="toggleDebugMode()">
                                Debug Mode
                            </label>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="maintenanceMode" onchange="toggleMaintenanceMode()">
                                Maintenance Mode
                            </label>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="autoOptimize" onchange="toggleAutoOptimize()">
                                Auto Optimize
                            </label>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="errorReporting" onchange="toggleErrorReporting()">
                                Error Reporting
                            </label>
                        </div>
                    </div>
                    <div class="setting-actions">
                        <button class="btn" onclick="saveSettings()">💾 Save Settings</button>
                        <button class="btn btn-secondary" onclick="resetSettings()">🔄 Reset Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Route Modal -->
    <div id="saveModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="modal-title">Save Route</h3>
            <div class="form-group">
                <label class="form-label">Route Name</label>
                <input type="text" id="routeName" class="form-input" placeholder="Enter route name">
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="isPublic" style="margin-right: 0.5rem;">
                    Make route public
                </label>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary btn-sm" onclick="closeSaveModal()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="saveRoute()">Save Route</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let currentRoute = [];
        let isTracking = false;
        let watchId = null;
        let speedData = [];
        let locationPermissionGranted = false;
        let currentPosition = null;
        let selectedPhotos = [];
        let posts = [];
        let mapLayers = {
            traffic: null,
            satellite: null,
            terrain: null,
            currentLayer: 'standard'
        };
        let routeComparison = {
            active: false,
            routes: [],
            selectedRoutes: []
        };
        let poiMarkers = [];
        let alternativeRoutes = [];
        let accelerometerData = {
            x: 0,
            y: 0,
            z: 0,
            totalG: 0,
            isSupported: false
        };
        let gForceHistory = [];
        let maxGForce = 0;
        
        // XP and Leveling System
        let playerData = {
            xp: 0,
            level: 1,
            totalDistance: 0,
            totalDrives: 0,
            achievements: [],
            dailyXP: 0,
            weeklyXP: 0,
            lastActive: new Date().toDateString()
        };
        
        // Authentication System
        let currentUser = null;
        let users = [];
        const ADMIN_KEY = "5478"; // Your admin password
        
        // Data persistence configuration
        const DATA_CONFIG = {
            MAX_STORAGE_SIZE: 5 * 1024 * 1024, // 5MB
            BACKUP_FREQUENCY: 6 * 60 * 60 * 1000, // 6 hours
            VALIDATION_INTERVAL: 60 * 1000, // 1 minute
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000 // 1 second
        };
        
        // Session management
        let sessionStart = new Date();
        let socialInterval = null;
        let leaderboardInterval = null;
        let gforceInterval = null;
        
        // Data persistence functions
        function safeSetItem(key, value, retries = DATA_CONFIG.MAX_RETRIES) {
            try {
                const serialized = JSON.stringify(value);
                
                // Check storage quota
                if (serialized.length > DATA_CONFIG.MAX_STORAGE_SIZE) {
                    throw new Error('Data too large for storage');
                }
                
                localStorage.setItem(key, serialized);
                
                // Verify the data was saved correctly
                const retrieved = localStorage.getItem(key);
                if (!retrieved || retrieved !== serialized) {
                    throw new Error('Data verification failed');
                }
                
                console.log(`✅ Data saved successfully: ${key}`);
                return true;
            } catch (error) {
                console.error(`❌ Failed to save data: ${key}`, error);
                
                if (retries > 0) {
                    console.log(`🔄 Retrying save for ${key}... (${retries} attempts left)`);
                    setTimeout(() => {
                        safeSetItem(key, value, retries - 1);
                    }, DATA_CONFIG.RETRY_DELAY);
                } else {
                    showDataError(`Failed to save ${key}. Data may be lost.`);
                }
                return false;
            }
        }
        
        function safeGetItem(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                if (item === null) {
                    return defaultValue;
                }
                
                const parsed = JSON.parse(item);
                
                // Validate data integrity
                if (!validateDataIntegrity(key, parsed)) {
                    console.warn(`⚠️ Data integrity check failed for ${key}, using backup`);
                    return getBackupData(key, defaultValue);
                }
                
                return parsed;
            } catch (error) {
                console.error(`❌ Failed to load data: ${key}`, error);
                return getBackupData(key, defaultValue);
            }
        }
        
        function validateDataIntegrity(key, data) {
            switch (key) {
                case 'posts':
                    return Array.isArray(data) && data.every(post => 
                        post.id && post.username && post.timestamp
                    );
                case 'routes':
                    return Array.isArray(data) && data.every(route => 
                        route.id && route.name && route.points
                    );
                case 'users':
                    return Array.isArray(data) && data.every(user => 
                        user.id && user.username && user.email
                    );
                case 'playerData':
                    return data && typeof data.xp === 'number' && typeof data.level === 'number';
                default:
                    return data !== null && data !== undefined;
            }
        }
        
        function getBackupData(key, defaultValue) {
            try {
                const backup = localStorage.getItem('driverhub_backup');
                if (backup) {
                    const backupData = JSON.parse(backup);
                    if (backupData.userData && backupData.userData[key]) {
                        console.log(`🔄 Restored ${key} from backup`);
                        return backupData.userData[key];
                    }
                }
            } catch (error) {
                console.error('Failed to restore from backup:', error);
            }
            return defaultValue;
        }
        
        function createDataBackup() {
            try {
                const backupData = {
                    version: "1.0.0",
                    timestamp: new Date().toISOString(),
                    userData: {
                        currentUser: currentUser,
                        users: users,
                        playerData: playerData,
                        routes: safeGetItem('routes', []),
                        posts: safeGetItem('posts', []),
                        performanceMetrics: performanceMetrics
                    },
                    settings: backupSettings
                };
                
                safeSetItem('driverhub_backup', backupData);
                backupSettings.lastBackup = new Date().toISOString();
                safeSetItem('backupSettings', backupSettings);
                
                console.log('✅ Data backup created successfully');
                return true;
            } catch (error) {
                console.error('❌ Failed to create backup:', error);
                return false;
            }
        }
        
        function startDataValidation() {
            setInterval(() => {
                validateAllData();
            }, DATA_CONFIG.VALIDATION_INTERVAL);
        }
        
        function validateAllData() {
            const criticalData = ['posts', 'routes', 'users', 'playerData'];
            let hasErrors = false;
            
            criticalData.forEach(key => {
                const data = safeGetItem(key);
                if (!validateDataIntegrity(key, data)) {
                    console.error(`❌ Data validation failed for ${key}`);
                    hasErrors = true;
                }
            });
            
            if (hasErrors) {
                console.log('🔄 Attempting data recovery...');
                attemptDataRecovery();
            }
        }
        
        function attemptDataRecovery() {
            // Try to restore from backup
            const backup = safeGetItem('driverhub_backup');
            if (backup && backup.userData) {
                console.log('🔄 Restoring data from backup...');
                
                if (backup.userData.posts) safeSetItem('posts', backup.userData.posts);
                if (backup.userData.routes) safeSetItem('routes', backup.userData.routes);
                if (backup.userData.users) safeSetItem('users', backup.userData.users);
                if (backup.userData.playerData) safeSetItem('playerData', backup.userData.playerData);
                
                showDataRecoveryNotification();
            } else {
                console.error('❌ No backup available for recovery');
                showDataLossWarning();
            }
        }
        
        function showDataError(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            `;
            notification.innerHTML = `⚠️ ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        function showDataRecoveryNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            `;
            notification.innerHTML = '✅ Data recovered from backup successfully';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function showDataLossWarning() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            `;
            notification.innerHTML = '⚠️ Data integrity issues detected. Please refresh the page.';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 8000);
        }
        
        // Performance monitoring
        let performanceMetrics = {
            loadTime: 0,
            routesSaved: 0,
            errorsCount: 0,
            lastError: null
        };
        
        // Backup system
        let backupSettings = {
            autoBackup: true,
            lastBackup: null,
            backupInterval: null
        };
        
        // Live tracking system
        let liveTracking = {
            isActive: false,
            startTime: null,
            interval: null,
            sharingWith: [],
            currentLocation: null,
            lastUpdate: null,
            emergencyMode: false,
            privacySettings: {
                shareWithAll: false,
                allowedFriends: [],
                autoExpire: true,
                expireAfter: 2 * 60 * 60 * 1000 // 2 hours
            }
        };
        
        let liveFriends = {};
        let liveMapInstance = null;
        
        // XP Configuration
        const XP_CONFIG = {
            // Base XP per activity
            DISTANCE_PER_MILE: 10,
            DRIVE_COMPLETION: 50,
            SAFE_DRIVE_BONUS: 25,
            SPEED_LIMIT_BONUS: 15,
            ECO_DRIVE_BONUS: 30,
            PHOTO_SHARE: 20,
            ROUTE_SHARE: 35,
            COMMENT_POST: 5,
            LIKE_RECEIVE: 3,
            DAILY_STREAK: 100,
            ACHIEVEMENT_UNLOCK: 200,
            
            // Level progression (XP needed for each level)
            LEVEL_THRESHOLDS: [0, 100, 250, 450, 700, 1000, 1400, 1850, 2350, 2900, 3500, 4200, 5000, 6000, 7200, 8600, 10200, 12000, 14000, 16500, 19500, 23000, 27000, 31500, 36500, 42000, 48000, 54500, 61500, 69000, 77000, 85500, 94500, 104000, 114000, 124500, 135500, 147000, 159000, 171500, 184500, 198000, 212000, 226500, 241500, 257000, 273000, 289500, 306500, 324000],
            
            // Achievements
            ACHIEVEMENTS: {
                'first_drive': { name: 'First Steps', description: 'Complete your first drive', xp: 100, icon: '🚗' },
                'distance_10': { name: 'Explorer', description: 'Drive 10 miles total', xp: 150, icon: '🗺️' },
                'distance_50': { name: 'Road Warrior', description: 'Drive 50 miles total', xp: 300, icon: '⚔️' },
                'distance_100': { name: 'Century Club', description: 'Drive 100 miles total', xp: 500, icon: '💯' },
                'distance_500': { name: 'Highway Hero', description: 'Drive 500 miles total', xp: 1000, icon: '🦸' },
                'drives_10': { name: 'Regular Driver', description: 'Complete 10 drives', xp: 200, icon: '🔄' },
                'drives_50': { name: 'Veteran Driver', description: 'Complete 50 drives', xp: 750, icon: '🎖️' },
                'safe_driver': { name: 'Safety First', description: 'Complete 10 drives without hard events', xp: 400, icon: '🛡️' },
                'speed_demon': { name: 'Speed Demon', description: 'Reach 100+ mph', xp: 500, icon: '⚡' },
                'photographer': { name: 'Photographer', description: 'Share 10 photos', xp: 300, icon: '📸' },
                'social_butterfly': { name: 'Social Butterfly', description: 'Get 50 likes total', xp: 350, icon: '🦋' },
                'streak_7': { name: 'Weekly Warrior', description: 'Drive 7 days in a row', xp: 600, icon: '🔥' },
                'level_10': { name: 'Rising Star', description: 'Reach level 10', xp: 1000, icon: '⭐' },
                'level_25': { name: 'Elite Driver', description: 'Reach level 25', xp: 2500, icon: '👑' },
                'gforce_master': { name: 'G-Force Master', description: 'Experience 3.0+ G-force', xp: 400, icon: '🚀' }
            }
        };

        // Global error handler
        window.addEventListener('error', function(event) {
            performanceMetrics.errorsCount++;
            performanceMetrics.lastError = {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                timestamp: new Date().toISOString()
            };
            console.error('Global error caught:', event.error);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            performanceMetrics.errorsCount++;
            performanceMetrics.lastError = {
                message: event.reason.toString(),
                type: 'Promise rejection',
                timestamp: new Date().toISOString()
            };
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = performance.now();
            console.log('DriveSphere initializing...');
            
            // Initialize session persistence first
            initializeSessionPersistence();
            
            // Initialize data persistence
            initializeDataPersistence();
            
            // Check authentication first
            checkAuthStatus();
            
            // Setup auth form handlers
            setupAuthHandlers();
            
            // Only initialize if authenticated
            if (currentUser) {
                initializeApp();
            }
            
            // Record load time
            performanceMetrics.loadTime = performance.now() - startTime;
            console.log(`DriveSphere loaded in ${performanceMetrics.loadTime.toFixed(2)}ms`);
        });
        
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            // Reset page transition lock on any error
            window.isPageTransitioning = false;
        });

        // Manual reset function for stuck navigation
        function resetNavigation() {
            console.log('Resetting navigation...');
            window.isPageTransitioning = false;
            
            // Reset all page styles
            document.querySelectorAll('.page').forEach(page => {
                page.style.opacity = '1';
                page.style.transition = '';
            });
            
            // Show dashboard as fallback
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            const dashboard = document.getElementById('dashboard');
            if (dashboard) {
                dashboard.classList.remove('hidden');
            }
            
            // Reset nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const dashboardLink = document.querySelector('[onclick="showPage(\'dashboard\')"]');
            if (dashboardLink) {
                dashboardLink.classList.add('active');
            }
            
            console.log('Navigation reset complete');
        }

        // Add reset function to window for debugging
        window.resetNavigation = resetNavigation;

        function initializeApp() {
            try {
                // Make sure save modal is hidden on startup
                const saveModal = document.getElementById('saveModal');
                if (saveModal) {
                    saveModal.classList.add('hidden');
                    console.log('Save modal hidden on startup');
                }
                
                // Initialize route tracking variables
                currentRoute = [];
                speedData = [];
                isTracking = false;
                watchId = null;
                
                // Initialize components
                initializeMap();
                loadSampleRoutes();
                loadFeed();
                
                // Initialize XP system
                loadPlayerData();
                initializeXPSystem();
                
                // Initialize backup system
                initializeBackupSystem();
                
                // Initialize live tracking system
                initializeLiveTracking();
                
                // Initialize mobile features
                initializeSwipeGestures();
                initializePullToRefresh();
                initializeAccelerometer();
                
                // Initialize social simulation
                simulateSocialUpdates();
                
                // Initialize scroll animations
                initializeScrollAnimations();
                
                // Add glow effects (floating effects removed)
                addGlowEffects();
                
                // Add haptic feedback to buttons
                document.querySelectorAll('.btn, .nav-link, .post-action').forEach(btn => {
                    btn.addEventListener('click', () => {
                        addHapticFeedback(btn, 'light');
                    });
                });
                
                // Get location after other components are loaded
                setTimeout(() => {
                    getCurrentLocationForMap();
                    updateAnalytics();
                }, 1000);
                
                // Register service worker for PWA
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('Service Worker registered successfully:', registration);
                        })
                        .catch((error) => {
                            console.log('Service Worker registration failed:', error);
                        });
                }
                
                console.log('DriveSphere initialized successfully');
            } catch (error) {
                console.error('Error during app initialization:', error);
            }
        }

        // Photo upload handling
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        selectedPhotos.push({
                            id: Date.now() + Math.random(),
                            data: e.target.result,
                            file: file
                        });
                        updatePhotoPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = selectedPhotos.map(photo => `
                <div class="photo-preview">
                    <img src="${photo.data}" alt="Preview">
                    <button class="photo-remove" onclick="removePhoto('${photo.id}')">×</button>
                </div>
            `).join('');
        }

        function removePhoto(photoId) {
            selectedPhotos = selectedPhotos.filter(photo => photo.id !== photoId);
            updatePhotoPreview();
        }

        function createPost() {
            const text = document.getElementById('postText').value.trim();
            
            if (!text && selectedPhotos.length === 0) {
                alert('Please add some content or photos to your post');
                return;
            }

            const post = {
                id: Date.now(),
                username: 'You',
                text: text,
                photos: [...selectedPhotos],
                timestamp: Date.now(),
                likes: 0,
                liked: false
            };

            // Save to localStorage with data protection
            const savedPosts = safeGetItem('posts', []);
            savedPosts.unshift(post);
            safeSetItem('posts', savedPosts);

            // Award XP for photo sharing if photos were included
            if (selectedPhotos.length > 0) {
                addXP(XP_CONFIG.PHOTO_SHARE * selectedPhotos.length, `Shared ${selectedPhotos.length} photo${selectedPhotos.length > 1 ? 's' : ''}`);
            }

            // Reset form
            document.getElementById('postText').value = '';
            selectedPhotos = [];
            updatePhotoPreview();
            document.getElementById('photoUpload').value = '';

            // Reload feed
            loadFeed();
        }

        function generateMockPosts() {
            return [
                {
                    id: 'mock-1',
                    username: 'SpeedRacer',
                    text: 'Epic highway run today! Hit a new top speed of 87 mph on the freeway 🏎️',
                    photos: [],
                    timestamp: Date.now() - 3600000,
                    likes: 8,
                    liked: false,
                    comments: [
                        { id: 'c1', username: 'RoadWarrior', text: 'Wow! That\'s impressive! Stay safe out there 🚗', timestamp: Date.now() - 3000000 },
                        { id: 'c2', username: 'UrbanDriver', text: 'Nice speed! What car were you driving?', timestamp: Date.now() - 2700000 }
                    ]
                },
                {
                    id: 'mock-2',
                    username: 'RoadWarrior',
                    text: 'Beautiful mountain drive this morning. The views were incredible!',
                    photos: [
                        { id: 'mock-photo-1', data: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNGY0NjY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1vdW50YWluIFZpZXc8L3RleHQ+PC9zdmc+' }
                    ],
                    timestamp: Date.now() - 7200000,
                    likes: 12,
                    liked: false,
                    comments: [
                        { id: 'c3', username: 'SpeedRacer', text: 'Absolutely stunning! Where is this?', timestamp: Date.now() - 6900000 }
                    ]
                },
                {
                    id: 'mock-3',
                    username: 'UrbanDriver',
                    text: 'City traffic was crazy today but found a great new route through downtown! Saved 15 minutes on my commute.',
                    photos: [],
                    timestamp: Date.now() - 14400000,
                    likes: 5,
                    liked: true,
                    comments: []
                }
            ];
        }
        
        function generateFriendsRoutePosts() {
            const friendsRoutes = JSON.parse(localStorage.getItem('friendsRoutes') || '[]');
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            
            // Convert friends routes to post format
            const routePosts = friendsRoutes.map(route => ({
                id: `route-${route.id}`,
                username: route.username || 'Friend',
                text: `🗺️ Shared a new route: "${route.name}" - ${route.distance.toFixed(1)} miles in ${route.duration} minutes`,
                photos: route.photos || [],
                timestamp: route.timestamp || Date.now() - Math.random() * 86400000, // Random time in last 24 hours
                likes: Math.floor(Math.random() * 20) + 5,
                liked: false,
                comments: [],
                type: 'route',
                routeData: route
            }));
            
            // Convert live friends to route posts
            const livePosts = Object.values(liveData)
                .filter(friend => friend.userId !== currentUser.username && friend.status === 'driving')
                .map(friend => ({
                    id: `live-${friend.userId}-${Date.now()}`,
                    username: friend.userId,
                    text: `🔴 Currently driving live! ${friend.speed || 0} mph - ${friend.distance || 0} miles traveled`,
                    photos: [],
                    timestamp: Date.now() - Math.random() * 3600000, // Random time in last hour
                    likes: Math.floor(Math.random() * 15) + 3,
                    liked: false,
                    comments: [],
                    type: 'live',
                    liveData: friend
                }));
            
            return [...routePosts, ...livePosts];
        }

        function loadFeed() {
            const userPosts = JSON.parse(localStorage.getItem('posts') || '[]');
            const mockPosts = generateMockPosts();
            const friendsRoutes = generateFriendsRoutePosts();
            const allPosts = [...userPosts, ...mockPosts, ...friendsRoutes].sort((a, b) => b.timestamp - a.timestamp);

            const feedContainer = document.getElementById('feedPosts');
            if (!feedContainer) return;

            feedContainer.innerHTML = allPosts.map(post => {
                const comments = post.comments || [];
                const commentCount = comments.length;
                const isRoutePost = post.type === 'route';
                const isLivePost = post.type === 'live';
                
                return `
                <div class="feed-post ${isRoutePost ? 'route-post' : ''} ${isLivePost ? 'live-post' : ''}" id="post-${post.id}">
                    <div class="post-header">
                        <div class="post-avatar">${post.username.charAt(0).toUpperCase()}</div>
                        <div class="post-info">
                            <div class="post-username">${post.username}</div>
                            <div class="post-time">${formatPostTime(post.timestamp)}</div>
                        </div>
                        ${isRoutePost ? `
                            <div class="post-type-badge route-badge">🗺️ Route</div>
                        ` : isLivePost ? `
                            <div class="post-type-badge live-badge">🔴 Live</div>
                        ` : ''}
                        ${post.username === 'You' ? `
                            <button class="post-delete-btn" onclick="deletePost('${post.id}')" title="Delete Post">
                                ×
                            </button>
                        ` : ''}
                    </div>
                    
                    ${post.text ? `<div class="post-content">${post.text}</div>` : ''}
                    
                    ${isRoutePost && post.routeData ? `
                        <div class="route-info">
                            <div class="route-stats">
                                <div class="route-stat">
                                    <span class="stat-icon">📏</span>
                                    <span class="stat-value">${post.routeData.distance.toFixed(1)} mi</span>
                                </div>
                                <div class="route-stat">
                                    <span class="stat-icon">⏱️</span>
                                    <span class="stat-value">${post.routeData.duration} min</span>
                                </div>
                                <div class="route-stat">
                                    <span class="stat-icon">🚗</span>
                                    <span class="stat-value">${post.routeData.avgSpeed || 0} mph</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="viewRoute('${post.routeData.id}')" style="margin-top: 0.5rem;">
                                View Route Details
                            </button>
                        </div>
                    ` : ''}
                    
                    ${isLivePost && post.liveData ? `
                        <div class="live-info">
                            <div class="live-stats">
                                <div class="live-stat">
                                    <span class="stat-icon">🚗</span>
                                    <span class="stat-value">${post.liveData.speed || 0} mph</span>
                                </div>
                                <div class="live-stat">
                                    <span class="stat-icon">📍</span>
                                    <span class="stat-value">${post.liveData.distance || 0} mi</span>
                                </div>
                                <div class="live-stat">
                                    <span class="stat-icon">🕐</span>
                                    <span class="stat-value">${post.liveData.duration || '0:00'}</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="followFriend('${post.liveData.userId}')" style="margin-top: 0.5rem;">
                                Follow Live
                            </button>
                        </div>
                    ` : ''}
                    
                    ${post.photos && post.photos.length > 0 ? `
                        <div class="post-photos">
                            ${post.photos.map(photo => `
                                <div class="post-photo" onclick="openPhotoModal('${photo.data}')">
                                    <img src="${photo.data}" alt="Post photo">
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="post-actions">
                        <button class="post-action ${post.liked ? 'liked' : ''}" onclick="toggleLike('${post.id}')" id="like-btn-${post.id}">
                            <span>${post.liked ? '❤️' : '🤍'}</span>
                            <span>${post.likes} ${post.likes === 1 ? 'like' : 'likes'}</span>
                        </button>
                        <button class="post-action" onclick="toggleComments('${post.id}')">
                            <span>💬</span>
                            <span>${commentCount} ${commentCount === 1 ? 'comment' : 'comments'}</span>
                        </button>
                        <button class="post-action" onclick="sharePost('${post.id}')">
                            <span>📤</span>
                            <span>Share</span>
                        </button>
                    </div>
                    
                    <div class="comments-section hidden" id="comments-${post.id}">
                        ${commentCount > 0 ? `
                            <div class="comments-list">
                                ${comments.map(comment => `
                                    <div class="comment">
                                        <div class="comment-avatar">${comment.username.charAt(0).toUpperCase()}</div>
                                        <div class="comment-content">
                                            <div class="comment-header">
                                                <span class="comment-username">${comment.username}</span>
                                                <span class="comment-time">${formatPostTime(comment.timestamp)}</span>
                                            </div>
                                            <div class="comment-text">${comment.text}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="comment-input-section">
                            <div class="comment-avatar">Y</div>
                            <div class="comment-input-wrapper">
                                <textarea 
                                    class="comment-input" 
                                    placeholder="Write a comment..." 
                                    id="comment-input-${post.id}"
                                    rows="1"
                                    onkeydown="handleCommentKeydown(event, '${post.id}')"
                                    oninput="autoResizeTextarea(this)"
                                ></textarea>
                                <button 
                                    class="comment-submit" 
                                    onclick="submitComment('${post.id}')"
                                    id="comment-submit-${post.id}"
                                    disabled
                                >
                                    ➤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Add event listeners for comment inputs
            allPosts.forEach(post => {
                const input = document.getElementById(`comment-input-${post.id}`);
                if (input) {
                    input.addEventListener('input', () => {
                        const submitBtn = document.getElementById(`comment-submit-${post.id}`);
                        submitBtn.disabled = !input.value.trim();
                    });
                }
            });
        }

        function formatPostTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        function toggleLike(postId) {
            const likeBtn = document.getElementById(`like-btn-${postId}`);
            if (!likeBtn) return;

            // Add animation
            likeBtn.classList.add('like-animation');
            setTimeout(() => likeBtn.classList.remove('like-animation'), 600);

            // Update like state in localStorage for user posts
            const userPosts = JSON.parse(localStorage.getItem('posts') || '[]');
            const userPost = userPosts.find(post => post.id == postId);
            
            if (userPost) {
                userPost.liked = !userPost.liked;
                userPost.likes += userPost.liked ? 1 : -1;
                localStorage.setItem('posts', JSON.stringify(userPosts));
            } else {
                // For mock posts, just update the UI temporarily
                const isLiked = likeBtn.classList.contains('liked');
                const heartSpan = likeBtn.querySelector('span:first-child');
                const countSpan = likeBtn.querySelector('span:last-child');
                
                if (isLiked) {
                    likeBtn.classList.remove('liked');
                    heartSpan.textContent = '🤍';
                    const currentCount = parseInt(countSpan.textContent);
                    const newCount = currentCount - 1;
                    countSpan.textContent = `${newCount} ${newCount === 1 ? 'like' : 'likes'}`;
                } else {
                    likeBtn.classList.add('liked');
                    heartSpan.textContent = '❤️';
                    const currentCount = parseInt(countSpan.textContent);
                    const newCount = currentCount + 1;
                    countSpan.textContent = `${newCount} ${newCount === 1 ? 'like' : 'likes'}`;
                }
            }
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (!commentsSection) return;

            commentsSection.classList.toggle('hidden');
            
            // Focus on comment input when opened
            if (!commentsSection.classList.contains('hidden')) {
                const commentInput = document.getElementById(`comment-input-${postId}`);
                if (commentInput) {
                    setTimeout(() => commentInput.focus(), 100);
                }
            }
        }

        function submitComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const submitBtn = document.getElementById(`comment-submit-${postId}`);
            
            if (!input || !submitBtn) return;
            
            const commentText = input.value.trim();
            if (!commentText) return;

            const newComment = {
                id: Date.now() + Math.random(),
                username: 'You',
                text: commentText,
                timestamp: Date.now()
            };

            // Update user posts in localStorage
            const userPosts = JSON.parse(localStorage.getItem('posts') || '[]');
            const userPost = userPosts.find(post => post.id == postId);
            
            if (userPost) {
                if (!userPost.comments) userPost.comments = [];
                userPost.comments.push(newComment);
                localStorage.setItem('posts', JSON.stringify(userPosts));
                loadFeed(); // Reload to show new comment
            } else {
                // For mock posts, add comment dynamically
                const commentsSection = document.getElementById(`comments-${postId}`);
                const commentsList = commentsSection.querySelector('.comments-list');
                
                const commentHTML = `
                    <div class="comment">
                        <div class="comment-avatar">Y</div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-username">You</span>
                                <span class="comment-time">Just now</span>
                            </div>
                            <div class="comment-text">${commentText}</div>
                        </div>
                    </div>
                `;
                
                if (commentsList) {
                    commentsList.insertAdjacentHTML('beforeend', commentHTML);
                } else {
                    const newCommentsList = document.createElement('div');
                    newCommentsList.className = 'comments-list';
                    newCommentsList.innerHTML = commentHTML;
                    commentsSection.insertBefore(newCommentsList, commentsSection.querySelector('.comment-input-section'));
                }

                // Update comment count
                const commentBtn = document.querySelector(`#post-${postId} .post-action:nth-child(2) span:last-child`);
                if (commentBtn) {
                    const currentCount = parseInt(commentBtn.textContent);
                    const newCount = currentCount + 1;
                    commentBtn.textContent = `${newCount} ${newCount === 1 ? 'comment' : 'comments'}`;
                }
            }

            // Reset input
            input.value = '';
            submitBtn.disabled = true;
            autoResizeTextarea(input);
        }

        function handleCommentKeydown(event, postId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                submitComment(postId);
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function sharePost(postId) {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this drive!',
                    text: 'Awesome driving post from DriveSphere',
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Link copied to clipboard!');
                }).catch(() => {
                    alert('Sharing not supported on this device');
                });
            }
        }

        function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
            }

            // Get user posts from localStorage
            let userPosts = JSON.parse(localStorage.getItem('posts') || '[]');
            
            // Find and remove the post
            const postIndex = userPosts.findIndex(post => post.id == postId);
            if (postIndex === -1) {
                alert('Post not found or you don\'t have permission to delete it.');
                return;
            }

            // Remove post with animation
            const postElement = document.getElementById(`post-${postId}`);
            if (postElement) {
                postElement.style.transition = 'all 0.3s ease';
                postElement.style.transform = 'translateX(-100%)';
                postElement.style.opacity = '0';
                
                setTimeout(() => {
                    // Remove from localStorage
                    userPosts.splice(postIndex, 1);
                    localStorage.setItem('posts', JSON.stringify(userPosts));
                    
                    // Reload feed to reflect changes
                    loadFeed();
                }, 300);
            } else {
                // Direct removal if element not found
                userPosts.splice(postIndex, 1);
                localStorage.setItem('posts', JSON.stringify(userPosts));
                loadFeed();
            }
        }

        function openPhotoModal(photoData) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
                <img src="${photoData}" alt="Full size photo">
                <button class="photo-modal-close" onclick="this.parentElement.remove()">×</button>
            `;
            document.body.appendChild(modal);

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Advanced GPS and Mapping Features
        function toggleMapLayer(layerType) {
            const btn = document.getElementById(layerType + 'Btn');
            
            // Remove all active layers first
            document.querySelectorAll('.map-controls .btn').forEach(b => b.classList.remove('active'));
            
            if (mapLayers.currentLayer === layerType) {
                // Toggle off
                if (mapLayers[layerType]) {
                    map.removeLayer(mapLayers[layerType]);
                }
                mapLayers.currentLayer = 'standard';
            } else {
                // Remove current layer
                if (mapLayers[mapLayers.currentLayer]) {
                    map.removeLayer(mapLayers[mapLayers.currentLayer]);
                }
                
                // Add new layer
                if (layerType === 'traffic') {
                    // Simulate traffic layer (in real app, use Google Maps Traffic API or similar)
                    mapLayers.traffic = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors (Traffic simulation)'
                    });
                    map.addLayer(mapLayers.traffic);
                    showTrafficSimulation();
                } else if (layerType === 'satellite') {
                    mapLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri'
                    });
                    map.addLayer(mapLayers.satellite);
                } else if (layerType === 'terrain') {
                    mapLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenTopoMap'
                    });
                    map.addLayer(mapLayers.terrain);
                }
                
                mapLayers.currentLayer = layerType;
                btn.classList.add('active');
            }
        }

        function showTrafficSimulation() {
            // Simulate traffic data with colored route overlays
            if (currentPosition) {
                const lat = currentPosition.coords.latitude;
                const lng = currentPosition.coords.longitude;
                
                // Add some simulated traffic routes
                const trafficRoutes = [
                    {
                        coords: [[lat + 0.01, lng], [lat + 0.01, lng + 0.01], [lat, lng + 0.01]],
                        color: '#22c55e', // Green - light traffic
                        weight: 8
                    },
                    {
                        coords: [[lat - 0.005, lng], [lat - 0.005, lng - 0.01], [lat, lng - 0.01]],
                        color: '#f59e0b', // Yellow - moderate traffic  
                        weight: 8
                    },
                    {
                        coords: [[lat + 0.005, lng - 0.005], [lat + 0.015, lng - 0.005]],
                        color: '#ef4444', // Red - heavy traffic
                        weight: 8
                    }
                ];
                
                trafficRoutes.forEach(route => {
                    L.polyline(route.coords, {
                        color: route.color,
                        weight: route.weight,
                        opacity: 0.7
                    }).addTo(map);
                });
            }
        }

        function showNearbyPOI() {
            if (!currentPosition) return;
            
            const btn = document.getElementById('poiBtn');
            if (btn.classList.contains('active')) {
                // Remove POI markers
                poiMarkers.forEach(marker => map.removeLayer(marker));
                poiMarkers = [];
                btn.classList.remove('active');
                return;
            }
            
            const lat = currentPosition.coords.latitude;
            const lng = currentPosition.coords.longitude;
            
            // Simulate nearby POIs
            const pois = [
                { lat: lat + 0.003, lng: lng + 0.002, name: 'Gas Station', type: '⛽', distance: '0.2 mi' },
                { lat: lat - 0.004, lng: lng + 0.003, name: 'Restaurant', type: '🍔', distance: '0.3 mi' },
                { lat: lat + 0.006, lng: lng - 0.002, name: 'Hospital', type: '🏥', distance: '0.4 mi' },
                { lat: lat - 0.002, lng: lng - 0.004, name: 'Parking', type: '🅿️', distance: '0.1 mi' },
                { lat: lat + 0.008, lng: lng + 0.005, name: 'Hotel', type: '🏨', distance: '0.6 mi' }
            ];
            
            pois.forEach(poi => {
                const marker = L.marker([poi.lat, poi.lng], {
                    icon: L.divIcon({
                        className: 'poi-marker',
                        html: poi.type,
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <div class="poi-popup">
                        <strong>${poi.name}</strong><br>
                        Distance: ${poi.distance}
                    </div>
                `);
                
                poiMarkers.push(marker);
            });
            
            btn.classList.add('active');
        }

        function toggleRouteComparison() {
            if (routeComparison.active) {
                closeRouteComparison();
                return;
            }
            
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            if (routes.length < 2) {
                alert('You need at least 2 saved routes to compare!');
                return;
            }
            
            showRouteComparisonModal(routes);
        }

        function showRouteComparisonModal(routes) {
            const modal = document.createElement('div');
            modal.className = 'route-comparison-modal';
            modal.innerHTML = `
                <div class="route-comparison-content">
                    <h3 style="color: #f1f5f9; margin-bottom: 1rem;">Compare Routes</h3>
                    <p style="color: #94a3b8; margin-bottom: 2rem;">Select two routes to compare their statistics</p>
                    
                    <div class="route-comparison-grid">
                        <div class="route-comparison-item">
                            <h4 style="color: #3b82f6; margin-bottom: 1rem;">Route 1</h4>
                            <select id="route1Select" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.3); color: #f1f5f9;">
                                <option value="">Select a route...</option>
                                ${routes.map(route => `<option value="${route.id}">${route.name} (${route.distance} mi)</option>`).join('')}
                            </select>
                            <div id="route1Stats" class="route-stats-comparison"></div>
                        </div>
                        
                        <div class="route-comparison-item">
                            <h4 style="color: #22c55e; margin-bottom: 1rem;">Route 2</h4>
                            <select id="route2Select" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.3); color: #f1f5f9;">
                                <option value="">Select a route...</option>
                                ${routes.map(route => `<option value="${route.id}">${route.name} (${route.distance} mi)</option>`).join('')}
                            </select>
                            <div id="route2Stats" class="route-stats-comparison"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                        <button class="btn" onclick="closeRouteComparison()" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">Close</button>
                        <button class="btn" onclick="performRouteComparison()" style="background: #3b82f6; color: white; border: 1px solid #3b82f6;">Compare</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            routeComparison.active = true;
            
            // Add event listeners
            document.getElementById('route1Select').addEventListener('change', updateRoutePreview);
            document.getElementById('route2Select').addEventListener('change', updateRoutePreview);
        }

        function updateRoutePreview() {
            const route1Id = document.getElementById('route1Select').value;
            const route2Id = document.getElementById('route2Select').value;
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            
            const route1 = routes.find(r => r.id == route1Id);
            const route2 = routes.find(r => r.id == route2Id);
            
            if (route1) {
                document.getElementById('route1Stats').innerHTML = createRouteStatsDisplay(route1);
            }
            
            if (route2) {
                document.getElementById('route2Stats').innerHTML = createRouteStatsDisplay(route2);
            }
        }

        function createRouteStatsDisplay(route) {
            return `
                <div class="stat-comparison">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${route.distance}</div>
                    <div style="font-size: 0.875rem; color: #94a3b8;">Distance (mi)</div>
                </div>
                <div class="stat-comparison">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${route.duration}</div>
                    <div style="font-size: 0.875rem; color: #94a3b8;">Duration (min)</div>
                </div>
                <div class="stat-comparison">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${route.topSpeed ? Math.round(route.topSpeed * 0.621371) : 'N/A'}</div>
                    <div style="font-size: 0.875rem; color: #94a3b8;">Top Speed (mph)</div>
                </div>
            `;
        }

        function performRouteComparison() {
            const route1Id = document.getElementById('route1Select').value;
            const route2Id = document.getElementById('route2Select').value;
            
            if (!route1Id || !route2Id) {
                alert('Please select both routes to compare!');
                return;
            }
            
            if (route1Id === route2Id) {
                alert('Please select two different routes!');
                return;
            }
            
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const route1 = routes.find(r => r.id == route1Id);
            const route2 = routes.find(r => r.id == route2Id);
            
            // Update comparison with winner highlighting
            const stats1 = document.getElementById('route1Stats');
            const stats2 = document.getElementById('route2Stats');
            
            stats1.innerHTML = createComparisonStats(route1, route2, 1);
            stats2.innerHTML = createComparisonStats(route2, route1, 2);
        }

        function createComparisonStats(route, compareRoute, routeNum) {
            const distance1 = parseFloat(route.distance);
            const distance2 = parseFloat(compareRoute.distance);
            const duration1 = parseInt(route.duration);
            const duration2 = parseInt(compareRoute.duration);
            const speed1 = route.topSpeed ? Math.round(route.topSpeed * 0.621371) : 0;
            const speed2 = compareRoute.topSpeed ? Math.round(compareRoute.topSpeed * 0.621371) : 0;
            
            return `
                <div class="stat-comparison ${distance1 < distance2 ? 'better' : distance1 > distance2 ? 'worse' : ''}">
                    <div style="font-size: 1.5rem; font-weight: bold;">${route.distance}</div>
                    <div style="font-size: 0.875rem;">Distance (mi)</div>
                    ${distance1 < distance2 ? '<div style="font-size: 0.75rem; color: #22c55e;">Shorter! ✓</div>' : 
                      distance1 > distance2 ? '<div style="font-size: 0.75rem; color: #ef4444;">Longer</div>' : ''}
                </div>
                <div class="stat-comparison ${duration1 < duration2 ? 'better' : duration1 > duration2 ? 'worse' : ''}">
                    <div style="font-size: 1.5rem; font-weight: bold;">${route.duration}</div>
                    <div style="font-size: 0.875rem;">Duration (min)</div>
                    ${duration1 < duration2 ? '<div style="font-size: 0.75rem; color: #22c55e;">Faster! ✓</div>' : 
                      duration1 > duration2 ? '<div style="font-size: 0.75rem; color: #ef4444;">Slower</div>' : ''}
                </div>
                <div class="stat-comparison ${speed1 > speed2 ? 'better' : speed1 < speed2 ? 'worse' : ''}">
                    <div style="font-size: 1.5rem; font-weight: bold;">${speed1 || 'N/A'}</div>
                    <div style="font-size: 0.875rem;">Top Speed (mph)</div>
                    ${speed1 > speed2 ? '<div style="font-size: 0.75rem; color: #22c55e;">Faster! ✓</div>' : 
                      speed1 < speed2 ? '<div style="font-size: 0.75rem; color: #ef4444;">Slower</div>' : ''}
                </div>
            `;
        }

        function closeRouteComparison() {
            const modal = document.querySelector('.route-comparison-modal');
            if (modal) {
                modal.remove();
            }
            routeComparison.active = false;
        }

        function shareCurrentRoute() {
            if (!currentRoute || currentRoute.length === 0) {
                alert('No active route to share! Start tracking first.');
                return;
            }
            
            const routeData = {
                points: currentRoute.length,
                distance: calculateTotalDistance(currentRoute).toFixed(1),
                duration: currentRoute.length > 0 ? 
                    ((currentRoute[currentRoute.length - 1].timestamp - currentRoute[0].timestamp) / 60000).toFixed(0) : 0,
                timestamp: new Date().toLocaleString()
            };
            
            const shareUrl = window.location.href + `?route=${encodeURIComponent(JSON.stringify(routeData))}`;
            
            showQRModal(shareUrl, routeData);
        }

        function showQRModal(url, routeData) {
            const modal = document.createElement('div');
            modal.className = 'qr-modal';
            modal.innerHTML = `
                <div class="qr-content">
                    <h3 style="color: #f1f5f9; margin-bottom: 1rem;">Share Your Route</h3>
                    <div class="qr-code">
                        <div style="width: 150px; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #333; font-size: 0.875rem; text-align: center;">
                            QR Code<br>${routeData.distance} mi<br>${routeData.points} points
                        </div>
                    </div>
                    <p style="color: #94a3b8; margin: 1rem 0;">Scan to view route details</p>
                    <div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; word-break: break-all; font-family: monospace; font-size: 0.75rem;">
                        ${url}
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="btn" onclick="copyToClipboard('${url}')" style="background: #3b82f6; color: white;">Copy Link</button>
                        <button class="btn" onclick="this.closest('.qr-modal').remove()" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Link copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy link');
            });
        }

        function suggestAlternativeRoute() {
            if (!currentPosition) {
                alert('Location not available for route suggestions');
                return;
            }
            
            // Simulate alternative route suggestions
            const alternatives = [
                { name: 'Scenic Route', distance: '12.3 mi', duration: '18 min', traffic: 'Light', type: 'scenic' },
                { name: 'Fastest Route', distance: '10.8 mi', duration: '15 min', traffic: 'Moderate', type: 'fast' },
                { name: 'Fuel Efficient', distance: '11.5 mi', duration: '20 min', traffic: 'Light', type: 'eco' }
            ];
            
            const modal = document.createElement('div');
            modal.className = 'route-comparison-modal';
            modal.innerHTML = `
                <div class="route-comparison-content">
                    <h3 style="color: #f1f5f9; margin-bottom: 1rem;">🔄 Alternative Routes</h3>
                    <p style="color: #94a3b8; margin-bottom: 2rem;">Based on current traffic and conditions</p>
                    
                    <div class="route-comparison-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        ${alternatives.map(route => `
                            <div class="route-comparison-item">
                                <h4 style="color: ${route.type === 'fast' ? '#22c55e' : route.type === 'scenic' ? '#3b82f6' : '#f59e0b'}; margin-bottom: 1rem;">
                                    ${route.type === 'fast' ? '⚡' : route.type === 'scenic' ? '🌲' : '🍃'} ${route.name}
                                </h4>
                                <div class="route-stats-comparison">
                                    <div class="stat-comparison">
                                        <div style="font-size: 1.2rem; font-weight: bold;">${route.distance}</div>
                                        <div style="font-size: 0.8rem;">Distance</div>
                                    </div>
                                    <div class="stat-comparison">
                                        <div style="font-size: 1.2rem; font-weight: bold;">${route.duration}</div>
                                        <div style="font-size: 0.8rem;">Duration</div>
                                    </div>
                                    <div class="stat-comparison">
                                        <div style="font-size: 1rem; font-weight: bold;">${route.traffic}</div>
                                        <div style="font-size: 0.8rem;">Traffic</div>
                                    </div>
                                </div>
                                <button class="btn" onclick="selectAlternativeRoute('${route.name}')" style="width: 100%; margin-top: 1rem; background: #3b82f6; color: white;">Select Route</button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin-top: 2rem;">
                        <button class="btn" onclick="this.closest('.route-comparison-modal').remove()" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function selectAlternativeRoute(routeName) {
            alert(`Selected: ${routeName}\nRoute guidance would start here in a full app!`);
            document.querySelector('.route-comparison-modal').remove();
        }

        // Mobile App Enhancements
        function addHapticFeedback(element, intensity = 'light') {
            element.classList.add(`haptic-${intensity}`);
            setTimeout(() => {
                element.classList.remove(`haptic-${intensity}`);
            }, 200);
        }

        function initializeSwipeGestures() {
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;
            let isSwipe = false;

            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isSwipe = false;
            });

            document.addEventListener('touchmove', (e) => {
                if (!isSwipe) {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                    
                    const diffX = Math.abs(currentX - startX);
                    const diffY = Math.abs(currentY - startY);
                    
                    if (diffX > diffY && diffX > 50) {
                        isSwipe = true;
                        if (currentX > startX) {
                            // Swipe right - go to previous page
                            handleSwipeRight();
                        } else {
                            // Swipe left - go to next page
                            handleSwipeLeft();
                        }
                    }
                }
            });
        }

        function handleSwipeRight() {
            const pages = ['dashboard', 'routes', 'analytics', 'feed', 'profile'];
            const currentPage = document.querySelector('.page:not(.hidden)').id;
            const currentIndex = pages.indexOf(currentPage);
            
            if (currentIndex > 0) {
                showPage(pages[currentIndex - 1]);
                addHapticFeedback(document.body, 'light');
            }
        }

        function handleSwipeLeft() {
            const pages = ['dashboard', 'routes', 'analytics', 'feed', 'profile'];
            const currentPage = document.querySelector('.page:not(.hidden)').id;
            const currentIndex = pages.indexOf(currentPage);
            
            if (currentIndex < pages.length - 1) {
                showPage(pages[currentIndex + 1]);
                addHapticFeedback(document.body, 'light');
            }
        }

        function initializePullToRefresh() {
            let startY = 0;
            let currentY = 0;
            let isPulling = false;
            const pullIndicator = document.createElement('div');
            pullIndicator.className = 'pull-indicator';
            pullIndicator.textContent = 'Pull to refresh';
            document.body.appendChild(pullIndicator);

            document.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    startY = e.touches[0].clientY;
                    isPulling = true;
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (isPulling && window.scrollY === 0) {
                    currentY = e.touches[0].clientY;
                    const pullDistance = currentY - startY;
                    
                    if (pullDistance > 0) {
                        pullIndicator.style.top = `${Math.min(pullDistance - 60, 0)}px`;
                        
                        if (pullDistance > 100) {
                            pullIndicator.textContent = 'Release to refresh';
                            pullIndicator.classList.add('show');
                        } else {
                            pullIndicator.textContent = 'Pull to refresh';
                            pullIndicator.classList.remove('show');
                        }
                    }
                }
            });

            document.addEventListener('touchend', () => {
                if (isPulling) {
                    const pullDistance = currentY - startY;
                    
                    if (pullDistance > 100) {
                        refreshData();
                        addHapticFeedback(document.body, 'medium');
                    }
                    
                    pullIndicator.style.top = '-60px';
                    pullIndicator.classList.remove('show');
                    isPulling = false;
                }
            });
        }

        function refreshData() {
            // Simulate data refresh
            loadRoutes();
            loadFeed();
            updateAnalytics();
            
            // Show refresh animation
            const refreshToast = document.createElement('div');
            refreshToast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(34, 197, 94, 0.9);
                color: white;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                z-index: 1000;
                font-size: 0.875rem;
            `;
            refreshToast.textContent = 'Data refreshed!';
            document.body.appendChild(refreshToast);
            
            setTimeout(() => {
                refreshToast.remove();
            }, 2000);
        }

        // Analytics Functions
        function updateAnalytics() {
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            
            // Calculate weekly stats
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const weeklyRoutes = routes.filter(route => {
                const routeDate = new Date(route.timestamp);
                return routeDate >= weekAgo;
            });
            
            const weeklyDistance = weeklyRoutes.reduce((sum, route) => sum + parseFloat(route.distance), 0);
            const weeklyTime = weeklyRoutes.reduce((sum, route) => sum + parseInt(route.duration), 0);
            const weeklySpeed = weeklyRoutes.length > 0 ? 
                weeklyRoutes.reduce((sum, route) => sum + (route.avgSpeed || 0), 0) / weeklyRoutes.length : 0;
            
            // Update UI
            document.getElementById('weeklyDistance').textContent = weeklyDistance.toFixed(1);
            document.getElementById('weeklyTime').textContent = (weeklyTime / 60).toFixed(1);
            document.getElementById('weeklySpeed').textContent = Math.round(weeklySpeed * 0.621371);
            document.getElementById('weeklyEfficiency').textContent = calculateEfficiencyScore(weeklyRoutes);
            
            // Update speed stats
            const allSpeeds = routes.flatMap(route => route.speedData || []);
            const topSpeed = allSpeeds.length > 0 ? Math.max(...allSpeeds) * 0.621371 : 0;
            const avgSpeed = allSpeeds.length > 0 ? 
                allSpeeds.reduce((sum, speed) => sum + speed, 0) / allSpeeds.length * 0.621371 : 0;
            
            document.getElementById('topSpeed').textContent = Math.round(topSpeed);
            document.getElementById('avgSpeed').textContent = Math.round(avgSpeed);
            document.getElementById('speedConsistency').textContent = calculateSpeedConsistency(allSpeeds);
            
            // Update insights
            updateDrivingInsights(routes);
            drawSpeedChart(allSpeeds);
        }

        function calculateEfficiencyScore(routes) {
            if (routes.length === 0) return 0;
            
            let score = 0;
            routes.forEach(route => {
                const distance = parseFloat(route.distance);
                const duration = parseInt(route.duration);
                const avgSpeed = route.avgSpeed || 0;
                
                // Base score from average speed efficiency
                score += Math.min(avgSpeed * 0.621371 / 60, 1) * 40;
                
                // Bonus for longer routes
                score += Math.min(distance / 50, 1) * 30;
                
                // Bonus for consistent speed
                const speedConsistency = calculateSpeedConsistency(route.speedData || []);
                score += speedConsistency * 30;
            });
            
            return Math.round(score / routes.length);
        }

        function calculateSpeedConsistency(speeds) {
            if (speeds.length < 2) return 0;
            
            const avg = speeds.reduce((sum, speed) => sum + speed, 0) / speeds.length;
            const variance = speeds.reduce((sum, speed) => sum + Math.pow(speed - avg, 2), 0) / speeds.length;
            const stdDev = Math.sqrt(variance);
            
            // Return consistency as percentage (lower std dev = higher consistency)
            return Math.max(0, 100 - (stdDev / avg) * 100);
        }

        function updateDrivingInsights(routes) {
            if (routes.length === 0) return;
            
            // Find best route
            const bestRoute = routes.reduce((best, route) => {
                const efficiency = calculateEfficiencyScore([route]);
                const bestEfficiency = calculateEfficiencyScore([best]);
                return efficiency > bestEfficiency ? route : best;
            });
            
            document.getElementById('bestRoute').textContent = 
                `${bestRoute.name} - ${bestRoute.distance} mi in ${bestRoute.duration} min`;
            
            // Calculate peak driving time
            const hourCounts = {};
            routes.forEach(route => {
                const hour = new Date(route.timestamp).getHours();
                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            });
            
            const peakHour = Object.keys(hourCounts).reduce((a, b) => 
                hourCounts[a] > hourCounts[b] ? a : b
            );
            
            document.getElementById('peakTime').textContent = 
                `${peakHour}:00 - ${parseInt(peakHour) + 1}:00`;
            
            // Update eco score
            const ecoScore = calculateEfficiencyScore(routes);
            document.getElementById('ecoscore').textContent = `${ecoScore}/100`;
            
            // Update route variety
            const uniqueRoutes = new Set(routes.map(route => route.name)).size;
            document.getElementById('routeVariety').textContent = `${uniqueRoutes} unique routes`;
        }

        function drawSpeedChart(speeds) {
            const canvas = document.getElementById('speedChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            if (speeds.length === 0) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No speed data available', width / 2, height / 2);
                return;
            }
            
            // Sample data for visualization
            const sampleSize = Math.min(speeds.length, 50);
            const step = Math.floor(speeds.length / sampleSize);
            const sampledSpeeds = speeds.filter((_, index) => index % step === 0).slice(0, sampleSize);
            
            const maxSpeed = Math.max(...sampledSpeeds) * 0.621371;
            const minSpeed = Math.min(...sampledSpeeds) * 0.621371;
            const range = maxSpeed - minSpeed || 1;
            
            // Draw chart
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            sampledSpeeds.forEach((speed, index) => {
                const x = (index / (sampledSpeeds.length - 1)) * width;
                const y = height - ((speed * 0.621371 - minSpeed) / range) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw grid lines
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (i / 4) * height;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
        }

        function showLeaderboard(type) {
            // Remove active class from all tabs
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Update leaderboard content based on type
            const leaderboard = document.getElementById('distanceLeaderboard');
            
            if (type === 'speed') {
                leaderboard.innerHTML = `
                    <div class="leaderboard-item">
                        <div class="rank">1</div>
                        <div class="player-info">
                            <div class="player-name">SpeedDemon</div>
                            <div class="player-stats">127 mph</div>
                        </div>
                        <div class="player-score">127</div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank">2</div>
                        <div class="player-info">
                            <div class="player-name">FastLane</div>
                            <div class="player-stats">115 mph</div>
                        </div>
                        <div class="player-score">115</div>
                    </div>
                    <div class="leaderboard-item current-user">
                        <div class="rank">3</div>
                        <div class="player-info">
                            <div class="player-name">You</div>
                            <div class="player-stats">98 mph</div>
                        </div>
                        <div class="player-score">98</div>
                    </div>
                `;
            } else if (type === 'efficiency') {
                leaderboard.innerHTML = `
                    <div class="leaderboard-item">
                        <div class="rank">1</div>
                        <div class="player-info">
                            <div class="player-name">EcoDriver</div>
                            <div class="player-stats">95/100</div>
                        </div>
                        <div class="player-score">95</div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank">2</div>
                        <div class="player-info">
                            <div class="player-name">GreenMachine</div>
                            <div class="player-stats">92/100</div>
                        </div>
                        <div class="player-score">92</div>
                    </div>
                    <div class="leaderboard-item current-user">
                        <div class="rank">3</div>
                        <div class="player-info">
                            <div class="player-name">You</div>
                            <div class="player-stats">85/100</div>
                        </div>
                        <div class="player-score">85</div>
                    </div>
                `;
            } else {
                // Distance leaderboard (default)
                leaderboard.innerHTML = `
                    <div class="leaderboard-item">
                        <div class="rank">1</div>
                        <div class="player-info">
                            <div class="player-name">SpeedRacer</div>
                            <div class="player-stats">2,847 mi</div>
                        </div>
                        <div class="player-score">2,847</div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank">2</div>
                        <div class="player-info">
                            <div class="player-name">RoadWarrior</div>
                            <div class="player-stats">2,156 mi</div>
                        </div>
                        <div class="player-score">2,156</div>
                    </div>
                    <div class="leaderboard-item current-user">
                        <div class="rank">3</div>
                        <div class="player-info">
                            <div class="player-name">You</div>
                            <div class="player-stats">1,892 mi</div>
                        </div>
                        <div class="player-score">1,892</div>
                    </div>
                `;
            }
        }

        // Social Simulation Features
        function simulateSocialUpdates() {
            // Clear existing intervals
            clearSocialIntervals();
            
            // Simulate new posts from friends
            socialInterval = setInterval(() => {
                if (Math.random() < 0.3) { // 30% chance every 30 seconds
                    addMockPost();
                }
            }, 30000);

            // Simulate live leaderboard updates
            leaderboardInterval = setInterval(() => {
                updateLiveLeaderboard();
            }, 15000);
        }
        
        function clearSocialIntervals() {
            if (socialInterval) {
                clearInterval(socialInterval);
                socialInterval = null;
            }
            if (leaderboardInterval) {
                clearInterval(leaderboardInterval);
                leaderboardInterval = null;
            }
            if (gforceInterval) {
                clearInterval(gforceInterval);
                gforceInterval = null;
            }
            if (backupSettings.backupInterval) {
                clearInterval(backupSettings.backupInterval);
                backupSettings.backupInterval = null;
            }
        }

        function addMockPost() {
            const mockPost = {
                id: 'mock-' + Date.now(),
                username: getRandomFriendName(),
                text: getRandomPostText(),
                timestamp: new Date().toLocaleString(),
                photos: Math.random() > 0.7 ? [getRandomPhoto()] : [],
                likes: Math.floor(Math.random() * 20),
                comments: [],
                liked: false,
                isOwn: false
            };

            // Add to feed
            const feedContainer = document.getElementById('feedPosts');
            if (feedContainer) {
                const postElement = document.createElement('div');
                postElement.className = 'feed-post';
                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="post-avatar">${mockPost.username.charAt(0).toUpperCase()}</div>
                        <div class="post-info">
                            <div class="post-username">${mockPost.username}</div>
                            <div class="post-time">${mockPost.timestamp}</div>
                        </div>
                    </div>
                    <div class="post-content">${mockPost.text}</div>
                    ${mockPost.photos.length > 0 ? `
                        <div class="post-photos">
                            ${mockPost.photos.map(photo => `
                                <img src="${photo}" alt="Post photo" class="post-photo" onclick="openPhotoModal('${photo}')">
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="post-actions">
                        <button class="post-action" onclick="toggleLike('${mockPost.id}')">
                            ❤️ ${mockPost.likes}
                        </button>
                        <button class="post-action" onclick="toggleComments('${mockPost.id}')">
                            💬 ${mockPost.comments.length}
                        </button>
                        <button class="post-action" onclick="sharePost('${mockPost.id}')">
                            📤 Share
                        </button>
                    </div>
                    <div class="comments-section" id="comments-${mockPost.id}" style="display: none;">
                        <div class="comments-list"></div>
                        <div class="comment-input">
                            <textarea placeholder="Add a comment..." onkeydown="handleCommentKeydown(event, '${mockPost.id}')"></textarea>
                            <button onclick="submitComment('${mockPost.id}')">Post</button>
                        </div>
                    </div>
                `;
                feedContainer.insertBefore(postElement, feedContainer.firstChild);
            }
        }

        function getRandomFriendName() {
            const names = ['SpeedRacer', 'RoadWarrior', 'UrbanDriver', 'HighwayHero', 'CityCruiser', 'FastLane', 'EcoDriver'];
            return names[Math.floor(Math.random() * names.length)];
        }

        function getRandomPostText() {
            const texts = [
                "Just completed an amazing 45-mile drive through the mountains! 🏔️",
                "New personal best: 127 mph on the highway! 🚀",
                "Found this beautiful scenic route today - perfect for a Sunday drive 🌅",
                "Eco-driving mode activated! 95% efficiency score today 🌱",
                "Traffic was terrible but made it through with some great music 🎵",
                "Early morning drive before sunrise - so peaceful 🌅",
                "Just hit 1000 miles this month! Road warrior status unlocked 🏆",
                "Beautiful sunset drive along the coast 🌊",
                "New route discovered - 12 miles in 15 minutes! ⚡",
                "Driving in the rain today - extra careful and safe ☔"
            ];
            return texts[Math.floor(Math.random() * texts.length)];
        }

        function getRandomPhoto() {
            // Return a placeholder image
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkRyaXZpbmcgUGhvdG88L3RleHQ+PC9zdmc+';
        }

        function updateLiveLeaderboard() {
            // Simulate live leaderboard updates
            const leaderboardItems = document.querySelectorAll('.leaderboard-item');
            leaderboardItems.forEach(item => {
                const scoreElement = item.querySelector('.player-score');
                if (scoreElement && !item.classList.contains('current-user')) {
                    const currentScore = parseInt(scoreElement.textContent.replace(/,/g, ''));
                    const change = Math.floor(Math.random() * 20) - 10; // -10 to +10
                    const newScore = Math.max(0, currentScore + change);
                    scoreElement.textContent = newScore.toLocaleString();
                }
            });
        }

        // Scroll animations
        function initializeScrollAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                    }
                });
            }, observerOptions);

            // Add reveal class to cards and observe them
            document.querySelectorAll('.card, .status-item, .route-card').forEach(el => {
                el.classList.add('reveal');
                observer.observe(el);
            });
        }

        // Floating effects removed for cleaner UI
        function addFloatingEffects() {
            // Function disabled - floating effects removed
        }

        // Add glow effects on hover
        function addGlowEffects() {
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.classList.add('glow');
                });
                btn.addEventListener('mouseleave', () => {
                    btn.classList.remove('glow');
                });
            });

            document.querySelectorAll('.status-item').forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.classList.add('glow');
                });
                item.addEventListener('mouseleave', () => {
                    item.classList.remove('glow');
                });
            });
        }

        // Accelerometer Functions
        function initializeAccelerometer() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            startAccelerometer();
                        } else {
                            console.log('Accelerometer permission denied');
                            showAccelerometerFallback();
                        }
                    })
                    .catch(console.error);
            } else if (typeof DeviceMotionEvent !== 'undefined') {
                // Android and older iOS
                startAccelerometer();
            } else {
                console.log('Accelerometer not supported');
                showAccelerometerFallback();
            }
        }

        function startAccelerometer() {
            accelerometerData.isSupported = true;
            
            window.addEventListener('devicemotion', handleMotionEvent);
            
            // Add G-force display to dashboard
            addGForceDisplay();
            
            console.log('Accelerometer started successfully');
        }

        function handleMotionEvent(event) {
            const acceleration = event.accelerationIncludingGravity;
            
            if (acceleration) {
                accelerometerData.x = acceleration.x || 0;
                accelerometerData.y = acceleration.y || 0;
                accelerometerData.z = acceleration.z || 0;
                
                // Calculate total G-force (excluding gravity)
                const totalG = Math.sqrt(
                    Math.pow(acceleration.x, 2) + 
                    Math.pow(acceleration.y, 2) + 
                    Math.pow(acceleration.z - 9.81, 2)
                ) / 9.81;
                
                accelerometerData.totalG = totalG;
                
                // Update max G-force
                if (totalG > maxGForce) {
                    maxGForce = totalG;
                }
                
                // Store in history
                gForceHistory.push({
                    timestamp: Date.now(),
                    gForce: totalG,
                    x: acceleration.x,
                    y: acceleration.y,
                    z: acceleration.z
                });
                
                // Keep only last 100 readings
                if (gForceHistory.length > 100) {
                    gForceHistory.shift();
                }
                
                // Update UI
                updateGForceDisplay();
                updateGForceChart();
                
                // Detect driving events
                detectDrivingEvents(totalG);
            }
        }

        function addGForceDisplay() {
            const dashboard = document.querySelector('#dashboard');
            if (dashboard) {
                const gForceCard = document.createElement('div');
                gForceCard.className = 'card';
                gForceCard.innerHTML = `
                    <h3 class="card-title">🚀 G-Force Monitor</h3>
                    <div class="gforce-container">
                        <div class="gforce-main">
                            <div class="gforce-value" id="currentGForce">0.00</div>
                            <div class="gforce-label">Current G-Force</div>
                        </div>
                        <div class="gforce-stats">
                            <div class="gforce-stat">
                                <div class="gforce-stat-value" id="maxGForce">0.00</div>
                                <div class="gforce-stat-label">Max G-Force</div>
                            </div>
                            <div class="gforce-stat">
                                <div class="gforce-stat-value" id="avgGForce">0.00</div>
                                <div class="gforce-stat-label">Average G-Force</div>
                            </div>
                        </div>
                        <div class="gforce-chart">
                            <canvas id="gForceChart" width="300" height="100"></canvas>
                        </div>
                        <div class="gforce-axes">
                            <div class="gforce-axis">
                                <span>X: <span id="gForceX">0.00</span></span>
                                <span>Y: <span id="gForceY">0.00</span></span>
                                <span>Z: <span id="gForceZ">0.00</span></span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Insert after the first card
                const firstCard = dashboard.querySelector('.card');
                if (firstCard) {
                    firstCard.insertAdjacentElement('afterend', gForceCard);
                }
            }
        }

        function updateGForceDisplay() {
            const currentGElement = document.getElementById('currentGForce');
            const maxGElement = document.getElementById('maxGForce');
            const avgGElement = document.getElementById('avgGForce');
            const xElement = document.getElementById('gForceX');
            const yElement = document.getElementById('gForceY');
            const zElement = document.getElementById('gForceZ');
            
            if (currentGElement) {
                currentGElement.textContent = accelerometerData.totalG.toFixed(2);
                
                // Color code based on G-force level
                const gForce = accelerometerData.totalG;
                if (gForce > 2.0) {
                    currentGElement.style.color = '#ef4444'; // Red - High G
                } else if (gForce > 1.5) {
                    currentGElement.style.color = '#f59e0b'; // Orange - Medium G
                } else if (gForce > 1.2) {
                    currentGElement.style.color = '#eab308'; // Yellow - Low G
                } else {
                    currentGElement.style.color = '#22c55e'; // Green - Normal
                }
            }
            
            if (maxGElement) {
                maxGElement.textContent = maxGForce.toFixed(2);
            }
            
            if (avgGElement && gForceHistory.length > 0) {
                const avgG = gForceHistory.reduce((sum, reading) => sum + reading.gForce, 0) / gForceHistory.length;
                avgGElement.textContent = avgG.toFixed(2);
            }
            
            if (xElement) {
                xElement.textContent = accelerometerData.x.toFixed(2);
            }
            if (yElement) {
                yElement.textContent = accelerometerData.y.toFixed(2);
            }
            if (zElement) {
                zElement.textContent = accelerometerData.z.toFixed(2);
            }
        }

        function updateGForceChart() {
            const canvas = document.getElementById('gForceChart');
            if (!canvas || gForceHistory.length < 2) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Get recent data (last 50 points)
            const recentData = gForceHistory.slice(-50);
            const maxG = Math.max(...recentData.map(d => d.gForce));
            const minG = Math.min(...recentData.map(d => d.gForce));
            const range = maxG - minG || 1;
            
            // Draw chart
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            recentData.forEach((point, index) => {
                const x = (index / (recentData.length - 1)) * width;
                const y = height - ((point.gForce - minG) / range) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw G-force zones
            ctx.strokeStyle = 'rgba(239, 68, 68, 0.3)';
            ctx.lineWidth = 1;
            const highGLine = height - ((2.0 - minG) / range) * height;
            ctx.beginPath();
            ctx.moveTo(0, highGLine);
            ctx.lineTo(width, highGLine);
            ctx.stroke();
            
            ctx.strokeStyle = 'rgba(34, 197, 94, 0.3)';
            const normalGLine = height - ((1.0 - minG) / range) * height;
            ctx.beginPath();
            ctx.moveTo(0, normalGLine);
            ctx.lineTo(width, normalGLine);
            ctx.stroke();
        }

        function detectDrivingEvents(gForce) {
            // Detect hard braking (negative Y acceleration)
            if (accelerometerData.y < -1.5) {
                showDrivingEvent('Hard Braking', '⚠️', '#ef4444');
            }
            
            // Detect hard acceleration (positive Y acceleration)
            if (accelerometerData.y > 1.5) {
                showDrivingEvent('Hard Acceleration', '🚀', '#f59e0b');
            }
            
            // Detect sharp turns (high X acceleration)
            if (Math.abs(accelerometerData.x) > 1.5) {
                showDrivingEvent('Sharp Turn', '🔄', '#8b5cf6');
            }
            
            // Detect high G-force events
            if (gForce > 2.0) {
                showDrivingEvent('High G-Force', '⚡', '#ef4444');
            }
        }

        function showDrivingEvent(type, icon, color) {
            // Create event notification
            const eventToast = document.createElement('div');
            eventToast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1000;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            `;
            eventToast.textContent = `${icon} ${type}`;
            document.body.appendChild(eventToast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                eventToast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => eventToast.remove(), 300);
            }, 3000);
        }

        function showAccelerometerFallback() {
            console.log('Accelerometer not available - showing desktop message');
            
            // Add desktop-friendly G-force display
            addDesktopGForceDisplay();
        }
        
        function addDesktopGForceDisplay() {
            const dashboard = document.querySelector('#dashboard');
            if (dashboard) {
                const gForceCard = document.createElement('div');
                gForceCard.className = 'card';
                gForceCard.innerHTML = `
                    <h3 class="card-title">🚀 G-Force Monitor</h3>
                    <div class="desktop-gforce-message">
                        <div class="desktop-message-icon">📱</div>
                        <div class="desktop-message-content">
                            <h4>Mobile Feature</h4>
                            <p>G-Force monitoring is available on mobile devices with accelerometer sensors.</p>
                            <p>Open this app on your phone to track acceleration forces while driving!</p>
                        </div>
                        <div class="desktop-feature-preview">
                            <div class="preview-stat">
                                <div class="preview-value">2.5G</div>
                                <div class="preview-label">Max G-Force</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-value">1.2G</div>
                                <div class="preview-label">Avg G-Force</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Insert after the first card
                const firstCard = dashboard.querySelector('.card');
                if (firstCard) {
                    firstCard.insertAdjacentElement('afterend', gForceCard);
                }
            }
        }

        // Authentication Functions
        function initializeSessionPersistence() {
            // Check if user has Remember Me enabled and session is still valid
            const userPrefs = localStorage.getItem('userPreferences');
            if (userPrefs) {
                try {
                    const preferences = JSON.parse(userPrefs);
                    if (preferences.rememberMe && preferences.lastLogin) {
                        const lastLogin = new Date(preferences.lastLogin);
                        const now = new Date();
                        const daysSinceLogin = (now - lastLogin) / (1000 * 60 * 60 * 24);
                        
                        // If it's been more than 7 days, require re-authentication
                        if (daysSinceLogin > 7) {
                            localStorage.removeItem('currentUser');
                            localStorage.removeItem('rememberMeData');
                            localStorage.removeItem('userPreferences');
                            console.log('Session expired - please log in again');
                        }
                    }
                } catch (error) {
                    console.error('Error checking session persistence:', error);
                }
            }
        }
        
        function initializeDataPersistence() {
            console.log('🔄 Initializing data persistence system...');
            
            // Load data using safe methods
            users = safeGetItem('users', []);
            playerData = safeGetItem('playerData', {
                xp: 0,
                level: 1,
                totalDistance: 0,
                totalDrives: 0,
                achievements: []
            });
            
            // Create initial backup if none exists
            if (!localStorage.getItem('driverhub_backup')) {
                console.log('🔄 Creating initial data backup...');
                createDataBackup();
            }
            
            // Start data validation
            startDataValidation();
            
            // Set up periodic backups
            setInterval(() => {
                console.log('🔄 Creating periodic backup...');
                createDataBackup();
            }, DATA_CONFIG.BACKUP_FREQUENCY);
            
            // Set up beforeunload backup
            window.addEventListener('beforeunload', () => {
                createDataBackup();
            });
            
            console.log('✅ Data persistence system initialized');
        }
        
        function checkAuthStatus() {
            const savedUser = localStorage.getItem('currentUser');
            const savedUsers = localStorage.getItem('users');
            
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
                updateUserUI();
            } else {
                // Check for Remember Me data
                checkRememberMeData();
                showAuthPages();
            }
        }
        
        function checkRememberMeData() {
            const rememberMeData = localStorage.getItem('rememberMeData');
            const userPrefs = localStorage.getItem('userPreferences');
            
            if (rememberMeData && userPrefs) {
                try {
                    const loginData = JSON.parse(rememberMeData);
                    const preferences = JSON.parse(userPrefs);
                    
                    // Check if Remember Me is still valid (within 30 days)
                    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    if (loginData.timestamp > thirtyDaysAgo && preferences.rememberMe) {
                        // Auto-fill the login form
                        document.getElementById('loginEmail').value = loginData.emailOrUsername;
                        document.getElementById('rememberMe').checked = true;
                        
                        // Show a subtle notification that form was auto-filled
                        showRememberMeNotification();
                        
                        // Optionally auto-login if user prefers
                        if (preferences.autoLogin) {
                            setTimeout(() => {
                                showAutoLoginNotification();
                                // Auto-submit the form (user still needs to enter password)
                                document.getElementById('loginPassword').focus();
                            }, 1000);
                        }
                    } else {
                        // Clear expired Remember Me data
                        localStorage.removeItem('rememberMeData');
                        localStorage.removeItem('userPreferences');
                    }
                } catch (error) {
                    console.error('Error parsing Remember Me data:', error);
                    // Clear corrupted data
                    localStorage.removeItem('rememberMeData');
                    localStorage.removeItem('userPreferences');
                }
            }
        }
        
        function showAutoLoginNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(16, 185, 129, 0.2);
            `;
            notification.innerHTML = '⚡ Just enter your password to continue';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function showRememberMeNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(59, 130, 246, 0.2);
            `;
            notification.innerHTML = '🔐 Login form auto-filled from Remember Me';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function setupAuthHandlers() {
            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            // Register form handler
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleRegister();
            });
            
            // Admin login form handler
            document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleAdminLogin();
            });
            
            // Add real-time username validation
            const usernameInput = document.getElementById('registerUsername');
            if (usernameInput) {
                let usernameTimeout;
                usernameInput.addEventListener('input', (e) => {
                    clearTimeout(usernameTimeout);
                    usernameTimeout = setTimeout(() => {
                        validateUsername(e.target.value);
                    }, 500); // Check 500ms after user stops typing
                });
                
                usernameInput.addEventListener('blur', (e) => {
                    validateUsername(e.target.value);
                });
            }
        }
        
        function validateUsername(username) {
            const validationEl = document.getElementById('usernameValidation');
            const messageEl = document.getElementById('usernameMessage');
            const submitBtn = document.getElementById('registerSubmitBtn');
            
            if (!username) {
                validationEl.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
                return;
            }
            
            validationEl.style.display = 'block';
            
            // Show checking state
            validationEl.className = 'username-validation checking';
            messageEl.textContent = 'Checking username availability...';
            
            setTimeout(() => {
                // Check format first
                if (username.length < 3) {
                    validationEl.className = 'username-validation invalid';
                    messageEl.textContent = 'Username must be at least 3 characters';
                    if (submitBtn) submitBtn.disabled = true;
                    return;
                }
                
                if (username.length > 20) {
                    validationEl.className = 'username-validation invalid';
                    messageEl.textContent = 'Username must be 20 characters or less';
                    if (submitBtn) submitBtn.disabled = true;
                    return;
                }
                
                if (!/^[A-Za-z0-9_]+$/.test(username)) {
                    validationEl.className = 'username-validation invalid';
                    messageEl.textContent = 'Username can only contain letters, numbers, and underscores';
                    if (submitBtn) submitBtn.disabled = true;
                    return;
                }
                
                // Check if username is taken
                if (users.find(u => u.username === username)) {
                    validationEl.className = 'username-validation invalid';
                    messageEl.textContent = 'Username is already taken';
                    if (submitBtn) submitBtn.disabled = true;
                    return;
                }
                
                // Username is valid and available
                validationEl.className = 'username-validation valid';
                messageEl.textContent = 'Username is available!';
                if (submitBtn) submitBtn.disabled = false;
            }, 300); // Simulate checking delay
        }

        function handleLogin() {
            const emailOrUsername = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // Check if login is by email or username
            const user = users.find(u => 
                (u.email === emailOrUsername || u.username === emailOrUsername) && 
                u.password === password
            );
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Handle Remember Me functionality
                if (rememberMe) {
                    // Store login credentials securely (in a real app, you'd encrypt this)
                    const loginData = {
                        emailOrUsername: emailOrUsername,
                        rememberMe: true,
                        timestamp: Date.now(),
                        userAgent: navigator.userAgent,
                        lastIP: 'local' // In a real app, you'd get this from the server
                    };
                    localStorage.setItem('rememberMeData', JSON.stringify(loginData));
                    
                    // Store user preferences
                    const userPrefs = {
                        rememberMe: true,
                        lastLogin: new Date().toISOString(),
                        autoLogin: true,
                        sessionId: generateSessionId()
                    };
                    localStorage.setItem('userPreferences', JSON.stringify(userPrefs));
                    
                    // Show Remember Me success notification
                    showRememberMeSuccessNotification();
                } else {
                    // Clear Remember Me data if unchecked
                    localStorage.removeItem('rememberMeData');
                    localStorage.removeItem('userPreferences');
                }
                
                showLoginSuccess();
                setTimeout(() => {
                    showMainApp();
                    initializeApp();
                    updateUserUI();
                }, 1500);
            } else {
                showAuthError('Invalid email/username or password');
            }
        }
        
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function showRememberMeSuccessNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(16, 185, 129, 0.2);
            `;
            notification.innerHTML = '🔐 Remember Me enabled - you\'ll stay logged in';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function handleRegister() {
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate username format
            if (!username || username.length < 3 || username.length > 20) {
                showAuthError('Username must be 3-20 characters long');
                return;
            }
            
            if (!/^[A-Za-z0-9_]+$/.test(username)) {
                showAuthError('Username can only contain letters, numbers, and underscores');
                return;
            }
            
            // Check if username is already taken
            if (users.find(u => u.username === username)) {
                showAuthError('Username is already taken');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthError('Passwords do not match');
                return;
            }
            
            if (users.find(u => u.email === email)) {
                showAuthError('Email already exists');
                return;
            }
            
            const newUser = {
                id: Date.now().toString(),
                name: name,
                username: username,
                email: email,
                password: password,
                role: 'user',
                joinDate: new Date().toISOString(),
                isActive: true
            };
            
            users.push(newUser);
            try {
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                currentUser = newUser;
            } catch (error) {
                console.error('Failed to save user data:', error);
                if (error.name === 'QuotaExceededError') {
                    showStorageQuotaError();
                    return;
                }
            }
            
            showRegisterSuccess();
            setTimeout(() => {
                showMainApp();
                initializeApp();
                updateUserUI();
            }, 1500);
        }

        function handleAdminLogin() {
            const adminKey = document.getElementById('adminKey').value;
            
            if (adminKey === ADMIN_KEY) {
                const adminUser = {
                    id: 'admin',
                    name: 'Administrator',
                    email: 'admin@driverhub.com',
                    role: 'admin',
                    joinDate: new Date().toISOString(),
                    isActive: true
                };
                
                currentUser = adminUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                closeAdminModal();
                showLoginSuccess();
                setTimeout(() => {
                    showMainApp();
                    initializeApp();
                    updateUserUI();
                }, 1500);
            } else {
                showAuthError('Invalid admin key');
            }
        }

        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('mainNavbar').style.display = 'block';
        }

        function showAuthPages() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('mainNavbar').style.display = 'none';
        }

        function updateUserUI() {
            if (currentUser) {
                document.getElementById('userDisplayName').textContent = currentUser.username || currentUser.name;
                
                // Update profile page
                document.getElementById('profileName').textContent = currentUser.name;
                document.getElementById('profileUsername').textContent = currentUser.username || 'Not set';
                document.getElementById('profileEmail').textContent = currentUser.email;
                const roleElement = document.getElementById('profileRole');
                roleElement.textContent = currentUser.role === 'admin' ? 'Administrator' : 'Driver';
                roleElement.className = currentUser.role === 'admin' ? 'role-badge admin' : 'role-badge';
                
                // Show admin link if admin
                if (currentUser.role === 'admin') {
                    document.getElementById('adminLink').style.display = 'block';
                }
                
                // Update profile stats
                document.getElementById('profileMiles').innerHTML = `${Math.round(playerData.totalDistance)}<span class="status-unit">mi</span>`;
                document.getElementById('profileLevel').textContent = playerData.level;
                document.getElementById('profileXP').innerHTML = `${playerData.xp}<span class="status-unit">XP</span>`;
            }
        }

        function logout() {
            // Clear intervals to prevent memory leaks
            clearSocialIntervals();
            
            // Clear localStorage
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            // Clear Remember Me data on logout
            localStorage.removeItem('rememberMeData');
            localStorage.removeItem('userPreferences');
            
            // Show auth pages
            showAuthPages();
            switchToLogin();
        }

        function switchToLogin() {
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('registerPage').classList.remove('active');
        }

        function switchToRegister() {
            document.getElementById('registerPage').classList.add('active');
            document.getElementById('loginPage').classList.remove('active');
        }

        function adminLogin() {
            document.getElementById('adminModal').classList.remove('hidden');
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.add('hidden');
            document.getElementById('adminKey').value = '';
        }

        function showProfile() {
            showPage('profile');
        }

        function showAdminPanel() {
            if (currentUser && currentUser.role === 'admin') {
                showPage('admin');
                updateAdminPanel();
            }
        }

        function showAuthError(message) {
            const errorToast = document.createElement('div');
            errorToast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
            `;
            errorToast.textContent = message;
            document.body.appendChild(errorToast);
            
            setTimeout(() => {
                errorToast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => errorToast.remove(), 300);
            }, 3000);
        }

        function showLoginSuccess() {
            const successToast = document.createElement('div');
            successToast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            `;
            successToast.textContent = 'Welcome to DriveSphere! 🚗';
            document.body.appendChild(successToast);
            
            setTimeout(() => {
                successToast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => successToast.remove(), 300);
            }, 1500);
        }

        function showRegisterSuccess() {
            const successToast = document.createElement('div');
            successToast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            `;
            successToast.textContent = 'Account created successfully! 🎉';
            document.body.appendChild(successToast);
            
            setTimeout(() => {
                successToast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => successToast.remove(), 300);
            }, 1500);
        }

        // Admin Panel Functions
        function updateAdminPanel() {
            if (currentUser && currentUser.role === 'admin') {
                // Update stats
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalRoutes').textContent = JSON.parse(localStorage.getItem('routes') || '[]').length;
                document.getElementById('totalPosts').textContent = JSON.parse(localStorage.getItem('posts') || '[]').length;
                
                // Update system info
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString();
                document.getElementById('sessionStart').textContent = sessionStart.toLocaleTimeString();
                document.getElementById('loadTime').textContent = `${performanceMetrics.loadTime.toFixed(2)}ms`;
                document.getElementById('errorsCount').textContent = performanceMetrics.errorsCount;
                document.getElementById('routesSaved').textContent = performanceMetrics.routesSaved;
                document.getElementById('lastError').textContent = performanceMetrics.lastError ? 
                    performanceMetrics.lastError.message.substring(0, 50) + '...' : 'None';
                
                // Calculate storage usage
                let totalStorage = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalStorage += localStorage[key].length;
                    }
                }
                document.getElementById('storageUsed').textContent = `${Math.round(totalStorage / 1024)} KB`;
                
                // Update user list
                updateUserList();
                
                // Update backup status
                updateBackupStatus();
            }
        }

        function updateUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <h4>${user.name}</h4>
                            <p>${user.email} • ${user.role}</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <span class="role-badge ${user.role}">${user.role}</span>
                    </div>
                `;
                userList.appendChild(userItem);
            });
        }

        function clearAllRoutes() {
            if (confirm('Are you sure you want to clear all routes? This cannot be undone.')) {
                localStorage.removeItem('routes');
                showAdminNotification('All routes cleared successfully');
                updateAdminPanel();
            }
        }

        function clearAllPosts() {
            if (confirm('Are you sure you want to clear all posts? This cannot be undone.')) {
                localStorage.removeItem('posts');
                showAdminNotification('All posts cleared successfully');
                updateAdminPanel();
            }
        }

        function exportData() {
            const data = {
                users: users,
                routes: JSON.parse(localStorage.getItem('routes') || '[]'),
                posts: JSON.parse(localStorage.getItem('posts') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `driverhub-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAdminNotification('Data exported successfully');
        }

        function resetAnalytics() {
            if (confirm('Are you sure you want to reset all analytics data? This cannot be undone.')) {
                localStorage.removeItem('playerData');
                playerData = {
                    xp: 0,
                    level: 1,
                    totalDistance: 0,
                    totalDrives: 0,
                    achievements: [],
                    dailyXP: 0,
                    weeklyXP: 0,
                    lastActive: new Date().toDateString()
                };
                savePlayerData();
                showAdminNotification('Analytics data reset successfully');
                updateAdminPanel();
            }
        }

        function showAdminNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
            `;
            notification.textContent = `⚙️ ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Enhanced Admin Functions
        function updateAdminPanel() {
            if (currentUser && currentUser.role === 'admin') {
                // Update enhanced stats
                const routes = JSON.parse(localStorage.getItem('routes') || '[]');
                const posts = JSON.parse(localStorage.getItem('posts') || '[]');
                
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalRoutes').textContent = routes.length;
                document.getElementById('totalPosts').textContent = posts.length;
                document.getElementById('activeUsers').textContent = users.filter(u => u.lastActive && new Date(u.lastActive) > new Date(Date.now() - 24 * 60 * 60 * 1000)).length;
                
                // Calculate total distance and average speed
                let totalDistance = 0;
                let totalSpeed = 0;
                let speedCount = 0;
                
                routes.forEach(route => {
                    if (route.distance) totalDistance += route.distance;
                    if (route.avgSpeed) {
                        totalSpeed += route.avgSpeed;
                        speedCount++;
                    }
                });
                
                document.getElementById('totalDistance').textContent = Math.round(totalDistance);
                document.getElementById('avgSpeed').textContent = speedCount > 0 ? Math.round(totalSpeed / speedCount) : 0;
                
                // Update system info
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString();
                document.getElementById('uptime').textContent = formatUptime(Date.now() - sessionStart);
                document.getElementById('loadTime').textContent = `${performanceMetrics.loadTime.toFixed(2)}ms`;
                document.getElementById('errorsCount').textContent = performanceMetrics.errorsCount;
                document.getElementById('routesSaved').textContent = performanceMetrics.routesSaved;
                document.getElementById('lastError').textContent = performanceMetrics.lastError ? 
                    performanceMetrics.lastError.message.substring(0, 50) + '...' : 'None';
                
                // Update browser info
                document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 50) + '...';
                document.getElementById('language').textContent = navigator.language;
                document.getElementById('platform').textContent = navigator.platform;
                
                // Calculate storage usage
                let totalStorage = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalStorage += localStorage[key].length;
                    }
                }
                document.getElementById('storageUsed').textContent = `${Math.round(totalStorage / 1024)} KB`;
                document.getElementById('storageUsage').textContent = `${Math.round((totalStorage / (5 * 1024 * 1024)) * 100)}%`;
                document.getElementById('storageBar').style.width = `${Math.round((totalStorage / (5 * 1024 * 1024)) * 100)}%`;
                
                // Update monitoring
                updateMonitoring();
                
                // Update user list
                updateUserList();
                
                // Update backup status
                updateBackupStatus();
                
                // Update logs
                updateLogPreview();
            }
        }

        function formatUptime(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }

        function updateMonitoring() {
            // Simulate monitoring data
            const cpuUsage = Math.random() * 100;
            const memoryUsage = Math.random() * 100;
            const activeSessions = users.length;
            
            document.getElementById('cpuUsage').textContent = `${cpuUsage.toFixed(1)}%`;
            document.getElementById('cpuBar').style.width = `${cpuUsage}%`;
            
            document.getElementById('memoryUsage').textContent = `${memoryUsage.toFixed(1)}%`;
            document.getElementById('memoryBar').style.width = `${memoryUsage}%`;
            
            document.getElementById('activeSessions').textContent = activeSessions;
        }

        function filterUsers(filter) {
            const userList = document.getElementById('userList');
            const userItems = userList.querySelectorAll('.user-item');
            
            userItems.forEach(item => {
                const role = item.querySelector('.role-badge').textContent;
                let show = false;
                
                switch(filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'active':
                        show = role !== 'admin';
                        break;
                    case 'admin':
                        show = role === 'admin';
                        break;
                }
                
                item.style.display = show ? 'flex' : 'none';
            });
        }

        function createUser() {
            const name = prompt('Enter user name:');
            const email = prompt('Enter user email:');
            const username = prompt('Enter username:');
            
            if (name && email && username) {
                const newUser = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    username: username,
                    role: 'user',
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                updateAdminPanel();
                showAdminNotification('User created successfully');
            }
        }

        function exportUsers() {
            const userData = users.map(user => ({
                name: user.name,
                email: user.email,
                username: user.username,
                role: user.role,
                createdAt: user.createdAt
            }));
            
            const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAdminNotification('Users exported successfully');
        }

        function clearAllUsers() {
            if (confirm('Are you sure you want to clear all users? This cannot be undone.')) {
                users = [currentUser]; // Keep current admin user
                localStorage.setItem('users', JSON.stringify(users));
                showAdminNotification('All users cleared successfully');
                updateAdminPanel();
            }
        }

        function generateReport() {
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const posts = JSON.parse(localStorage.getItem('posts') || '[]');
            
            const report = {
                generatedAt: new Date().toISOString(),
                summary: {
                    totalUsers: users.length,
                    totalRoutes: routes.length,
                    totalPosts: posts.length,
                    totalDistance: routes.reduce((sum, route) => sum + (route.distance || 0), 0),
                    avgSpeed: routes.length > 0 ? routes.reduce((sum, route) => sum + (route.avgSpeed || 0), 0) / routes.length : 0
                },
                users: users,
                routes: routes,
                posts: posts
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAdminNotification('Report generated successfully');
        }

        function optimizeStorage() {
            // Simulate storage optimization
            let optimized = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    try {
                        const data = JSON.parse(localStorage[key]);
                        const optimizedData = JSON.stringify(data);
                        if (optimizedData.length < localStorage[key].length) {
                            localStorage[key] = optimizedData;
                            optimized += localStorage[key].length - optimizedData.length;
                        }
                    } catch (e) {
                        // Skip non-JSON data
                    }
                }
            }
            
            showAdminNotification(`Storage optimized: ${Math.round(optimized / 1024)} KB saved`);
            updateAdminPanel();
        }

        function clearCache() {
            if (confirm('Are you sure you want to clear the cache?')) {
                // Clear non-essential data
                const essentialKeys = ['users', 'currentUser', 'playerData', 'backupSettings'];
                const keysToRemove = [];
                
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key) && !essentialKeys.includes(key)) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                showAdminNotification('Cache cleared successfully');
                updateAdminPanel();
            }
        }

        function validateData() {
            let issues = [];
            
            // Validate users
            users.forEach((user, index) => {
                if (!user.name || !user.email) {
                    issues.push(`User ${index}: Missing name or email`);
                }
            });
            
            // Validate routes
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            routes.forEach((route, index) => {
                if (!route.name || !route.coordinates) {
                    issues.push(`Route ${index}: Missing name or coordinates`);
                }
            });
            
            if (issues.length === 0) {
                showAdminNotification('Data validation passed - no issues found');
            } else {
                alert('Data validation issues found:\n' + issues.join('\n'));
                showAdminNotification(`Data validation completed - ${issues.length} issues found`);
            }
        }

        function scheduleBackup() {
            const frequency = prompt('Enter backup frequency in hours (1-24):');
            if (frequency && frequency >= 1 && frequency <= 24) {
                backupSettings.backupFrequency = frequency * 60 * 60 * 1000;
                localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
                showAdminNotification(`Backup scheduled every ${frequency} hours`);
            }
        }

        function viewSecurityLogs() {
            alert('Security logs feature - would show login attempts, admin actions, etc.');
        }

        function viewActivityLogs() {
            alert('Activity logs feature - would show user actions, route creation, etc.');
        }

        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                showAdminNotification('Logs cleared successfully');
            }
        }

        function updateLogPreview() {
            const logEntries = document.getElementById('logEntries');
            const logs = [
                `${new Date().toLocaleTimeString()} - Admin panel accessed`,
                `${new Date(Date.now() - 300000).toLocaleTimeString()} - User data updated`,
                `${new Date(Date.now() - 600000).toLocaleTimeString()} - Backup created`,
                `${new Date(Date.now() - 900000).toLocaleTimeString()} - System optimized`
            ];
            
            logEntries.innerHTML = logs.map(log => `<div class="log-entry">${log}</div>`).join('');
        }

        function toggleDebugMode() {
            const debugMode = document.getElementById('debugMode').checked;
            showAdminNotification(`Debug mode ${debugMode ? 'enabled' : 'disabled'}`);
        }

        function toggleMaintenanceMode() {
            const maintenanceMode = document.getElementById('maintenanceMode').checked;
            showAdminNotification(`Maintenance mode ${maintenanceMode ? 'enabled' : 'disabled'}`);
        }

        function toggleAutoOptimize() {
            const autoOptimize = document.getElementById('autoOptimize').checked;
            showAdminNotification(`Auto optimize ${autoOptimize ? 'enabled' : 'disabled'}`);
        }

        function toggleErrorReporting() {
            const errorReporting = document.getElementById('errorReporting').checked;
            showAdminNotification(`Error reporting ${errorReporting ? 'enabled' : 'disabled'}`);
        }

        function saveSettings() {
            const settings = {
                debugMode: document.getElementById('debugMode').checked,
                maintenanceMode: document.getElementById('maintenanceMode').checked,
                autoOptimize: document.getElementById('autoOptimize').checked,
                errorReporting: document.getElementById('errorReporting').checked
            };
            
            localStorage.setItem('adminSettings', JSON.stringify(settings));
            showAdminNotification('Settings saved successfully');
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                document.getElementById('debugMode').checked = false;
                document.getElementById('maintenanceMode').checked = false;
                document.getElementById('autoOptimize').checked = false;
                document.getElementById('errorReporting').checked = false;
                
                localStorage.removeItem('adminSettings');
                showAdminNotification('Settings reset to default');
            }
        }

        // Data Backup & Restore Functions
        function initializeBackupSystem() {
            // Load backup settings
            const savedSettings = localStorage.getItem('backupSettings');
            if (savedSettings) {
                backupSettings = { ...backupSettings, ...JSON.parse(savedSettings) };
            }
            
            // Start auto backup if enabled
            if (backupSettings.autoBackup) {
                startAutoBackup();
            }
            
            // Update backup status in admin panel
            updateBackupStatus();
        }

        function createBackup() {
            try {
                const backupData = {
                    version: "1.0.0",
                    timestamp: new Date().toISOString(),
                    userData: {
                        currentUser: currentUser,
                        users: users,
                        playerData: playerData,
                        routes: JSON.parse(localStorage.getItem('routes') || '[]'),
                        posts: JSON.parse(localStorage.getItem('posts') || '[]'),
                        performanceMetrics: performanceMetrics
                    },
                    settings: backupSettings
                };
                
                // Save backup to localStorage
                localStorage.setItem('driverhub_backup', JSON.stringify(backupData));
                
                // Update backup timestamp
                backupSettings.lastBackup = new Date().toISOString();
                localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
                
                // Download backup file
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `driverhub-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                updateBackupStatus();
                showBackupNotification('Backup created successfully! 💾');
                
            } catch (error) {
                console.error('Backup failed:', error);
                showBackupNotification('Backup failed! ❌', 'error');
            }
        }

        function restoreFromFile() {
            document.getElementById('restoreFile').click();
        }

        function handleRestore(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.version || !backupData.userData) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Confirm restoration
                    if (!confirm('⚠️ This will replace ALL your current data with the backup. Are you sure?')) {
                        return;
                    }
                    
                    // Restore data
                    const userData = backupData.userData;
                    
                    // Restore user data
                    if (userData.users) {
                        users = userData.users;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                    
                    if (userData.currentUser) {
                        currentUser = userData.currentUser;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    if (userData.playerData) {
                        playerData = userData.playerData;
                        localStorage.setItem('playerData', JSON.stringify(playerData));
                    }
                    
                    if (userData.routes) {
                        localStorage.setItem('routes', JSON.stringify(userData.routes));
                    }
                    
                    if (userData.posts) {
                        localStorage.setItem('posts', JSON.stringify(userData.posts));
                    }
                    
                    // Update backup settings
                    if (backupData.settings) {
                        backupSettings = { ...backupSettings, ...backupData.settings };
                        localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
                    }
                    
                    showBackupNotification('Data restored successfully! Refreshing app... 🔄');
                    
                    // Refresh the app after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Restore failed:', error);
                    showBackupNotification('Restore failed! Invalid backup file ❌', 'error');
                }
            };
            reader.readAsText(file);
            
            // Clear the input
            event.target.value = '';
        }

        function toggleAutoBackup() {
            backupSettings.autoBackup = !backupSettings.autoBackup;
            localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
            
            if (backupSettings.autoBackup) {
                startAutoBackup();
                showBackupNotification('Auto backup enabled ✅');
            } else {
                stopAutoBackup();
                showBackupNotification('Auto backup disabled ❌');
            }
            
            updateBackupStatus();
        }

        function startAutoBackup() {
            // Clear existing interval
            if (backupSettings.backupInterval) {
                clearInterval(backupSettings.backupInterval);
            }
            
            // Create backup every 30 minutes
            backupSettings.backupInterval = setInterval(() => {
                createAutoBackup();
            }, 30 * 60 * 1000); // 30 minutes
        }

        function stopAutoBackup() {
            if (backupSettings.backupInterval) {
                clearInterval(backupSettings.backupInterval);
                backupSettings.backupInterval = null;
            }
        }

        function createAutoBackup() {
            try {
                const backupData = {
                    version: "1.0.0",
                    timestamp: new Date().toISOString(),
                    userData: {
                        currentUser: currentUser,
                        users: users,
                        playerData: playerData,
                        routes: JSON.parse(localStorage.getItem('routes') || '[]'),
                        posts: JSON.parse(localStorage.getItem('posts') || '[]'),
                        performanceMetrics: performanceMetrics
                    },
                    settings: backupSettings,
                    autoBackup: true
                };
                
                // Save backup to localStorage (auto backups don't download)
                localStorage.setItem('driverhub_backup', JSON.stringify(backupData));
                localStorage.setItem('driverhub_backup_auto', JSON.stringify(backupData));
                
                // Update timestamp
                backupSettings.lastBackup = new Date().toISOString();
                localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
                
                updateBackupStatus();
                console.log('Auto backup completed');
                
            } catch (error) {
                console.error('Auto backup failed:', error);
            }
        }

        function updateBackupStatus() {
            const lastBackupEl = document.getElementById('lastBackup');
            const backupSizeEl = document.getElementById('backupSize');
            const autoBackupStatusEl = document.getElementById('autoBackupStatus');
            
            if (lastBackupEl && backupSettings.lastBackup) {
                const lastBackupDate = new Date(backupSettings.lastBackup);
                lastBackupEl.textContent = lastBackupDate.toLocaleString();
            }
            
            if (backupSizeEl) {
                // Calculate backup size
                const backup = localStorage.getItem('driverhub_backup');
                if (backup) {
                    const sizeKB = Math.round(backup.length / 1024);
                    backupSizeEl.textContent = `${sizeKB} KB`;
                }
            }
            
            if (autoBackupStatusEl) {
                autoBackupStatusEl.textContent = backupSettings.autoBackup ? 'Enabled' : 'Disabled';
                autoBackupStatusEl.style.color = backupSettings.autoBackup ? '#10b981' : '#ef4444';
            }
        }

        function showBackupNotification(message, type = 'success') {
            const color = type === 'error' ? '#ef4444' : '#10b981';
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, ${color}, ${color}dd);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                max-width: 350px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Live Tracking Functions
        function toggleLiveMode() {
            if (liveTracking.isActive) {
                stopLiveTracking();
            } else {
                startLiveTracking();
            }
        }
        
        function startLiveTracking() {
            // Check location permissions first
            if (!navigator.geolocation) {
                showLiveNotification('Geolocation not supported by this browser', 'error');
                return;
            }
            
            // Request location permission
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    liveTracking.isActive = true;
                    liveTracking.startTime = new Date();
                    liveTracking.currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: Date.now()
                    };
                    
                    // Update UI
                    updateLiveTrackingUI();
                    
                    // Start location tracking interval
                    liveTracking.interval = setInterval(() => {
                        updateCurrentLocation();
                        broadcastLocation();
                        checkForEmergency();
                    }, 30000); // Update every 30 seconds
                    
                    // Load friend list for sharing permissions
                    loadSharingPermissions();
                    
                    showLiveNotification('Live tracking started! 📡', 'success');
                    
                    // Add XP for starting live mode
                    addXP(XP_CONFIG.SOCIAL_INTERACTION, 'Started live sharing');
                },
                (error) => {
                    console.error('Location permission denied:', error);
                    showLiveNotification('Location permission required for live tracking', 'error');
                }
            );
        }
        
        function stopLiveTracking() {
            liveTracking.isActive = false;
            liveTracking.startTime = null;
            liveTracking.currentLocation = null;
            
            if (liveTracking.interval) {
                clearInterval(liveTracking.interval);
                liveTracking.interval = null;
            }
            
            // Update UI
            updateLiveTrackingUI();
            
            // Broadcast offline status
            broadcastOfflineStatus();
            
            showLiveNotification('Live tracking stopped', 'success');
        }
        
        function updateCurrentLocation() {
            if (!liveTracking.isActive) return;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed || 0,
                        heading: position.coords.heading || 0,
                        timestamp: Date.now()
                    };
                    
                    // Check if location has significantly changed
                    if (liveTracking.currentLocation) {
                        const distance = getDistanceFromLatLonInMiles(
                            liveTracking.currentLocation.lat,
                            liveTracking.currentLocation.lng,
                            newLocation.lat,
                            newLocation.lng
                        );
                        
                        // Only update if moved more than 50 feet (0.01 miles)
                        if (distance > 0.01) {
                            liveTracking.currentLocation = newLocation;
                            liveTracking.lastUpdate = Date.now();
                        }
                    } else {
                        liveTracking.currentLocation = newLocation;
                        liveTracking.lastUpdate = Date.now();
                    }
                },
                (error) => {
                    console.error('Location update failed:', error);
                }
            );
        }
        
        function broadcastLocation() {
            if (!liveTracking.isActive || !liveTracking.currentLocation) return;
            
            const locationData = {
                userId: currentUser.username,
                location: liveTracking.currentLocation,
                status: liveTracking.currentLocation.speed > 5 ? 'driving' : 'idle',
                timestamp: Date.now(),
                sharingWith: liveTracking.sharingWith
            };
            
            // In a real app, this would send to a WebSocket server
            // For demo, we'll store in localStorage and simulate
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            liveData[currentUser.username] = locationData;
            localStorage.setItem('liveTrackingData', JSON.stringify(liveData));
            
            console.log('Broadcasting location:', locationData);
        }
        
        function broadcastOfflineStatus() {
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            if (liveData[currentUser.username]) {
                delete liveData[currentUser.username];
                localStorage.setItem('liveTrackingData', JSON.stringify(liveData));
            }
        }
        
        function loadSharingPermissions() {
            // Load privacy settings
            const savedSettings = localStorage.getItem('livePrivacySettings');
            if (savedSettings) {
                liveTracking.privacySettings = { ...liveTracking.privacySettings, ...JSON.parse(savedSettings) };
            }
            
            // Determine who can see location based on privacy settings
            if (liveTracking.privacySettings.shareWithAll) {
                liveTracking.sharingWith = ['all'];
            } else {
                liveTracking.sharingWith = liveTracking.privacySettings.allowedFriends;
            }
        }
        
        function updateLiveTrackingUI() {
            const liveStatusEl = document.getElementById('liveStatus');
            const liveBtnEl = document.getElementById('liveModeBtn');
            const liveInfoEl = document.getElementById('liveInfo');
            const sharingWithEl = document.getElementById('sharingWith');
            const durationEl = document.getElementById('sharingDuration');
            
            if (liveTracking.isActive) {
                liveStatusEl.textContent = 'Live';
                liveStatusEl.classList.add('active');
                liveBtnEl.textContent = '🔴 Stop Live Sharing';
                liveBtnEl.classList.add('active');
                liveInfoEl.style.display = 'block';
                
                if (sharingWithEl) {
                    const count = liveTracking.sharingWith.includes('all') ? 'All friends' : `${liveTracking.sharingWith.length} friends`;
                    sharingWithEl.textContent = count;
                }
                
                // Update duration
                if (durationEl && liveTracking.startTime) {
                    const duration = Math.floor((Date.now() - liveTracking.startTime.getTime()) / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    durationEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            } else {
                liveStatusEl.textContent = 'Offline';
                liveStatusEl.classList.remove('active');
                liveBtnEl.textContent = '📡 Start Live Sharing';
                liveBtnEl.classList.remove('active');
                liveInfoEl.style.display = 'none';
            }
        }
        
        function checkForEmergency() {
            // Check G-force data for potential crash
            if (accelerometerData && accelerometerData.totalG > 4.0) {
                if (!liveTracking.emergencyMode) {
                    liveTracking.emergencyMode = true;
                    triggerEmergencySharing();
                }
            }
        }
        
        function triggerEmergencySharing() {
            // Override privacy settings in emergency
            liveTracking.sharingWith = ['all'];
            
            // Broadcast emergency location
            const emergencyData = {
                userId: currentUser.username,
                location: liveTracking.currentLocation,
                status: 'emergency',
                emergencyType: 'high_gforce',
                timestamp: Date.now(),
                message: 'Emergency detected - High G-force impact'
            };
            
            // Store emergency data
            const emergencyAlerts = JSON.parse(localStorage.getItem('emergencyAlerts') || '[]');
            emergencyAlerts.push(emergencyData);
            localStorage.setItem('emergencyAlerts', JSON.stringify(emergencyAlerts));
            
            showLiveNotification('🚨 Emergency detected! Location shared with all contacts', 'error');
            
            console.log('Emergency sharing activated:', emergencyData);
        }
        
        function openPrivacySettings() {
            // Create privacy modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>🔒 Live Sharing Privacy</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="privacy-section">
                            <h4>Who can see your live location?</h4>
                            <label class="privacy-option">
                                <input type="radio" name="shareMode" value="all" ${liveTracking.privacySettings.shareWithAll ? 'checked' : ''}>
                                <span>All friends</span>
                            </label>
                            <label class="privacy-option">
                                <input type="radio" name="shareMode" value="selected" ${!liveTracking.privacySettings.shareWithAll ? 'checked' : ''}>
                                <span>Selected friends only</span>
                            </label>
                        </div>
                        
                        <div class="privacy-section">
                            <h4>Auto-stop after:</h4>
                            <select id="autoExpireSelect">
                                <option value="3600000" ${liveTracking.privacySettings.expireAfter === 3600000 ? 'selected' : ''}>1 hour</option>
                                <option value="7200000" ${liveTracking.privacySettings.expireAfter === 7200000 ? 'selected' : ''}>2 hours</option>
                                <option value="14400000" ${liveTracking.privacySettings.expireAfter === 14400000 ? 'selected' : ''}>4 hours</option>
                                <option value="0" ${liveTracking.privacySettings.expireAfter === 0 ? 'selected' : ''}>Never</option>
                            </select>
                        </div>
                        
                        <div class="privacy-section">
                            <label class="privacy-option">
                                <input type="checkbox" id="emergencyOverride" checked>
                                <span>Allow emergency override (recommended)</span>
                                <small>Automatically share with all contacts if crash detected</small>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="savePrivacySettings()">Save Settings</button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function savePrivacySettings() {
            const shareMode = document.querySelector('input[name="shareMode"]:checked').value;
            const autoExpire = document.getElementById('autoExpireSelect').value;
            
            liveTracking.privacySettings.shareWithAll = shareMode === 'all';
            liveTracking.privacySettings.expireAfter = parseInt(autoExpire);
            
            localStorage.setItem('livePrivacySettings', JSON.stringify(liveTracking.privacySettings));
            
            // Update sharing permissions
            loadSharingPermissions();
            
            showLiveNotification('Privacy settings saved', 'success');
            
            // Close modal
            document.querySelector('.modal').remove();
        }
        
        function showLiveNotification(message, type = 'success') {
            const color = type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#22c55e';
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, ${color}, ${color}dd);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                max-width: 350px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function initializeLiveTracking() {
            // Load saved live tracking settings
            const savedSettings = localStorage.getItem('livePrivacySettings');
            if (savedSettings) {
                liveTracking.privacySettings = { ...liveTracking.privacySettings, ...JSON.parse(savedSettings) };
            }
            
            // Update UI with current state
            updateLiveTrackingUI();
            
            // Set up duration counter update
            setInterval(() => {
                if (liveTracking.isActive) {
                    updateLiveTrackingUI();
                }
            }, 1000);
            
            console.log('Live tracking system initialized');
        }

        // XP and Leveling System Functions
        function loadPlayerData() {
            const savedData = localStorage.getItem('playerData');
            if (savedData) {
                playerData = { ...playerData, ...JSON.parse(savedData) };
            }
            
            // Check for daily reset
            const today = new Date().toDateString();
            if (playerData.lastActive !== today) {
                playerData.dailyXP = 0;
                playerData.lastActive = today;
                savePlayerData();
            }
        }

        function savePlayerData() {
            try {
                localStorage.setItem('playerData', JSON.stringify(playerData));
            } catch (error) {
                console.error('Failed to save player data:', error);
                if (error.name === 'QuotaExceededError') {
                    showStorageQuotaError();
                }
            }
        }
        
        function showStorageQuotaError() {
            const errorToast = document.createElement('div');
            errorToast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
                max-width: 300px;
            `;
            errorToast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">⚠️</span>
                    <div>
                        <div style="font-size: 0.9rem;">Storage Full</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">Please clear some data in admin panel</div>
                    </div>
                </div>
            `;
            document.body.appendChild(errorToast);
            
            setTimeout(() => {
                errorToast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => errorToast.remove(), 300);
            }, 5000);
        }

        function initializeXPSystem() {
            addXPDisplay();
            updateXPDisplay();
            checkLevelUp();
        }

        function addXPDisplay() {
            const dashboard = document.querySelector('#dashboard');
            if (dashboard) {
                const xpCard = document.createElement('div');
                xpCard.className = 'card xp-card';
                xpCard.innerHTML = `
                    <div class="card-header">
                        <h3 class="card-title">🎮 Player Progress</h3>
                        <button class="help-btn" onclick="showXPExplanation()" title="How does XP work?">❓</button>
                    </div>
                    <div class="xp-container">
                        <div class="level-display">
                            <div class="level-circle">
                                <div class="level-number" id="playerLevel">${playerData.level}</div>
                            </div>
                            <div class="level-info">
                                <div class="level-title" id="levelTitle">Driver Level ${playerData.level}</div>
                                <div class="next-level">Next: Level ${playerData.level + 1}</div>
                            </div>
                        </div>
                        
                        <div class="xp-progress">
                            <div class="xp-bar-container">
                                <div class="xp-bar" id="xpBar"></div>
                                <div class="xp-text">
                                    <span id="currentXP">${playerData.xp}</span> / <span id="nextLevelXP">${getNextLevelXP()}</span> XP
                                </div>
                            </div>
                        </div>
                        
                        <div class="xp-stats">
                            <div class="xp-stat">
                                <div class="xp-stat-value" id="dailyXP">${playerData.dailyXP}</div>
                                <div class="xp-stat-label">Daily XP</div>
                            </div>
                            <div class="xp-stat">
                                <div class="xp-stat-value" id="totalDrives">${playerData.totalDrives}</div>
                                <div class="xp-stat-label">Total Drives</div>
                            </div>
                            <div class="xp-stat">
                                <div class="xp-stat-value" id="totalDistance">${Math.round(playerData.totalDistance)}</div>
                                <div class="xp-stat-label">Miles Driven</div>
                            </div>
                        </div>
                        
                        <div class="recent-achievements" id="recentAchievements">
                            <h4>🏆 Recent Achievements</h4>
                            <div class="achievement-list" id="achievementList"></div>
                        </div>
                    </div>
                `;
                
                // Insert as first card
                const firstCard = dashboard.querySelector('.card');
                if (firstCard) {
                    firstCard.insertAdjacentElement('beforebegin', xpCard);
                } else {
                    dashboard.appendChild(xpCard);
                }
            }
        }

        function updateXPDisplay() {
            const levelEl = document.getElementById('playerLevel');
            const levelTitleEl = document.getElementById('levelTitle');
            const currentXPEl = document.getElementById('currentXP');
            const nextLevelXPEl = document.getElementById('nextLevelXP');
            const dailyXPEl = document.getElementById('dailyXP');
            const totalDrivesEl = document.getElementById('totalDrives');
            const totalDistanceEl = document.getElementById('totalDistance');
            const xpBar = document.getElementById('xpBar');
            
            if (levelEl) levelEl.textContent = playerData.level;
            if (levelTitleEl) levelTitleEl.textContent = getLevelTitle(playerData.level);
            if (currentXPEl) currentXPEl.textContent = playerData.xp;
            if (nextLevelXPEl) nextLevelXPEl.textContent = getNextLevelXP();
            if (dailyXPEl) dailyXPEl.textContent = playerData.dailyXP;
            if (totalDrivesEl) totalDrivesEl.textContent = playerData.totalDrives;
            if (totalDistanceEl) totalDistanceEl.textContent = Math.round(playerData.totalDistance);
            
            // Update XP bar
            if (xpBar) {
                const currentLevelXP = getCurrentLevelXP();
                const nextLevelXP = getNextLevelXP();
                const progressXP = playerData.xp - currentLevelXP;
                const neededXP = nextLevelXP - currentLevelXP;
                const percentage = Math.min((progressXP / neededXP) * 100, 100);
                xpBar.style.width = percentage + '%';
            }
            
            updateAchievementsList();
        }

        function addXP(amount, reason) {
            const oldLevel = playerData.level;
            playerData.xp += amount;
            playerData.dailyXP += amount;
            
            // Show XP gain animation
            showXPGain(amount, reason);
            
            // Check for level up
            const newLevel = calculateLevel(playerData.xp);
            if (newLevel > oldLevel) {
                playerData.level = newLevel;
                showLevelUp(newLevel);
                checkAchievements();
            }
            
            updateXPDisplay();
            savePlayerData();
        }

        function calculateLevel(xp) {
            for (let i = XP_CONFIG.LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
                if (xp >= XP_CONFIG.LEVEL_THRESHOLDS[i]) {
                    return i + 1;
                }
            }
            return 1;
        }

        function getCurrentLevelXP() {
            return XP_CONFIG.LEVEL_THRESHOLDS[playerData.level - 1] || 0;
        }

        function getNextLevelXP() {
            return XP_CONFIG.LEVEL_THRESHOLDS[playerData.level] || XP_CONFIG.LEVEL_THRESHOLDS[XP_CONFIG.LEVEL_THRESHOLDS.length - 1];
        }

        function getLevelTitle(level) {
            if (level >= 50) return "🏆 Legend";
            if (level >= 40) return "👑 Elite Master";
            if (level >= 30) return "⭐ Elite Driver";
            if (level >= 25) return "🎖️ Master Driver";
            if (level >= 20) return "🦸 Hero Driver";
            if (level >= 15) return "⚔️ Veteran Driver";
            if (level >= 10) return "🛡️ Experienced Driver";
            if (level >= 5) return "🚗 Skilled Driver";
            return "🔰 Novice Driver";
        }

        function showXPGain(amount, reason) {
            const xpToast = document.createElement('div');
            xpToast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 0.75rem 1.25rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: xpGainSlide 3s ease forwards;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            xpToast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">⭐</span>
                    <div>
                        <div style="font-size: 0.9rem;">+${amount} XP</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">${reason}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(xpToast);
            
            setTimeout(() => xpToast.remove(), 3000);
        }

        function showLevelUp(newLevel) {
            const levelUpModal = document.createElement('div');
            levelUpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1002;
                animation: fadeIn 0.3s ease;
            `;
            
            levelUpModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                    padding: 3rem 2rem;
                    border-radius: 1.5rem;
                    text-align: center;
                    color: white;
                    max-width: 400px;
                    width: 90%;
                    animation: levelUpBounce 0.6s ease;
                    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
                ">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
                    <h2 style="margin: 0 0 0.5rem 0; font-size: 2rem;">LEVEL UP!</h2>
                    <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0;">${newLevel}</div>
                    <div style="font-size: 1.2rem; margin-bottom: 2rem;">${getLevelTitle(newLevel)}</div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        padding: 0.75rem 2rem;
                        border-radius: 0.75rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 1rem;
                    ">Continue</button>
                </div>
            `;
            
            document.body.appendChild(levelUpModal);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (levelUpModal.parentElement) {
                    levelUpModal.remove();
                }
            }, 5000);
        }

        function checkAchievements() {
            Object.keys(XP_CONFIG.ACHIEVEMENTS).forEach(achievementId => {
                if (!playerData.achievements.includes(achievementId)) {
                    if (isAchievementUnlocked(achievementId)) {
                        unlockAchievement(achievementId);
                    }
                }
            });
        }

        function isAchievementUnlocked(achievementId) {
            switch (achievementId) {
                case 'first_drive':
                    return playerData.totalDrives >= 1;
                case 'distance_10':
                    return playerData.totalDistance >= 10;
                case 'distance_50':
                    return playerData.totalDistance >= 50;
                case 'distance_100':
                    return playerData.totalDistance >= 100;
                case 'distance_500':
                    return playerData.totalDistance >= 500;
                case 'drives_10':
                    return playerData.totalDrives >= 10;
                case 'drives_50':
                    return playerData.totalDrives >= 50;
                case 'level_10':
                    return playerData.level >= 10;
                case 'level_25':
                    return playerData.level >= 25;
                case 'speed_demon':
                    return speedData.some(speed => speed > 100);
                default:
                    return false;
            }
        }

        function unlockAchievement(achievementId) {
            const achievement = XP_CONFIG.ACHIEVEMENTS[achievementId];
            playerData.achievements.push(achievementId);
            
            // Award achievement XP
            addXP(achievement.xp, `Achievement: ${achievement.name}`);
            
            // Show achievement notification
            showAchievementUnlocked(achievement);
            
            savePlayerData();
        }

        function showAchievementUnlocked(achievement) {
            const achievementToast = document.createElement('div');
            achievementToast.style.cssText = `
                position: fixed;
                top: 140px;
                right: 20px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: achievementSlide 4s ease forwards;
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
                border: 1px solid rgba(255, 255, 255, 0.2);
                max-width: 300px;
            `;
            achievementToast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 2rem;">${achievement.icon}</span>
                    <div>
                        <div style="font-size: 1rem; font-weight: bold;">Achievement Unlocked!</div>
                        <div style="font-size: 0.9rem; margin: 0.25rem 0;">${achievement.name}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">${achievement.description}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">+${achievement.xp} XP</div>
                    </div>
                </div>
            `;
            document.body.appendChild(achievementToast);
            
            setTimeout(() => achievementToast.remove(), 4000);
        }

        function updateAchievementsList() {
            const achievementList = document.getElementById('achievementList');
            if (!achievementList) return;
            
            const recentAchievements = playerData.achievements.slice(-3);
            achievementList.innerHTML = '';
            
            if (recentAchievements.length === 0) {
                achievementList.innerHTML = '<div style="color: #94a3b8; font-size: 0.875rem;">Complete your first drive to unlock achievements!</div>';
                return;
            }
            
            recentAchievements.forEach(achievementId => {
                const achievement = XP_CONFIG.ACHIEVEMENTS[achievementId];
                if (achievement) {
                    const achievementEl = document.createElement('div');
                    achievementEl.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        padding: 0.5rem;
                        background: rgba(59, 130, 246, 0.1);
                        border-radius: 0.5rem;
                        margin-bottom: 0.5rem;
                        border: 1px solid rgba(59, 130, 246, 0.2);
                    `;
                    achievementEl.innerHTML = `
                        <span style="font-size: 1.5rem;">${achievement.icon}</span>
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600;">${achievement.name}</div>
                            <div style="font-size: 0.75rem; color: #94a3b8;">${achievement.description}</div>
                        </div>
                    `;
                    achievementList.appendChild(achievementEl);
                }
            });
        }

        function checkLevelUp() {
            const currentLevel = calculateLevel(playerData.xp);
            if (currentLevel > playerData.level) {
                playerData.level = currentLevel;
                showLevelUp(currentLevel);
                savePlayerData();
            }
        }

        // Initialize map
        function initializeMap() {
            map = L.map('map').setView([40.7128, -74.0060], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Request location permission once and cache the result
        async function requestLocationPermission() {
            if (locationPermissionGranted) {
                return true;
            }

            if (!navigator.geolocation) {
                document.getElementById('locationStatus').textContent = 'Not supported';
                return false;
            }

            // Check if we already have permission using the Permissions API
            if ('permissions' in navigator) {
                try {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    if (permission.state === 'granted') {
                        locationPermissionGranted = true;
                        return true;
                    } else if (permission.state === 'denied') {
                        document.getElementById('locationStatus').textContent = 'Permission denied';
                        return false;
                    }
                } catch (error) {
                    console.log('Permissions API not available, using fallback');
                }
            }

            // Request permission through getCurrentPosition (only once)
            return new Promise((resolve) => {
                document.getElementById('locationStatus').textContent = 'Requesting location access...';
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        locationPermissionGranted = true;
                        currentPosition = position;
                        console.log('Location permission granted');
                        resolve(true);
                    },
                    function(error) {
                        console.log('Location permission denied:', error);
                        let errorMsg = 'Location unavailable';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'Location access denied. Please enable in browser settings.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'Position unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'Location request timeout';
                                break;
                        }
                        document.getElementById('locationStatus').textContent = errorMsg;
                        resolve(false);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 60000 // Cache for 1 minute to avoid repeated requests
                    }
                );
            });
        }

        // Get current location for map centering (uses cached permission)
        async function getCurrentLocationForMap() {
            const hasPermission = await requestLocationPermission();
            
            if (!hasPermission) {
                return;
            }

            document.getElementById('locationStatus').textContent = 'Getting precise location...';
            
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const speed = position.coords.speed ? Math.round(position.coords.speed * 3.6) : 0;
                            const accuracy = position.coords.accuracy;
                            const altitude = position.coords.altitude;
                            const altitudeAccuracy = position.coords.altitudeAccuracy;
                            
                            currentPosition = position;
                            console.log('Location Details:', {
                                lat: lat,
                                lng: lng,
                                accuracy: accuracy,
                                altitude: altitude,
                                altitudeAccuracy: altitudeAccuracy,
                                timestamp: new Date(position.timestamp).toLocaleTimeString()
                            });
                            
                            // Determine location source based on accuracy
                            let locationSource = 'GPS';
                            let statusColor = '#22c55e'; // Green for good GPS
                            
                            if (accuracy > 100) {
                                locationSource = 'Cell Tower (~' + Math.round(accuracy) + 'm)';
                                statusColor = '#ef4444'; // Red for poor accuracy
                            } else if (accuracy > 50) {
                                locationSource = 'WiFi (~' + Math.round(accuracy) + 'm)';
                                statusColor = '#f59e0b'; // Orange for medium accuracy
                            } else if (accuracy > 20) {
                                locationSource = 'GPS (~' + Math.round(accuracy) + 'm)';
                                statusColor = '#3b82f6'; // Blue for decent GPS
                            } else {
                                locationSource = 'GPS (~' + Math.round(accuracy) + 'm)';
                                statusColor = '#22c55e'; // Green for good GPS
                            }
                            
                            // Update display with source info
                            document.getElementById('currentSpeed').innerHTML = `${speed}<span class="status-unit">km/h</span>`;
                            const locationStatusEl = document.getElementById('locationStatus');
                            locationStatusEl.innerHTML = `${locationSource}`;
                            locationStatusEl.style.color = statusColor;
                            
                            // Warn if accuracy is poor
                            if (accuracy > 100) {
                                console.warn('⚠️ POOR ACCURACY: Location may be inaccurate. Try going outside or near a window for better GPS signal.');
                                locationStatusEl.innerHTML += '<br><small style="color: #ef4444;">Poor signal - go outside</small>';
                            }
                            
                            // Center map on current location
                            map.setView([lat, lng], 16);
                            
                            // Add accuracy circle with color coding
                            const accuracyCircle = L.circle([lat, lng], {
                                radius: accuracy,
                                color: statusColor,
                                fillColor: statusColor,
                                fillOpacity: 0.1,
                                weight: 2
                            }).addTo(map);
                            
                            // Add marker with detailed popup
                            const popupContent = `
                                <strong>Your Location</strong><br>
                                Accuracy: ±${Math.round(accuracy)}m<br>
                                Source: ${locationSource}<br>
                                ${accuracy > 50 ? '<span style="color: #ef4444;">⚠️ Go outside for better accuracy</span>' : '<span style="color: #22c55e;">✓ Good accuracy</span>'}
                            `;
                            L.marker([lat, lng]).addTo(map).bindPopup(popupContent);
                        },
                function(error) {
                    console.log('Location error:', error);
                    document.getElementById('locationStatus').textContent = 'Location error';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000 // Use cached position for 30 seconds
                }
            );
        }

        // Toggle tracking
        function toggleTracking() {
            if (!isTracking) {
                startTracking();
            } else {
                stopTracking();
            }
        }

        // Start tracking
        async function startTracking() {
            console.log('Starting tracking...');
            
            // Check permission first
            const hasPermission = await requestLocationPermission();
            if (!hasPermission) {
                alert('Location permission is required to track routes. Please enable location access in your browser settings.');
                return;
            }
            
            isTracking = true;
            currentRoute = [];
            speedData = [];
            
            document.getElementById('trackBtn').textContent = 'Stop Recording';
            document.getElementById('trackBtn').classList.add('recording');
            document.getElementById('trackingInfo').classList.remove('hidden');
            document.getElementById('trackingStatus').textContent = 'Recording';
            
            if (navigator.geolocation) {
                // Get initial high-accuracy position
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const speed = position.coords.speed ? Math.round(position.coords.speed * 3.6) : 0;
                        const accuracy = position.coords.accuracy;
                        
                        console.log(`Initial tracking accuracy: ${accuracy} meters`);
                        
                        // Update location display
                        document.getElementById('locationStatus').textContent = `±${Math.round(accuracy)}m accuracy`;
                        document.getElementById('currentSpeed').innerHTML = `${speed}<span class="status-unit">km/h</span>`;
                        
                        // Center map and add first point
                        map.setView([lat, lng], 16);
                        L.marker([lat, lng]).addTo(map);
                        currentRoute.push({ lat, lng, speed, timestamp: Date.now(), accuracy });
                        document.getElementById('routePoints').textContent = `${currentRoute.length} points`;
                        
                        // Start continuous high-accuracy tracking
                        watchId = navigator.geolocation.watchPosition(
                            function(position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                const speed = position.coords.speed ? Math.round(position.coords.speed * 3.6) : 0;
                                const accuracy = position.coords.accuracy;
                                const timestamp = Date.now();
                                
                                console.log(`Tracking accuracy: ${accuracy}m, Speed: ${speed}km/h`);
                                
                                // Log all readings for debugging
                                console.log(`Tracking reading: ${accuracy}m accuracy, ${speed}km/h, ${locationSource}`);
                                
                                // Only add point if accuracy is reasonable (less than 100m for tracking, 30m for precise tracking)
                                const accuracyThreshold = isTracking ? 100 : 30; // More lenient during tracking
                                if (accuracy <= accuracyThreshold) {
                                    // Update current speed and location
                                    document.getElementById('currentSpeed').innerHTML = `${Math.round(speed * 0.621371)}<span class="status-unit">mph</span>`;
                                    document.getElementById('locationStatus').textContent = `±${Math.round(accuracy)}m accuracy`;
                                    
                                    // Filter out points that are too close (less than 5m apart) to reduce noise
                                    const lastPoint = currentRoute[currentRoute.length - 1];
                                    const distance = lastPoint ? getDistanceFromLatLonInMiles(lastPoint.lat, lastPoint.lng, lat, lng) * 5280 : 328; // Convert to feet
                                    
                                    if (distance > 5 || currentRoute.length === 0) {
                                        // Add to route
                                        currentRoute.push({ lat, lng, speed, timestamp, accuracy });
                                        document.getElementById('routePoints').textContent = `${currentRoute.length} points`;
                                        
                                        // Update map with smoothed route
                                        if (currentRoute.length > 1) {
                                            // Clear previous route line
                                            map.eachLayer(layer => {
                                                if (layer instanceof L.Polyline) {
                                                    map.removeLayer(layer);
                                                }
                                            });
                                            
                                            // Add new route line
                                            L.polyline(currentRoute.map(p => [p.lat, p.lng]), {
                                                color: '#3b82f6',
                                                weight: 4,
                                                opacity: 0.8,
                                                smoothFactor: 2.0  // Smooth the line
                                            }).addTo(map);
                                            
                                            // Keep map centered on current position
                                            map.setView([lat, lng], map.getZoom());
                                        }
                                        
                                        // Update total distance
                                        const totalDistance = calculateTotalDistance(currentRoute);
                                        document.getElementById('totalDistance').innerHTML = `${totalDistance.toFixed(1)}<span class="status-unit">mi</span>`;
                                    }
                                } else {
                                    console.warn(`Low accuracy reading skipped: ${accuracy}m`);
                                }
                            },
                            function(error) {
                                console.error('Error tracking location:', error);
                                document.getElementById('locationStatus').textContent = 'Tracking error';
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 8000,         // Shorter timeout for continuous updates
                                maximumAge: 0          // Always fresh readings
                            }
                        );
                    },
                    function(error) {
                        console.error('Error getting initial position:', error);
                        document.getElementById('locationStatus').textContent = 'Cannot start tracking';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            }
        }

        // Stop tracking
        function stopTracking() {
            console.log('Stopping tracking...');
            
            try {
                isTracking = false;
                
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                
                document.getElementById('trackBtn').textContent = 'Start Recording';
                document.getElementById('trackBtn').classList.remove('recording');
                document.getElementById('trackingInfo').classList.add('hidden');
                document.getElementById('trackingStatus').textContent = 'Ready';
                
                // Only show save modal if we have route data
                if (currentRoute && currentRoute.length > 0) {
                    document.getElementById('saveModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error in stopTracking:', error);
            }
        }

        // Calculate total distance
        function calculateTotalDistance(route) {
            let total = 0;
            for (let i = 1; i < route.length; i++) {
                const prev = route[i - 1];
                const curr = route[i];
                const distance = getDistanceFromLatLonInMiles(prev.lat, prev.lng, curr.lat, curr.lng);
                total += distance;
            }
            return total;
        }

        function getDistanceFromLatLonInMiles(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Save route
        function saveRoute() {
            try {
                const nameInput = document.getElementById('routeName');
                const isPublicInput = document.getElementById('isPublic');
                
                const name = nameInput.value.trim();
                const isPublic = isPublicInput ? isPublicInput.checked : false;
                
                if (!name) {
                    alert('Please enter a route name');
                    return;
                }
                
                if (!currentRoute || currentRoute.length === 0) {
                    alert('No route data to save');
                    return;
                }
                
                // Calculate route statistics
                    const topSpeed = currentRoute.length > 0 ? Math.max(...currentRoute.map(p => (p.speed || 0) * 0.621371)) : 0;
                    const avgSpeed = currentRoute.length > 0 ?
                        currentRoute.reduce((sum, p) => sum + ((p.speed || 0) * 0.621371), 0) / currentRoute.length : 0;
                
                const route = {
                    id: Date.now(),
                    name: name,
                    points: currentRoute.length,
                    distance: calculateTotalDistance(currentRoute).toFixed(1),
                    duration: currentRoute.length > 0 ? 
                        ((currentRoute[currentRoute.length - 1].timestamp - currentRoute[0].timestamp) / 60000).toFixed(0) : 0,
                    topSpeed: Math.round(topSpeed),
                    avgSpeed: Math.round(avgSpeed),
                    isPublic: isPublic,
                    timestamp: new Date().toLocaleString(),
                    username: 'You', // Current user
                    userId: 'current-user'
                };
                
                // Save to localStorage
                const routes = safeGetItem('routes', []);
                routes.unshift(route);
                safeSetItem('routes', routes);
                
                console.log('Route saved successfully:', route);
                
                // Track performance
                performanceMetrics.routesSaved++;
                
                // Award XP for completing drive
                const distance = calculateTotalDistance();
                const distanceXP = Math.round(distance * XP_CONFIG.DISTANCE_PER_MILE);
                addXP(XP_CONFIG.DRIVE_COMPLETION + distanceXP, `Drive Completed (${Math.round(distance)} mi)`);
                
                // Update player stats
                playerData.totalDrives++;
                playerData.totalDistance += distance;
                
                // Check for achievements
                checkAchievements();
                
                closeSaveModal();
                loadSampleRoutes();
                
                // Reset tracking
                currentRoute = [];
                speedData = [];
                
                // Clear route lines from map
                if (map) {
                    map.eachLayer(layer => {
                        if (layer instanceof L.Polyline) {
                            map.removeLayer(layer);
                        }
                    });
                }
                
                // Reset distance display
                document.getElementById('totalDistance').innerHTML = '0.0<span class="status-unit">mi</span>';
                
            } catch (error) {
                console.error('Error saving route:', error);
                alert('Error saving route. Please try again.');
            }
        }

        // Close save modal
        function closeSaveModal() {
            document.getElementById('saveModal').classList.add('hidden');
            document.getElementById('routeName').value = '';
            document.getElementById('isPublic').checked = false;
        }

        // Generate mock friends data
        function generateFriendsRoutes() {
            const friendsRoutes = [
                {
                    id: 'friend-1-route-1',
                    name: 'Morning Commute',
                    username: 'SpeedRacer',
                    userId: 'friend-1',
                    distance: '25.3',
                    duration: '32',
                    topSpeed: 95,
                    avgSpeed: 47,
                    points: 287,
                    isPublic: true,
                    timestamp: 'Yesterday, 8:15 AM'
                },
                {
                    id: 'friend-2-route-1',
                    name: 'Highway Run',
                    username: 'RoadWarrior',
                    userId: 'friend-2',
                    distance: '85.2',
                    duration: '78',
                    topSpeed: 128,
                    avgSpeed: 65,
                    points: 456,
                    isPublic: true,
                    timestamp: '2 days ago'
                },
                {
                    id: 'friend-3-route-1',
                    name: 'City Loop',
                    username: 'UrbanDriver',
                    userId: 'friend-3',
                    distance: '12.7',
                    duration: '28',
                    topSpeed: 62,
                    avgSpeed: 27,
                    points: 198,
                    isPublic: true,
                    timestamp: '3 days ago'
                }
            ];
            return friendsRoutes;
        }

        // Create route card HTML
        function createRouteCard(route, showActions = false) {
            const isOwnRoute = route.userId === 'current-user' || route.username === 'You';
            
            return `
                <div class="route-card" id="route-${route.id}">
                    <div class="route-header">
                        <div>
                            <div class="route-name">${route.name}</div>
                            ${!isOwnRoute ? `<div style="font-size: 0.875rem; color: #94a3b8; margin-top: 0.25rem;">by ${route.username}</div>` : ''}
                        </div>
                        <div class="route-actions">
                            <div class="route-badge ${route.isPublic ? '' : 'private'}">${route.isPublic ? 'Public' : 'Private'}</div>
                            ${showActions && isOwnRoute ? `<button class="btn-danger" onclick="deleteRoute(${route.id})" title="Delete Route">×</button>` : ''}
                        </div>
                    </div>
                    <div class="route-stats">
                            <div class="route-stat">
                                <div class="route-stat-value">${route.distance}</div>
                                <div class="route-stat-label">mi</div>
                            </div>
                        <div class="route-stat">
                            <div class="route-stat-value">${route.duration}</div>
                            <div class="route-stat-label">min</div>
                        </div>
                        <div class="route-stat">
                            <div class="route-stat-value">${route.topSpeed ? Math.round(route.topSpeed * 0.621371) : route.points}</div>
                            <div class="route-stat-label">${route.topSpeed ? 'mph max' : 'points'}</div>
                        </div>
                        ${route.avgSpeed ? `
                        <div class="route-stat">
                            <div class="route-stat-value">${Math.round(route.avgSpeed * 0.621371)}</div>
                            <div class="route-stat-label">mph avg</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="route-timestamp">${route.timestamp}</div>
                </div>
            `;
        }

        // Load routes
        function loadSampleRoutes() {
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const friendsRoutes = generateFriendsRoutes();
            const publicRoutes = [...routes.filter(r => r.isPublic), ...friendsRoutes];
            
            const recentRoutes = document.getElementById('recentRoutes');
            const allRoutes = document.getElementById('allRoutes');
            const friendsRoutesEl = document.getElementById('friendsRoutes');
            const publicRoutesEl = document.getElementById('publicRoutes');
            
            // Recent routes (dashboard) - limit to 3
            const recentRoutesHTML = routes.slice(0, 3).map(route => createRouteCard(route, false)).join('');
            
            // My routes (routes page) - with delete buttons
            const allRoutesHTML = routes.map(route => createRouteCard(route, true)).join('');
            
            // Friends routes
            const friendsRoutesHTML = friendsRoutes.map(route => createRouteCard(route, false)).join('');
            
            // Public routes (mix of user's public routes and friends' routes)
            const publicRoutesHTML = publicRoutes.map(route => createRouteCard(route, false)).join('');
            
            // Update DOM
            recentRoutes.innerHTML = recentRoutesHTML || '<div class="text-center" style="color: #64748b; padding: 2rem;">No routes yet. Start tracking to create your first route.</div>';
            allRoutes.innerHTML = allRoutesHTML || '<div class="text-center" style="color: #64748b; padding: 2rem;">No routes yet. Start tracking to create your first route.</div>';
            
            if (friendsRoutesEl) {
                friendsRoutesEl.innerHTML = friendsRoutesHTML || '<div class="text-center" style="color: #64748b; padding: 2rem;">Add friends to see their routes here.</div>';
            }
            
            if (publicRoutesEl) {
                publicRoutesEl.innerHTML = publicRoutesHTML || '<div class="text-center" style="color: #64748b; padding: 2rem;">No public routes available.</div>';
            }
        }

        // Delete route
        function deleteRoute(routeId) {
            try {
                if (!routeId) return;
                
                if (confirm('Delete this route permanently?')) {
                    let routes = JSON.parse(localStorage.getItem('routes') || '[]');
                    routes = routes.filter(route => route.id != routeId);
                    localStorage.setItem('routes', JSON.stringify(routes));
                    
                    const routeCard = document.getElementById(`route-${routeId}`);
                    if (routeCard) {
                        routeCard.style.transition = 'all 0.3s ease';
                        routeCard.style.opacity = '0';
                        routeCard.style.transform = 'scale(0.95)';
                        
                        setTimeout(() => {
                            loadSampleRoutes();
                        }, 300);
                    } else {
                        loadSampleRoutes();
                    }
                }
            } catch (error) {
                console.error('Error deleting route:', error);
            }
        }

        // Show route tab
        function showRouteTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.route-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find and activate the clicked tab
            const clickedTab = document.querySelector(`[onclick="showRouteTab('${tabId}')"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Hide all tab contents
            document.querySelectorAll('.route-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.remove('hidden');
            
            // Load specific content for live friends tab
            if (tabId === 'live-friends') {
                loadLiveFriends();
            }
        }
        
        function loadLiveFriends() {
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            const liveFriendsGrid = document.getElementById('liveFriendsGrid');
            const liveCountEl = document.getElementById('liveCount');
            const drivingCountEl = document.getElementById('drivingCount');
            
            if (!liveFriendsGrid) return;
            
            liveFriendsGrid.innerHTML = '';
            
            const friends = Object.values(liveData).filter(friend => friend.userId !== currentUser.username);
            const drivingFriends = friends.filter(friend => friend.status === 'driving');
            
            liveCountEl.textContent = friends.length;
            drivingCountEl.textContent = drivingFriends.length;
            
            if (friends.length === 0) {
                liveFriendsGrid.innerHTML = `
                    <div class="no-live-friends" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <div class="no-content-message">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📡</div>
                            <h3 style="color: #f1f5f9; margin-bottom: 0.5rem;">No friends are live sharing</h3>
                            <p style="color: #94a3b8; margin-bottom: 1.5rem;">When your friends start live sharing, you'll see them here!</p>
                            <button class="btn btn-primary" onclick="toggleLiveMode()">Start Live Sharing</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            friends.forEach(friend => {
                const friendCard = createLiveFriendCard(friend);
                liveFriendsGrid.appendChild(friendCard);
            });
            
            // Update live map
            updateLiveMap(friends);
        }
        
        function createLiveFriendCard(friend) {
            const card = document.createElement('div');
            card.className = 'live-friend-card';
            
            const timeSince = Math.floor((Date.now() - friend.timestamp) / 1000);
            const timeString = timeSince < 60 ? `${timeSince}s ago` : `${Math.floor(timeSince / 60)}m ago`;
            
            card.innerHTML = `
                <div class="live-friend-header">
                    <div class="live-friend-name">${friend.userId}</div>
                    <div class="live-friend-status ${friend.status}">${friend.status.toUpperCase()}</div>
                </div>
                <div class="live-friend-info">
                    <div class="live-friend-stat">
                        <div class="live-friend-value">${friend.location.speed ? (friend.location.speed * 0.621371).toFixed(0) : '0'}</div>
                        <div class="live-friend-label">mph</div>
                    </div>
                    <div class="live-friend-stat">
                        <div class="live-friend-value">${timeString}</div>
                        <div class="live-friend-label">Last Update</div>
                    </div>
                </div>
                <div class="live-friend-actions">
                    <button class="btn btn-sm btn-primary" onclick="focusOnFriend('${friend.userId}')">📍 Locate</button>
                    <button class="btn btn-sm btn-secondary" onclick="followFriend('${friend.userId}')">🚗 Follow</button>
                    ${friend.status === 'emergency' ? '<button class="btn btn-sm" style="background: #ef4444;" onclick="respondToEmergency(\'' + friend.userId + '\')">🚨 Emergency</button>' : ''}
                </div>
            `;
            
            return card;
        }
        
        function refreshLiveFriends() {
            // Simulate new data for demo
            generateMockLiveData();
            loadLiveFriends();
            showLiveNotification('Live friends data refreshed', 'success');
        }
        
        function generateMockLiveData() {
            const mockFriends = ['Alex', 'Sarah', 'Mike', 'Emma', 'John'];
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            
            // Add some mock live friends (but not if user hasn't started live mode)
            if (Math.random() > 0.5) {
                mockFriends.slice(0, Math.floor(Math.random() * 3) + 1).forEach(friend => {
                    if (friend !== currentUser.username) {
                        liveData[friend] = {
                            userId: friend,
                            location: {
                                lat: 40.7128 + (Math.random() - 0.5) * 0.1,
                                lng: -74.0060 + (Math.random() - 0.5) * 0.1,
                                speed: Math.random() * 60,
                                accuracy: 10 + Math.random() * 20,
                                timestamp: Date.now()
                            },
                            status: Math.random() > 0.3 ? 'driving' : 'idle',
                            timestamp: Date.now() - Math.random() * 300000, // Within last 5 minutes
                            sharingWith: ['all']
                        };
                    }
                });
                
                localStorage.setItem('liveTrackingData', JSON.stringify(liveData));
            }
        }
        
        function focusOnFriend(friendId) {
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            const friend = liveData[friendId];
            
            if (friend && friend.location) {
                showLiveNotification(`Focused on ${friendId}'s location`, 'success');
                // In a real app, this would center the map on the friend's location
                console.log('Focusing on friend:', friend.location);
            }
        }
        
        function followFriend(friendId) {
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            const friend = liveData[friendId];
            
            if (friend && friend.location) {
                showLiveNotification(`Following ${friendId} - tap to get directions`, 'success');
                // In a real app, this would start navigation to the friend's location
                console.log('Following friend:', friend.location);
                
                // Add XP for social interaction
                addXP(XP_CONFIG.SOCIAL_INTERACTION, `Following ${friendId}`);
            }
        }
        
        function respondToEmergency(friendId) {
            showLiveNotification(`Emergency response initiated for ${friendId}`, 'warning');
            // In a real app, this would call emergency services or send alerts
            console.log('Emergency response for:', friendId);
        }
        
        function updateLiveMap(friends) {
            const liveMap = document.getElementById('liveMap');
            if (!liveMap) return;
            
            if (friends.length === 0) {
                liveMap.innerHTML = '<div style="color: #94a3b8;">No friends to display on map</div>';
                return;
            }
            
            // Simple text-based map for demo
            liveMap.innerHTML = `
                <div style="padding: 2rem; text-align: center;">
                    <h4 style="color: #f1f5f9; margin-bottom: 1rem;">Live Friends Map</h4>
                    <div style="margin: 1rem 0;">
                        ${friends.map(friend => `
                            <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <strong style="color: #f1f5f9;">${friend.userId}</strong> - <span style="color: ${friend.status === 'driving' ? '#22c55e' : '#fbbf24'};">${friend.status}</span>
                                <br>
                                <small style="color: #94a3b8;">Lat: ${friend.location.lat.toFixed(4)}, Lng: ${friend.location.lng.toFixed(4)}</small>
                            </div>
                        `).join('')}
                    </div>
                    <small style="color: #94a3b8;">Interactive map integration available in mobile app</small>
                </div>
            `;
        }
        
        function focusOnFriends() {
            const liveData = JSON.parse(localStorage.getItem('liveTrackingData') || '{}');
            const friends = Object.values(liveData).filter(friend => friend.userId !== currentUser.username);
            
            if (friends.length > 0) {
                updateLiveMap(friends);
                showLiveNotification(`Focused on ${friends.length} friends`, 'success');
            } else {
                showLiveNotification('No friends currently sharing location', 'warning');
            }
        }
        
        function toggleMapMode() {
            showLiveNotification('Map mode toggle - Feature available in mobile app', 'success');
        }

        // Filter routes based on search
        function filterRoutes() {
            const searchTerm = document.getElementById('routeSearchInput').value.toLowerCase();
            const activeTab = document.querySelector('.route-tab.active').textContent.toLowerCase();
            
            let routeCards = [];
            if (activeTab.includes('my routes')) {
                routeCards = document.querySelectorAll('#allRoutes .route-card');
            } else if (activeTab.includes('friends')) {
                routeCards = document.querySelectorAll('#friendsRoutes .route-card');
            } else if (activeTab.includes('public')) {
                routeCards = document.querySelectorAll('#publicRoutes .route-card');
            }
            
            routeCards.forEach(card => {
                const routeName = card.querySelector('.route-name').textContent.toLowerCase();
                const username = card.querySelector('.route-name + div')?.textContent.toLowerCase() || '';
                
                if (routeName.includes(searchTerm) || username.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Show page
        function showPage(pageId) {
            // Prevent multiple rapid clicks
            if (window.isPageTransitioning) {
                console.log('Page transition in progress, ignoring click');
                return;
            }
            
            // Safety fallback - reset transition lock after 2 seconds
            const fallbackTimeout = setTimeout(() => {
                console.log('Page transition fallback triggered');
                window.isPageTransitioning = false;
            }, 2000);
            
            window.isPageTransitioning = true;
            
            try {
                // Update nav links with smooth transition
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    link.style.transition = 'all 0.3s ease';
                });
                
                // Find the clicked nav link and make it active
                const clickedLink = document.querySelector(`[onclick="showPage('${pageId}')"]`);
                if (clickedLink) {
                    clickedLink.classList.add('active');
                }
                
                // Get current and target pages
                const currentPage = document.querySelector('.page:not(.hidden)');
                const targetPage = document.getElementById(pageId);
                
                if (!targetPage) {
                    console.error('Target page not found:', pageId);
                    window.isPageTransitioning = false;
                    clearTimeout(fallbackTimeout);
                    return;
                }
                
                if (currentPage && targetPage && currentPage !== targetPage) {
                    // Add fade out effect to current page
                    currentPage.style.transition = 'opacity 0.2s ease-out';
                    currentPage.style.opacity = '0';
                    
                    // After fade out, switch pages
                    setTimeout(() => {
                        try {
                            // Hide all pages
                            document.querySelectorAll('.page').forEach(page => {
                                page.classList.add('hidden');
                                page.style.opacity = '1'; // Reset opacity
                            });
                            
                            // Show target page with fade in
                            targetPage.classList.remove('hidden');
                            targetPage.style.transition = 'opacity 0.3s ease-in';
                            targetPage.style.opacity = '0';
                            
                            // Trigger fade in
                            setTimeout(() => {
                                targetPage.style.opacity = '1';
                            }, 10);
                            
                            // Load page-specific data with error handling
                            try {
                                loadPageData(pageId);
                            } catch (error) {
                                console.error('Error loading page data:', error);
                            }
                            
                            // Reset transition lock
                            setTimeout(() => {
                                window.isPageTransitioning = false;
                                clearTimeout(fallbackTimeout);
                            }, 300);
                        } catch (error) {
                            console.error('Error in page transition:', error);
                            window.isPageTransitioning = false;
                            clearTimeout(fallbackTimeout);
                        }
                    }, 200);
                } else {
                    // Direct switch if no current page or same page
                    try {
                        document.querySelectorAll('.page').forEach(page => {
                            page.classList.add('hidden');
                        });
                        targetPage.classList.remove('hidden');
                        loadPageData(pageId);
                        window.isPageTransitioning = false;
                        clearTimeout(fallbackTimeout);
                    } catch (error) {
                        console.error('Error in direct page switch:', error);
                        window.isPageTransitioning = false;
                        clearTimeout(fallbackTimeout);
                    }
                }
            } catch (error) {
                console.error('Error in showPage function:', error);
                window.isPageTransitioning = false;
                clearTimeout(fallbackTimeout);
            }
        }
        
        function loadPageData(pageId) {
            // Load page-specific data with smooth loading
            if (pageId === 'routes') {
                loadRoutes();
            } else if (pageId === 'feed') {
                loadFeed();
            } else if (pageId === 'analytics') {
                updateAnalytics();
            } else if (pageId === 'dashboard') {
                // Refresh dashboard data
                updateDashboard();
            } else if (pageId === 'profile') {
                // Load profile data
                loadFriends();
                loadMyPosts();
            }
        }

        function loadRoutes() {
            // Load and display routes
            const routes = JSON.parse(localStorage.getItem('routes') || '[]');
            const allRoutesContainer = document.getElementById('allRoutes');
            
            if (allRoutesContainer) {
                if (routes.length === 0) {
                    allRoutesContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 2rem;">No routes saved yet. Start tracking to create your first route!</p>';
                } else {
                    allRoutesContainer.innerHTML = routes.map(route => `
                        <div class="route-card" data-route-id="${route.id}">
                            <div class="route-header">
                                <h4>${route.name}</h4>
                                <div class="route-actions">
                                    <button class="btn btn-sm" onclick="viewRouteOnMap('${route.id}')">View</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deleteRoute('${route.id}')">Delete</button>
                                </div>
                            </div>
                            <div class="route-stats">
                                <div class="route-stat">
                                    <span class="stat-icon">📏</span>
                                    <span class="stat-value">${route.distance ? route.distance.toFixed(1) : '0'} miles</span>
                                </div>
                                <div class="route-stat">
                                    <span class="stat-icon">⏱️</span>
                                    <span class="stat-value">${route.duration || '0'} min</span>
                                </div>
                                <div class="route-stat">
                                    <span class="stat-icon">🚗</span>
                                    <span class="stat-value">${route.avgSpeed ? route.avgSpeed.toFixed(0) : '0'} mph</span>
                                </div>
                            </div>
                            <div class="route-date">
                                <small>Created: ${new Date(route.timestamp).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        function viewRouteOnMap(routeId) {
            // Switch to dashboard to view route on map
            showPage('dashboard');
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #00bfff, #007bff);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(0, 191, 255, 0.3);
            `;
            notification.textContent = `🗺️ Route loaded on map`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Friends System
        let friends = JSON.parse(localStorage.getItem('friends') || '[]');
        let friendRequests = JSON.parse(localStorage.getItem('friendRequests') || '[]');

        function searchFriends() {
            const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
            if (!searchTerm) {
                loadFriends();
                return;
            }

            const friendsList = document.getElementById('friendsList');
            const allUsers = users.filter(user => user.id !== currentUser.id);
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) || 
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );

            friendsList.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                friendsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 1rem;">No users found</p>';
                return;
            }

            filteredUsers.forEach(user => {
                const isFriend = friends.some(f => f.id === user.id);
                const hasRequest = friendRequests.some(r => r.fromId === user.id || r.toId === user.id);
                
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="friend-details">
                            <h4>${user.name}</h4>
                            <p>@${user.username}</p>
                        </div>
                    </div>
                    <div class="friend-actions">
                        ${isFriend ? 
                            '<span class="status-badge">Friend</span>' : 
                            hasRequest ? 
                                '<span class="status-badge">Request Sent</span>' :
                                `<button class="btn btn-sm" onclick="sendFriendRequest('${user.id}')">Add Friend</button>`
                        }
                    </div>
                `;
                friendsList.appendChild(friendItem);
            });
        }

        function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '';

            if (friends.length === 0) {
                friendsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 1rem;">No friends yet. Search for users to add friends!</p>';
                return;
            }

            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-avatar">${friend.name.charAt(0).toUpperCase()}</div>
                        <div class="friend-details">
                            <h4>${friend.name}</h4>
                            <p>@${friend.username}</p>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <span class="status-badge">Friend</span>
                        <button class="btn btn-sm btn-secondary" onclick="removeFriend('${friend.id}')">Remove</button>
                    </div>
                `;
                friendsList.appendChild(friendItem);
            });
        }

        function sendFriendRequest(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const request = {
                id: Date.now(),
                fromId: currentUser.id,
                toId: userId,
                fromName: currentUser.name,
                toName: user.name,
                timestamp: new Date().toISOString()
            };

            friendRequests.push(request);
            localStorage.setItem('friendRequests', JSON.stringify(friendRequests));

            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #00bfff, #007bff);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                font-weight: 600;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 25px rgba(0, 191, 255, 0.3);
            `;
            notification.textContent = `👥 Friend request sent to ${user.name}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);

            searchFriends(); // Refresh the list
        }

        function removeFriend(friendId) {
            friends = friends.filter(f => f.id !== friendId);
            localStorage.setItem('friends', JSON.stringify(friends));
            loadFriends();
        }

        function loadMyPosts() {
            const myPostsContainer = document.getElementById('myPosts');
            const posts = JSON.parse(localStorage.getItem('posts') || '[]');
            const userPosts = posts.filter(post => post.userId === currentUser.id);

            if (userPosts.length === 0) {
                myPostsContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 2rem;">No posts yet. Share your driving experiences!</p>';
                return;
            }

            myPostsContainer.innerHTML = userPosts.map(post => `
                <div class="feed-post">
                    <div class="post-header">
                        <div class="post-avatar">${currentUser.name.charAt(0).toUpperCase()}</div>
                        <div class="post-info">
                            <div class="post-username">${currentUser.name}</div>
                            <div class="post-time">${new Date(post.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.photos && post.photos.length > 0 ? `
                        <div class="post-photos">
                            ${post.photos.map(photo => `<img src="${photo}" alt="Post photo" class="post-photo">`).join('')}
                        </div>
                    ` : ''}
                    <div class="post-actions">
                        <button class="post-action" onclick="likePost('${post.id}')">
                            👍 ${post.likes || 0}
                        </button>
                        <button class="post-action" onclick="deletePost('${post.id}')">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function viewRoute(routeId) {
            // Switch to routes page and show the specific route
            showPage('routes');
            showRouteTab('friends-routes');
            
            // Highlight the specific route
            setTimeout(() => {
                const routeElement = document.querySelector(`[data-route-id="${routeId}"]`);
                if (routeElement) {
                    routeElement.scrollIntoView({ behavior: 'smooth' });
                    routeElement.style.animation = 'pulse 1s ease-in-out';
                }
            }, 500);
        }
        
        function followFriend(userId) {
            // Switch to live friends tab
            showPage('routes');
            showRouteTab('live-friends');
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            `;
            notification.innerHTML = `🔴 Now following ${userId}'s live drive`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function showXPExplanation() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: linear-gradient(135deg, #1e293b, #334155);
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    border: 2px solid rgba(59, 130, 246, 0.3);
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                    animation: slideInUp 0.3s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #f1f5f9; margin: 0; font-size: 1.5rem;">🎮 XP System Guide</h2>
                        <button onclick="this.closest('.modal').remove()" style="
                            background: rgba(239, 68, 68, 0.2);
                            border: 1px solid rgba(239, 68, 68, 0.3);
                            border-radius: 50%;
                            width: 32px;
                            height: 32px;
                            color: #ef4444;
                            cursor: pointer;
                            font-size: 1.2rem;
                        ">×</button>
                    </div>
                    
                    <div style="color: #cbd5e1; line-height: 1.6;">
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #3b82f6; margin-bottom: 0.5rem;">🏆 How to Earn XP</h3>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                <li><strong>Complete Drives:</strong> +50 XP per drive</li>
                                <li><strong>Distance Bonus:</strong> +1 XP per mile driven</li>
                                <li><strong>Share Photos:</strong> +25 XP per post</li>
                                <li><strong>First Drive:</strong> +100 XP bonus</li>
                                <li><strong>Daily Login:</strong> +10 XP per day</li>
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #10b981; margin-bottom: 0.5rem;">📈 Leveling Up</h3>
                            <p style="margin: 0 0 0.5rem 0;">Each level requires more XP than the last:</p>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                <li><strong>Level 1-5:</strong> 100 XP per level</li>
                                <li><strong>Level 6-10:</strong> 200 XP per level</li>
                                <li><strong>Level 11-20:</strong> 300 XP per level</li>
                                <li><strong>Level 21+:</strong> 500 XP per level</li>
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #f59e0b; margin-bottom: 0.5rem;">🏅 Achievements</h3>
                            <p style="margin: 0 0 0.5rem 0;">Unlock special achievements for:</p>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                <li><strong>Speed Demon:</strong> Drive over 100 mph</li>
                                <li><strong>Road Warrior:</strong> Complete 100 drives</li>
                                <li><strong>Social Butterfly:</strong> Share 50 photos</li>
                                <li><strong>Explorer:</strong> Drive 1000+ miles</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <p style="margin: 0; font-weight: 500; color: #3b82f6;">
                                💡 <strong>Pro Tip:</strong> The more you drive and share, the faster you'll level up! 
                                Check your progress in the Analytics page for detailed stats.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
</body>
</html>